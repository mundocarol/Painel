<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Controle - Vers√£o Final Ajustada</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <style type="text/css">
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Roboto', Arial, sans-serif; 
            padding: 10px; 
            background-color: #f8f9fa;
            color: #333;
        }
        
        /* ALERTA DE PEDIDOS ATRASADOS - AMARELO MAIS FORTE */
        .late-alert {
            display: none;
            background-color: #FFEB3B; /* AMARELO BEM FORTE */
            border: 3px solid #FF9800;
            border-radius: 6px;
            padding: 12px 15px;
            margin-bottom: 15px;
            text-align: center;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
        }
        
        .late-alert h3 {
            color: #D84315; /* LARANJA ESCURO PARA CONTRASTE */
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        
        .late-alert .late-count {
            background-color: #D84315;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 152, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }
        
        /* HEADER COMPACTO */
        .header-container {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* BARRA DE BUSCA */
        .search-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .search-input {
            padding: 6px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            font-size: 12px;
            width: 200px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }
        
        .search-input::placeholder {
            color: #666;
        }
        
        .btn-search {
            padding: 6px 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        
        .btn-search:hover {
            background-color: #1976D2;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-height: 30px;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        
        /* BOT√ÉO ATUALIZAR COM LOADING */
        .btn-refresh {
            background-color: #00BCD4;
            color: white;
            min-width: 100px;
            position: relative;
        }
        
        .btn-refresh .refresh-text {
            position: relative;
            z-index: 2;
        }
        
        .btn-refresh .refresh-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            width: 0%;
            transition: width 0.3s linear;
            z-index: 1;
        }
        
        .btn-refresh:hover {
            background-color: #0097A7;
        }
        
        /* CORES DOS BOT√ïES */
        .btn-default { background-color: #2E7D32; color: white; }
        .btn-default:hover { background-color: #1B5E20; }
        .btn-completed { background-color: #757575; color: white; }
        .btn-completed:hover { background-color: #616161; }
        .btn-primary { background-color: #2196F3; color: white; }
        .btn-primary:hover { background-color: #1976D2; }
        .btn-success { background-color: #4CAF50; color: white; }
        .btn-success:hover { background-color: #388E3C; }
        .btn-warning { background-color: #FF9800; color: white; }
        .btn-warning:hover { background-color: #F57C00; }
        .btn-danger { background-color: #F44336; color: white; }
        .btn-danger:hover { background-color: #D32F2F; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-purple { background-color: #9C27B0; color: white; }
        .btn-purple:hover { background-color: #7B1FA2; }
        .btn-gray { background-color: #757575; color: white; }
        .btn-gray:hover { background-color: #616161; }
        .btn-orange { 
            background-color: #FF5722; 
            color: white; 
            position: relative;
            padding-right: 12px;
        }
        
        .btn-orange:hover { background-color: #E64A19; }
        .btn-formulario { background-color: #673AB7; color: white; }
        .btn-formulario:hover { background-color: #512DA8; }
        
        /* BADGE PARA CONTADOR DE SEM IMPRIMIR - CORRIGIDO PARA FICAR AO LADO */
        .unprinted-badge {
            background: #000000;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            border: 2px solid white;
            margin-left: 8px;
            margin-right: -5px;
            position: relative;
            top: -1px;
        }
        
        .stats {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        input[type="date"] {
            padding: 6px 8px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            font-size: 12px;
            width: 120px;
            background: rgba(255,255,255,0.9);
        }
        
        /* CARDS DE EVENTOS - 5 POR LINHA */
        .event-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        @media (min-width: 1600px) {
            .event-container {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        @media (min-width: 1300px) and (max-width: 1599px) {
            .event-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (min-width: 1000px) and (max-width: 1299px) {
            .event-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 700px) and (max-width: 999px) {
            .event-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 699px) {
            .event-container {
                grid-template-columns: 1fr;
            }
        }
        
        .event-card {
            background: white;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 180px;
            border: 1px solid #e0e0e0;
            height: 100%;
        }
        
        .event-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.12);
            border-color: #2196F3;
        }
        
        .event-card.unprinted {
            border-color: #E65100;
            background: #FFE0B2;
            border-width: 2px;
        }
        
        .event-card.completed {
            background: #C8E6C9;
            border-color: #388E3C;
            border-width: 2px;
        }
        
        .event-card.finalized {
            background: #e0e0e0 !important; /* CINZA MAIS ESCURO */
            border-color: #9e9e9e;
            color: #616161 !important;
        }
        
        /* ESTILO PARA PEDIDOS DE OUTRA CIDADE - LARANJA (antes da impress√£o) e AMARELO (ap√≥s impress√£o) */
        .event-card.outra-cidade {
            background: #FFE0B2 !important; /* LARANJA (igual aos outros n√£o impressos) */
            border-color: #FF5722 !important;
            border-width: 3px !important;
            box-shadow: 0 2px 8px rgba(255, 87, 34, 0.3) !important;
        }
        
        .event-card.outra-cidade.impresso {
            background: #FFF9C4 !important; /* AMARELO (ap√≥s impress√£o) */
            border-color: #FFD600 !important;
            box-shadow: 0 2px 8px rgba(255, 213, 0, 0.3) !important;
        }
        
        .event-card.outra-cidade:hover {
            box-shadow: 0 4px 12px rgba(255, 87, 34, 0.4) !important;
            border-color: #FF9800 !important;
        }
        
        .event-card.outra-cidade.impresso:hover {
            box-shadow: 0 4px 12px rgba(255, 213, 0, 0.4) !important;
            border-color: #FFC107 !important;
        }
        
        .event-card.outra-cidade.finalized {
            background: #e0e0e0 !important;
            border-color: #9e9e9e !important;
            box-shadow: 0 1px 5px rgba(0,0,0,0.08) !important;
        }
        
        .event-card.finalized .delivery-info,
        .event-card.finalized .client-name,
        .event-card.finalized .product-name,
        .event-card.finalized .address-info,
        .event-card.finalized .seller-info,
        .event-card.finalized .total-info,
        .event-card.finalized .line-number {
            color: #616161 !important;
        }
        
        .event-card.finalized .btn {
            opacity: 0.6;
            background-color: #bdbdbd !important;
            color: #616161 !important;
        }
        
        .event-card.finalized .btn:hover {
            opacity: 0.8;
            background-color: #9e9e9e !important;
        }
        
        .order-number {
            background: #F44336;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            position: absolute;
            top: -8px;
            right: -8px;
            border: 2px solid white;
            z-index: 2;
        }
        
        .event-header {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .delivery-info {
            font-size: 14px;
            font-weight: 700;
            color: #2196F3;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }
        
        .event-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .client-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            margin-bottom: 3px;
            flex-wrap: wrap;
        }
        
        .client-info-left {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .client-info-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .client-label {
            font-size: 10px;
            color: #666;
            font-weight: 500;
        }
        
        .client-name {
            font-size: 13px;
            color: #333;
            font-weight: 600;
        }
        
        .payment-info {
            font-size: 11px;
            color: #333;
            background-color: #f0f0f0;
            padding: 1px 5px;
            border-radius: 3px;
            font-weight: 500;
        }
        
        /* N√öMERO DO PEDIDO E CUPOM - LADO A LADO */
        .order-details {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 3px;
            flex-wrap: wrap;
        }
        
        .order-id {
            font-size: 10px;
            color: #666;
            font-weight: 600;
        }
        
        .cupom-info {
            font-size: 10px;
            color: #9C27B0;
            font-style: italic;
            font-weight: 600;
        }
        
        .anonimo-badge {
            background: #F44336;
            color: white;
            font-size: 9px;
            padding: 1px 5px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        /* NOME DO PRODUTO COM LIMITE DE 2 LINHAS */
        .product-name {
            font-size: 16px;
            color: #2E7D32;
            font-weight: 700;
            margin: 2px 0;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.6em;
            max-height: 3.2em;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }
        
        .address-info {
            flex: 2;
            font-size: 12px;
            color: #666;
            line-height: 1.3;
        }
        
        .seller-info {
            flex: 1;
            text-align: right;
            font-size: 11px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .total-info {
            font-size: 14px;
            font-weight: bold;
            color: #2E7D32;
            margin-top: 2px;
        }
        
        .event-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 8px;
            border-top: 1px solid rgba(0,0,0,0.1);
            position: relative;
        }
        
        .action-buttons { 
            display: flex; 
            gap: 4px; 
            flex-wrap: wrap;
            justify-content: flex-start;
            flex: 1;
        }
        
        .edit-button-container {
            position: absolute;
            right: 0;
            bottom: 8px;
        }
        
        .edit-btn {
            background: none;
            border: none;
            color: #757575;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .edit-btn:hover {
            background-color: #f0f0f0;
            color: #2196F3;
            transform: scale(1.1);
        }
        
        .btn-small { 
            padding: 4px 6px; 
            font-size: 10px; 
            min-height: 26px; 
            border-radius: 3px;
            min-width: 50px;
        }
        
        .disabled {
            opacity: 0.5;
            cursor: not-allowed !important;
        }
        
        /* MODAIS */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 1100px;
            max-height: 90vh;
            overflow: hidden;
            animation: slideIn 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 15px;
            max-height: calc(90vh - 60px);
            overflow-y: auto;
        }
        
        /* IMPRESS√ÉO A4 - COM MARGENS MAIORES */
        .a4-page {
            width: 210mm !important;
            height: 297mm !important;
            padding: 15mm 15mm 15mm 15mm !important;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            page-break-inside: avoid;
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .a4-top {
            flex-shrink: 0;
            padding-bottom: 1mm;
            height: auto;
        }
        
        .a4-bottom {
            flex-shrink: 0;
            padding-top: 1mm;
            margin-top: 0;
            height: auto;
        }
        
        .a4-middle {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0 !important;
            overflow: hidden;
            margin: 0;
            min-height: 30mm;
            height: auto;
        }
        
        .a4-page table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 12px !important;
            margin-bottom: 0;
            table-layout: fixed;
        }
        
        .a4-page th, .a4-page td { 
            border: 1px solid #000; 
            padding: 4px !important;
            text-align: left; 
            vertical-align: top;
            overflow: hidden;
            word-wrap: break-word;
        }
        
        .a4-page .bg-gray { 
            background-color: #f5f5f5; 
            font-weight: bold; 
            width: 25%;
        }
        
        /* ESTILOS ESPEC√çFICOS COM TAMANHOS MAIORES */
        .a4-page .delivery-day {
            font-weight: bold;
            font-size: 16px !important;
            color: #000;
            background-color: #fff3cd !important;
        }
        
        .a4-page .delivery-time {
            font-weight: bold;
            font-size: 16px !important;
            text-align: center;
            color: #000;
            background-color: #fff3cd !important;
        }
        
        .a4-page .product-description-large {
            font-size: 16px !important;
            font-weight: bold;
            background-color: #d4edda !important;
            padding: 6px !important;
            color: #000;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal !important;
            word-break: break-word;
        }
        
        .message-text-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow: hidden;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        .message-text {
            font-family: 'Dancing Script', cursive !important;
            color: #000000 !important;
            line-height: 1.2 !important;
            width: 100% !important;
            word-wrap: break-word !important;
            overflow: hidden !important;
            text-align: center !important;
            overflow-wrap: break-word !important;
            word-break: break-word !important;
            white-space: pre-line !important;
            padding: 0 !important;
            margin: 0 !important;
            display: block !important;
        }
        
        .recipient-highlight {
            font-family: 'Dancing Script', cursive;
            font-size: 22px !important;
            margin-bottom: 3px !important;
            display: block;
            text-align: left;
            position: relative;
            padding-right: 120px;
        }
        
        /* CONTROLES DE TAMANHO DO TEXTO */
        .text-size-controls {
            position: absolute;
            right: -5px;
            top: 0;
            display: flex;
            gap: 2px;
            flex-wrap: nowrap;
            width: 120px;
            justify-content: flex-end;
        }
        
        .text-size-btn {
            width: 26px;
            height: 26px;
            border-radius: 3px;
            background: #4CAF50;
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .text-size-btn:hover {
            opacity: 1;
            background: #2E7D32;
            transform: scale(1.1);
        }
        
        .copy-btn {
            width: 26px;
            height: 26px;
            border-radius: 3px;
            background: #2196F3;
            color: white;
            border: none;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
            transition: all 0.2s;
            margin-right: 2px;
            flex-shrink: 0;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: #1976D2;
            transform: scale(1.1);
        }
        
        /* NOVO: JUSTIFICATIVA AN√îNIMO FORA DA FICHA */
        .anonimo-justificativa-print {
            font-size: 12px !important;
            color: #666 !important;
            text-align: center !important;
            margin-top: 2px !important;
            font-style: italic !important;
            padding: 2px 0 !important;
            border-top: 0.3px dashed #ccc !important;
            line-height: 1 !important;
            max-height: 12px !important;
            overflow: hidden !important;
            background-color: transparent !important;
            position: relative;
            width: 100%;
        }
        
        /* CONTROLES DE IMPRESS√ÉO */
        .print-controls {
            background: #f8f9fa;
            padding: 10px 12px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        /* ESTILOS PARA LISTA DE ITENS (BOT√ÉO 2) - MODAL MAIS ALTO */
        .items-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .items-input-container {
            margin-bottom: 20px;
        }
        
        .items-input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .items-textarea {
            width: 100%;
            min-height: 400px;
            max-height: 60vh;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            resize: vertical;
            line-height: 1.5;
            overflow-y: auto;
        }
        
        .items-count {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: right;
            font-weight: bold;
        }
        
        .items-count.warning {
            color: #f57c00;
        }
        
        .items-count.error {
            color: #f44336;
        }
        
        /* P√ÅGINA DE IMPRESS√ÉO DOS ITENS (BOT√ÉO 2) - CORRIGIDO: UMA FOLHA COM LISTA NO TOPO E NO RODAP√â */
        .a4-items-page {
            width: 210mm !important;
            height: 297mm !important;
            padding: 5mm 15mm 0mm 15mm !important;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            page-break-inside: avoid;
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .items-top-section {
            height: 45%;
            overflow: hidden;
            margin-bottom: 5mm;
        }
        
        .items-bottom-section {
            height: 45%;
            overflow: hidden;
            margin-top: 150mm;
        }
        
        .items-multicolumn-container {
            display: flex;
            gap: 5mm;
            height: 100%;
            width: 100%;
        }
        
        .items-column-print {
            flex: 1;
            padding: 3mm;
            height: 100%;
            display: flex;
            flex-direction: column;
            width: 33.33%;
            overflow: hidden;
            border: 1px solid #ccc;
            border-radius: 2mm;
        }
        
        .items-column-content-print {
            flex: 1;
            font-size: 9.5px;
            line-height: 1.1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .items-list-print {
            flex: 1;
            margin: 0;
            padding: 0;
            list-style-type: none;
            overflow: hidden;
            width: 100%;
        }
        
        .items-list-print li {
            padding: 1mm 0;
            border-bottom: 0.2mm dashed #ccc;
            page-break-inside: avoid;
            break-inside: avoid;
            font-size: 9.5px !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .items-list-print li:last-child {
            border-bottom: none;
        }
        
        .items-borderless-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .items-borderless-table td {
            border: none !important;
            padding: 0 !important;
            vertical-align: top;
        }
        
        /* MODAL DE C√ìDIGO COM NOME DO CONFERENTE */
        .code-with-name-modal {
            background: white !important;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .code-name-input {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            background: white;
        }
        
        .time-input {
            width: 60px;
            padding: 8px;
            font-size: 14px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            background-color: #fff8e1;
        }
        
        .time-input:focus {
            background-color: #fff3cd;
            border-color: #ff9800;
        }
        
        /* MODAL DE CONFIRMA√á√ÉO PARA MONTADOR/ENTREGADOR */
        .confirmation-modal {
            background: white !important;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        /* MODAL DE EDI√á√ÉO - COM AJUSTES SOLICITADOS */
        .edit-modal-content {
            background: white;
            border-radius: 8px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            animation: slideIn 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .edit-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .edit-form-container {
            padding: 20px;
        }
        
        .edit-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group-full-width {
            grid-column: 1 / -1;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: #333;
        }
        
        .form-input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-family: 'Roboto', sans-serif;
            width: 100%;
        }
        
        .form-select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-family: 'Roboto', sans-serif;
            width: 100%;
            background: white;
            cursor: pointer;
        }
        
        .form-select:focus {
            border-color: #2196F3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }
        
        .form-input:focus {
            border-color: #2196F3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }
        
        .form-textarea {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-family: 'Roboto', sans-serif;
            width: 100%;
            min-height: 100px;
            resize: vertical;
        }
        
        .form-textarea-large {
            min-height: 150px;
        }
        
        .auth-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .auth-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        /* BOT√ÉO DE CANCELAR PEDIDO DENTRO DO MODAL DE EDI√á√ÉO */
        .cancel-section {
            background: #fff8f8;
            border: 2px solid #ffcdd2;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }
        
        .cancel-section.active {
            display: block;
        }
        
        .cancel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #d32f2f;
        }
        
        .cancel-reason-select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ffcdd2;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 10px;
            background: white;
        }
        
        .cancel-warning {
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #d32f2f;
            margin-top: 10px;
            border-left: 3px solid #f44336;
        }
        
        /* OUTROS COMPONENTES */
        .status-notification {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none;
            animation: slideInRight 0.3s ease;
            max-width: 300px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 4px solid #2196F3;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .code-display {
            font-family: 'Courier New', monospace;
            font-size: 28px;
            font-weight: bold;
            letter-spacing: 3px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 5px;
            margin: 12px 0;
            border: 2px dashed #2196F3;
        }
        
        .conferente-info {
            background: #e8f5e9;
            padding: 8px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 13px;
            color: #2E7D32;
        }
        
        @media print {
            /* CORRE√á√ÉO CR√çTICA: N√ÉO USAR display: none */
            body * { 
                visibility: hidden !important; 
            }
            
            /* MOSTRAR APENAS AS P√ÅGINAS A4 */
            .a4-page, .a4-page *, 
            .a4-items-page, .a4-items-page * { 
                visibility: visible !important; 
            }
            
            /* POSICIONAMENTO ABSOLUTO PARA EVITAR QUEBRAS */
            .a4-page, .a4-items-page {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                margin: 0 !important;
                width: 210mm !important;
                height: 297mm !important;
                page-break-before: avoid !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
            }
            
            /* REMOVER MARGENS DO @page */
            @page {
                margin: 0 !important;
                size: A4;
            }
            
            /* REMANEJAR O RESTO DO CSS EXISTENTE (mantenha tudo que j√° tinha) */
            .text-size-controls, .copy-btn {
                display: none !important;
            }
            
            .items-column-print {
                border: none !important;
                width: 33.33% !important;
            }
            
            .items-list-print li {
                border-bottom: 0.2mm dashed #ccc !important;
                font-size: 9.5px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                max-width: 100% !important;
            }
            
            .anonimo-justificativa-print {
                font-size: 6px !important;
                margin-top: 1px !important;
                padding: 1px 0 !important;
                border-top: 0.2px dashed #ccc !important;
                line-height: 1 !important;
                max-height: 8px !important;
            }
            
            .message-text {
                line-height: 1.1 !important;
            }
            
            .recipient-highlight {
                font-size: 20px !important;
                margin-bottom: 2px !important;
            }
            
            .a4-page .delivery-day,
            .a4-page .delivery-time {
                font-size: 15px !important;
            }
            
            .a4-page .product-description-large {
                font-size: 15px !important;
            }
        }
        
        /* NOVO: ESTILO PARA N√öMERO DO PEDIDO NA IMPRESS√ÉO */
        .order-number-print {
            font-size: 12px !important;
            font-weight: bold;
            color: #000;
            text-align: right;
            margin-left: 5px;
        }
        
        /* N√öMERO DO PEDIDO NO PAINEL - ABAIXO DO TOTAL */
        .order-number-panel {
            font-size: 10px !important;
            color: #9C27B0 !important;
            font-weight: bold;
            margin-top: 3px !important;
            display: block;
            text-align: right;
        }
        
        /* ESTILO PARA ENDERE√áO EM BRANCO */
        .address-retirada {
            font-weight: bold !important;
            color: #D32F2F !important;
            font-size: 20px !important;
            text-transform: uppercase;
        }
        
        /* ESTILO PARA PEDIDOS DE OUTRA CIDADE */
        .outra-cidade-badge {
            background-color: #FFD600;
            color: #000;
            font-size: 9px;
            padding: 1px 5px;
            border-radius: 8px;
            font-weight: bold;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <!-- NOTIFICA√á√ïES -->
    <div class="status-notification" id="statusNotification"></div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Processando...</div>
    </div>

    <!-- ALERTA DE PEDIDOS ATRASADOS - AMARELO FORTE -->
    <div class="late-alert" id="lateAlert">
        <h3>‚ö†Ô∏è ATEN√á√ÉO - PEDIDOS ATRASADOS <span class="late-count" id="lateCount">0</span></h3>
    </div>

    <!-- HEADER COMPACTO COM BOT√ÉO FORMUL√ÅRIO -->
    <div class="header-container">
        <div class="header-left">
            <h1 class="header-title">üìä Painel Controle</h1>
            <div class="header-controls">
                <button class="btn btn-primary" onclick="filterToday()">Hoje</button>
                <button class="btn btn-primary" onclick="filterTomorrow()">Amanh√£</button>
                <button class="btn btn-primary" onclick="filterNextSunday()">Domingo</button>
                <button class="btn btn-orange" onclick="filterUnprinted()">
                    üñ®Ô∏è Sem Imprimir <span class="unprinted-badge" id="unprintedCountBadge">0</span>
                </button>
                <input id="datePicker" onchange="filterByDate(this.value)" type="date" />
                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="Buscar pedido..." onkeyup="if(event.keyCode===13) performSearch()">
                    <button class="btn-search" onclick="performSearch()">üîç Buscar</button>
                </div>
                <button class="btn btn-refresh" onclick="refreshData()" id="refreshButton">
                    <span class="refresh-text">üîÑ Atualizar</span>
                    <div class="refresh-progress" id="refreshProgress"></div>
                </button>
            </div>
        </div>
        <div class="header-right">
            <!-- BOT√ÉO FORMUL√ÅRIO -->
            <button class="btn btn-formulario" onclick="window.open('https://mundocarol.github.io/agendamento/', '_blank')">
                üìù FORMUL√ÅRIO
            </button>
            <div class="stats"><span id="eventCount">0</span> pedidos</div>
        </div>
    </div>

    <!-- LISTA DE EVENTOS -->
    <div class="event-container" id="eventList"></div>

    <!-- Modal de impress√£o (P√°gina 1) -->
    <div class="modal-overlay" id="printModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÑ Ficha de Entrega</h2>
                <button class="modal-close" onclick="closePrintModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="print-controls">
                    <div>
                        <strong id="printModalTitle">Ficha - Linha 0</strong>
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">
                            Ajuste o tamanho do texto para caber em 1 p√°gina A4 (m√°x. 80px)
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="requestPrintCode()">üñ®Ô∏è Imprimir</button>
                        <button class="btn btn-secondary" onclick="closePrintModal()">‚ùå Fechar</button>
                    </div>
                </div>
                <div id="printContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal para itens (Bot√£o 2) - CORRIGIDO: AGORA IMPRIME APENAS UMA FOLHA -->
    <div class="modal-overlay" id="itemsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Lista de Itens - Linha <span id="itemsRowNumber">0</span></h2>
                <button class="modal-close" onclick="closeItemsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="print-controls">
                    <div>
                        <strong>Lista de Itens - Linha <span id="itemsRowNumberDisplay">0</span></strong>
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">
                            Digite os itens da cesta (m√°ximo 30 linhas totais - 3 colunas de 10 linhas)
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-success" id="saveItemsBtn" onclick="saveAndPrintItems()">üíæ Salvar & Imprimir</button>
                        <button class="btn btn-secondary" onclick="closeItemsModal()">‚ùå Fechar</button>
                    </div>
                </div>
                <div class="items-container">
                    <div class="items-input-container">
                        <label class="items-input-label" for="itemsTextarea">
                            Digite os itens que comp√µem este pedido (um por linha):
                        </label>
                        <textarea class="items-textarea" id="itemsTextarea" placeholder="Digite cada item em uma linha nova...
Exemplo:
1 Suco caixinha tial sabores (330ml)
1 Achocolatado Danete/Itamb√© caixinha
1 Whey Itamb√© 250ml (sem a√ßucar e lactose)" oninput="validateItemsCount()"></textarea>
                        <div class="items-count" id="itemsCount">Linhas: 0/30</div>
                        <div style="margin-top: 8px; font-size: 11px; color: #666;">
                            <strong>Configura√ß√£o fixa:</strong> 3 colunas | M√°ximo 10 linhas por coluna (30 linhas totais) | Distribui√ß√£o autom√°tica
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                        <button class="btn btn-success" id="saveItemsBtnBottom" onclick="saveAndPrintItems()">üíæ Salvar & Imprimir</button>
                    </div>
                </div>
                <div id="printItemsContent" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Modal de c√≥digo de impress√£o COM NOME DO CONFERENTE -->
    <div class="modal-overlay" id="codeModal">
        <div class="code-with-name-modal">
            <h2 style="margin-bottom: 10px; color: #333;">üîí Confirma√ß√£o de Impress√£o</h2>
            <div id="conferenteExistente" style="display: none;">
                <div class="conferente-info">
                    <strong>Conferente anterior:</strong> <span id="nomeConferenteExistente"></span>
                </div>
                <p style="color: #666; margin: 10px 0;">
                    Esta ficha j√° foi impressa anteriormente. O nome do conferente n√£o pode ser alterado.
                </p>
                <div style="margin-top: 15px; display: flex; gap: 8px; justify-content: center;">
                    <button class="btn btn-secondary" onclick="closeCodeModal()">Cancelar</button>
                    <button class="btn btn-success" onclick="verifyExistingPrintCode()">‚úÖ Confirmar Impress√£o</button>
                </div>
            </div>
            <div id="conferenteNovo">
                <p style="color: #666; margin-bottom: 12px;">Digite o c√≥digo abaixo e seu nome:</p>
                <div class="code-display" id="codeDisplay">0000</div>
                <div style="margin: 15px 0;">
                    <label style="display: block; text-align: left; margin-bottom: 5px; font-size: 14px; color: #333;">
                        C√≥digo de 4 d√≠gitos:
                    </label>
                    <input autocomplete="off" class="code-name-input" id="codeInput" maxlength="4" placeholder="Digite o c√≥digo acima" type="text" />
                </div>
                <div style="margin: 15px 0;">
                    <label style="display: block; text-align: left; margin-bottom: 5px; font-size: 14px; color: #333;">
                        Nome de quem conferiu o pagamento:
                    </label>
                    <input autocomplete="off" class="code-name-input" id="conferenteName" placeholder="Seu nome completo" type="text" />
                </div>
                <div style="margin-top: 20px; display: flex; gap: 8px; justify-content: center;">
                    <button class="btn btn-secondary" onclick="closeCodeModal()">Cancelar</button>
                    <button class="btn btn-success" onclick="verifyPrintCode()">‚úÖ Confirmar Impress√£o</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirma√ß√£o para montador/entregador -->
    <div class="modal-overlay" id="confirmationModal">
        <div class="confirmation-modal">
            <h2 id="confirmationTitle" style="margin-bottom: 10px;">Confirmar A√ß√£o</h2>
            <p id="confirmationMessage" style="color: #666; margin-bottom: 12px;">Digite seu nome para confirmar:</p>
            <div id="timeInputContainer" style="display: none; margin: 10px 0;">
                <label style="display: block; text-align: left; margin-bottom: 5px; font-size: 14px; color: #333;">
                    Hor√°rio (HH:MM) <span style="color: #ff5722;">*OBRIGAT√ìRIO*</span>:
                </label>
                <div style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                    <input class="time-input" id="timeInput" maxlength="2" oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="HH" style="width: 40px;" type="text" />
                    :
                    <input class="time-input" id="minuteInput" maxlength="2" oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="MM" style="width: 40px;" type="text" />
                </div>
                <div style="font-size: 11px; color: #666; margin-top: 3px; text-align: center;">
                    Exemplo: 09:30 para 9h30
                </div>
            </div>
            <input class="code-name-input" id="completerName" placeholder="Seu nome completo" style="width: 100%; padding: 8px; font-size: 14px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;" type="text" />
            <div style="margin-top: 15px; display: flex; gap: 8px; justify-content: center;">
                <button class="btn btn-secondary" onclick="cancelCompletion()">Cancelar</button>
                <button class="btn btn-success" onclick="confirmCompletion()">‚úÖ Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de edi√ß√£o -->
    <div class="edit-modal-overlay" id="editModal">
        <div class="edit-modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Editar Pedido - N¬∫ <span id="editOrderNumber">0</span></h2>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="edit-form-container">
                    <div class="auth-container">
                        <h3 style="margin-bottom: 15px; color: #333;">Autentica√ß√£o</h3>
                        <div class="auth-fields">
                            <div class="form-group">
                                <label class="form-label">Selecione seu nome:</label>
                                <select class="form-select" id="editUserName" onchange="focusPasswordField()">
                                    <option value="">Selecione...</option>
                                    <option value="Anna">Anna</option>
                                    <option value="Felipe">Felipe</option>
                                    <option value="Bianca">Bianca</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Senha:</label>
                                <input class="form-input" id="editUserPassword" placeholder="Digite sua senha" type="password" />
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #666;">
                            <strong>Acesso autorizado:</strong> Anna, Felipe, Bianca
                        </div>
                    </div>
                    
                    <!-- SE√á√ÉO DE CANCELAMENTO DE PEDIDO -->
                    <div class="cancel-section" id="cancelSection">
                        <div class="cancel-header">
                            <span style="font-size: 20px;">‚ùå</span>
                            <h3 style="margin: 0; color: #d32f2f;">Cancelar Pedido</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Motivo do cancelamento:</label>
                            <select class="cancel-reason-select" id="cancelReasonSelect">
                                <option value="">Selecione o motivo...</option>
                                <option value="Cancelado - Cliente solicitou cancelamento">Cancelado - Cliente solicitou cancelamento</option>
                                <option value="Golpe - Identificado como tentativa de golpe">Golpe - Identificado como tentativa de golpe</option>
                                <option value="Outros - Outros motivos">Outros - Outros motivos</option>
                            </select>
                        </div>
                        <div class="cancel-warning">
                            <strong>ATEN√á√ÉO:</strong> Ao cancelar, os valores do produto e frete ser√£o zerados, e o vendedor e entregador ser√£o substitu√≠dos pelo motivo do cancelamento.
                        </div>
                    </div>
                    
                    <div class="edit-form-grid" id="editFormFields">
                        <!-- Campos ser√£o preenchidos dinamicamente -->
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: space-between; margin-top: 20px;">
                        <button class="btn btn-danger" onclick="toggleCancelSection()" id="cancelPedidoBtn">‚ùå Cancelar Pedido</button>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
                            <button class="btn btn-success" onclick="saveEdits()">üíæ Salvar Altera√ß√µes</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ïES
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby4KR-tUMGiO8r6W5g2YTuqsOAAhP7SFqv4UznPAC8JJx9dQlQ9gzpB0pq3hpnxE-Qt/exec';
        const SHEET_ID = '1zsIUvR7eHuk3A0rgjnKBv1niPPKTrdF9FW31onlevgA';
        const RANGE = 'Respostas ao formul√°rio 2!A:BE'; // Expandido para incluir colunas BD e BE (edi√ß√µes)
        const API_KEY = 'AIzaSyAtHI0KGE9dWSQIQQtQLS95i3kuLTD0bSM';

        // Configura√ß√£o de usu√°rios autorizados
        const AUTHORIZED_USERS = {
            'Anna': 'Adm123',
            'Felipe': 'Adm456',
            'Bianca': 'Adm789'
        };

        // Vari√°veis globais
        let allEvents = [];
        let currentFilter = 'today';
        let currentRowNumber = null;
        let currentPrintEventData = null;
        let currentActionType = '';
        let generatedPrintCode = '';
        let currentItemsText = '';
        let itemsCache = {};
        let existingConferenteName = '';
        let currentEventDataForEdit = null;
        let refreshInterval = null;
        let autoRefreshTime = 120000; // 2 minutos
        let refreshProgress = 0;
        let alertCheckInterval = null;
        const ALERT_INTERVAL = 300000; // 5 minutos em milissegundos
        let audioContext = null;
        let alertSoundInterval = null;
        let isAlertPlaying = false;
        let alertStartTime = 0;
        const ALERT_DURATION = 10000; // 10 segundos
        let lastAlertTime = 0;
        let lastEventCount = 0;
        let isCancelMode = false; // Novo: controla se est√° no modo cancelamento
        let currentRowIdCache = {}; // Cache para mapear ID do pedido para linha atual
        
        // CONFIGURA√á√ÉO DE FONTES
        const fontSettings = {
            comprador: 14,
            telefone: 14,
            cartao: 14,
            vendedor: 14,
            endereco: 14,
            bairro: 14,
            cidade: 14,
            referencia: 12,
            dia_entrega: 16,
            horario_entrega: 16,
            recebedor: 14,
            colunaJ: 14,
            produto: 16,
            produto_valor: 12,
            frete: 12,
            total: 16,
            forma_pagamento: 14,
            codigo: 20,
            cartao_texto: 20,
            nome_presenteado: 22
        };
        
        // Vari√°veis para controle de tamanho do texto do cart√£o
        let currentFontSize = 20;
        let currentRecipientFontSize = 22;
        const MAX_FONT_SIZE = 80;
        
        // ============= FUN√á√ÉO CORRIGIDA PARA IMPRESS√ÉO ISOLADA =============
function printIsolatedContent(htmlContent) {
    return new Promise((resolve) => {
        const iframe = document.createElement('iframe');
        iframe.style.position = 'absolute';
        iframe.style.width = '0';
        iframe.style.height = '0';
        iframe.style.border = 'none';
        iframe.style.visibility = 'hidden';
        document.body.appendChild(iframe);
        
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        
        // Coletar todos os estilos da p√°gina principal
        const styles = Array.from(document.querySelectorAll('style'))
            .map(style => style.innerHTML)
            .join('\n');
        
        // Coletar estilos de links
        const styleLinks = Array.from(document.querySelectorAll('link[rel="stylesheet"]'))
            .map(link => `<link rel="stylesheet" href="${link.href}">`)
            .join('\n');
        
        iframeDoc.open();
        iframeDoc.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Impress√£o</title>
                ${styleLinks}
                <style>
                    ${styles}
                    
                    /* Estilos espec√≠ficos para impress√£o no iframe */
                    body {
                        margin: 0;
                        padding: 0;
                        background: white;
                    }
                    
                    @media print {
                        body * {
                            visibility: visible !important;
                        }
                        
                        .a4-page, .a4-items-page {
                            position: relative !important;
                            top: 0 !important;
                            left: 0 !important;
                            margin: 0 auto !important;
                            width: 210mm !important;
                            height: 297mm !important;
                            page-break-before: avoid !important;
                            page-break-after: avoid !important;
                            page-break-inside: avoid !important;
                        }
                        
                        @page {
                            margin: 0 !important;
                            size: A4;
                        }
                        
                        .text-size-controls, .copy-btn {
                            display: none !important;
                        }
                    }
                </style>
            </head>
            <body>
                ${htmlContent}
            </body>
            </html>
        `);
        iframeDoc.close();
        
        // VARI√ÅVEL PARA CONTROLAR SE J√Å IMPRIMIU
        let hasPrinted = false;
        
        function executePrint() {
            // SE J√Å IMPRIMIU, N√ÉO IMPRIME DE NOVO
            if (hasPrinted) return;
            hasPrinted = true;
            
            try {
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
            } catch (error) {
                console.log("Erro na impress√£o:", error);
            }
            
            // Remover iframe ap√≥s impress√£o (apenas uma vez)
            setTimeout(() => {
                if (document.body.contains(iframe)) {
                    document.body.removeChild(iframe);
                }
                resolve();
            }, 1500);
        }
        
        // USAR APENAS UM M√âTODO - ESCOLHEMOS onload
        iframe.onload = function() {
            // Aguardar 500ms para garantir que tudo carregou
            setTimeout(executePrint, 500);
        };
        
        // FALLBACK SEGURO - SE O onload N√ÉO DISPARAR EM 3 SEGUNDOS
        setTimeout(() => {
            if (!hasPrinted) {
                executePrint();
            }
        }, 3000);
    });
}
// ============= FIM DA FUN√á√ÉO CORRIGIDA =============
        
        // Fun√ß√µes de utilidade
        function extractCodeFromColunaA(colunaA) {
            if (!colunaA) return '0000';
            const timeMatch = colunaA.match(/(\d{1,2}):(\d{2})/);
            if (timeMatch) {
                const hours = timeMatch[1].padStart(2, '0');
                const minutes = timeMatch[2];
                return hours + minutes;
            }
            return '0000';
        }
        
        function extractCleanTime(timeStr) {
            if (!timeStr) return 'Sem hor√°rio';
            const timeMatch = timeStr.match(/(\d{1,2}:\d{2})\s*√†s\s*(\d{1,2}:\d{2})/);
            if (timeMatch) return `${timeMatch[1]} √†s ${timeMatch[2]}`;
            const singleTimeMatch = timeStr.match(/\d{1,2}:\d{2}/);
            if (singleTimeMatch) return singleTimeMatch[0];
            return timeStr;
        }
        
        function getFormaPagamento(eventData) {
            const colunaAG = eventData[32] || '';
            const pagamentoUpper = colunaAG.toString().trim().toUpperCase();
            
            if (pagamentoUpper.includes('PIX')) return 'PIX';
            if (pagamentoUpper.includes('LINK')) return 'LINK';
            
            const primeiraPalavra = pagamentoUpper.split(' ')[0] || '';
            if (primeiraPalavra) return primeiraPalavra;
            
            return 'N√ÉO INFORMADO';
        }
        
        function getPrintStatus(eventData) {
            return eventData[19] ? eventData[19].trim() !== '' : false;
        }
        
        function getPrintCode(eventData) {
            return eventData[19] ? eventData[19].trim() : '';
        }
        
        function getConferenteNameFromCode(codigo) {
            if (!codigo || !codigo.includes(' - ')) return '';
            const partes = codigo.split(' - ');
            if (partes.length >= 2) {
                return partes.slice(1).join(' - ');
            }
            return '';
        }
        
        function getMontadorStatus(eventData) {
            const colunaU = eventData[20] || '';
            const horaMontador = eventData[44] || '';
            return {
                hasMontador: colunaU.trim() !== '',
                montador: colunaU.trim(),
                horaMontador: horaMontador
            };
        }
        
        function getEntregadorStatus(eventData) {
            const colunaH = eventData[7] || '';
            return {
                hasEntregador: colunaH.trim() !== '',
                entregador: colunaH.trim()
            };
        }
        
        function getAnonimoStatus(eventData) {
            const colunaAW = eventData[48] || '';
            const colunaAX = eventData[49] || '';
            const isAnonimo = colunaAW.toString().toUpperCase().includes('ANONIMO') || 
                            colunaAW.toString().toUpperCase().includes('AN√îNIMO');
            return {
                isAnonimo: isAnonimo,
                explicacao: colunaAX
            };
        }
        
        function getItemsFromColunaV(eventData) {
            return eventData[21] || '';
        }
        
        function getColunaJContent(eventData) {
            return eventData[9] || '';
        }
        
        function getColunaLContent(eventData) {
            return eventData[11] || '';
        }
        
        function getColunaRContent(eventData) {
            return eventData[17] || '';
        }
        
        // FUN√á√ÉO: Extrair n√∫mero do pedido da coluna BA (52)
        function getOrderNumber(eventData) {
            const colunaBA = eventData[52] || '';
            if (colunaBA && colunaBA.trim() !== '') return colunaBA.toString().trim();
            return '';
        }
        
        // FUN√á√ÉO: Extrair cupom da coluna AY (50)
        function getCupomInfo(eventData) {
            const cupomText = eventData[50] || '';
            if (!cupomText) return '';
            
            const cupomMatch = cupomText.match(/CUPOM:\s*([A-Za-z0-9]+)/i);
            if (cupomMatch && cupomMatch[1]) {
                return cupomMatch[1].toUpperCase();
            }
            
            const codeMatch = cupomText.match(/([A-Za-z0-9]{4,})/);
            if (codeMatch && codeMatch[1]) {
                return codeMatch[1].toUpperCase();
            }
            
            return '';
        }
        
        // FUN√á√ÉO: Obter hist√≥rico de edi√ß√µes das colunas BD e BE
        function getEditHistory(eventData) {
            const colunaBD = eventData[55] || ''; // BD - Hist√≥rico de edi√ß√µes
            const colunaBE = eventData[56] || ''; // BE - √öltima edi√ß√£o
            return {
                fullHistory: colunaBD,
                lastEdit: colunaBE
            };
        }
        
        // NOVA FUN√á√ÉO: Verificar se √© pedido de outra cidade (coluna BD)
        function isOutraCidade(eventData) {
            const colunaBD = eventData[55] || ''; // Coluna BD
            if (!colunaBD || colunaBD.trim() === '') return false;
            
            // Verificar se cont√©m informa√ß√µes de outra cidade
            return colunaBD.includes('OUTRA CIDADE:') || 
                   colunaBD.includes('CEP:') || 
                   colunaBD.includes('Frete:') ||
                   colunaBD.includes('Prazo:');
        }
        
        // NOVA FUN√á√ÉO: Extrair informa√ß√µes da coluna BD
        function extractInfoFromBD(colunaBD) {
            if (!colunaBD) return {};
            
            const info = {
                outraCidade: '',
                cep: '',
                frete: '',
                prazo: '',
                valor: ''
            };
            
            // Extrair cidade
            const cidadeMatch = colunaBD.match(/OUTRA CIDADE:\s*(.+?)(?=\s*-|$)/i);
            if (cidadeMatch) info.outraCidade = cidadeMatch[1].trim();
            
            // Extrair CEP
            const cepMatch = colunaBD.match(/CEP:\s*(\d{5}-?\d{3})/i);
            if (cepMatch) info.cep = cepMatch[1].trim();
            
            // Extrair frete
            const freteMatch = colunaBD.match(/Frete:\s*(.+?)(?=\s*-|$)/i);
            if (freteMatch) info.frete = freteMatch[1].trim();
            
            // Extrair prazo
            const prazoMatch = colunaBD.match(/Prazo:\s*(.+?)(?=\s*-|$)/i);
            if (prazoMatch) info.prazo = prazoMatch[1].trim();
            
            // Extrair valor
            const valorMatch = colunaBD.match(/Valor:\s*(R\$\s*\d+[.,]\d+)/i);
            if (valorMatch) info.valor = valorMatch[1].trim();
            
            return info;
        }
        
        // FUN√á√ÉO: Atualizar hist√≥rico de edi√ß√µes
        function updateEditHistory(updates, editorName) {
            const now = new Date();
            const dateStr = now.toLocaleDateString('pt-BR');
            const timeStr = now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            
            let changesSummary = '';
            Object.keys(updates).forEach(index => {
                changesSummary += `Campo ${index}, `;
            });
            changesSummary = changesSummary.replace(/, $/, '');
            
            const editRecord = `[${dateStr} ${timeStr}] ${editorName}: ${changesSummary}`;
            
            return editRecord;
        }
        
        // FUN√á√ÉO CORRIGIDA: Obter dia da semana sem duplica√ß√£o
        function getDiaSemana(dataStr) {
            if (!dataStr) return '';
            
            // Limpar a string para pegar apenas a data
            const dateStr = dataStr.split(' - ')[0] || dataStr;
            
            const parts = dateStr.split('/');
            if (parts.length !== 3) return '';
            
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            
            if (isNaN(day) || isNaN(month) || isNaN(year)) return '';
            
            const date = new Date(year, month, day);
            const dias = ['Domingo', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado'];
            return dias[date.getDay()];
        }
        
        function formatCurrency(value) {
            return 'R$ ' + parseFloat(value || 0).toFixed(2).replace('.', ',');
        }
        
        // Fun√ß√µes para converter datas
        function parseDate(dateStr) {
            if (!dateStr) return null;
            dateStr = dateStr.trim();
            
            // Limpar dia da semana se existir
            const cleanDateStr = dateStr.split(' - ')[0] || dateStr;
            
            const parts = cleanDateStr.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const year = parseInt(parts[2], 10);
                
                if (isNaN(day) || isNaN(month) || isNaN(year)) {
                    return null;
                }
                
                const fullYear = year < 100 ? 2000 + year : year;
                return new Date(fullYear, month, day);
            }
            return null;
        }
        
        function isTodayOrFuture(dateStr) {
            if (!dateStr) return false;
            const eventDate = parseDate(dateStr);
            if (!eventDate) return false;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            eventDate.setHours(0, 0, 0, 0);
            
            return eventDate.getTime() >= today.getTime();
        }
        
        function isToday(dateStr) {
            if (!dateStr) return false;
            const eventDate = parseDate(dateStr);
            if (!eventDate) return false;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            eventDate.setHours(0, 0, 0, 0);
            
            return eventDate.getTime() === today.getTime();
        }
        
        function compareDatesForSorting(a, b) {
            const dateA = parseDate(a.deliveryDate);
            const dateB = parseDate(b.deliveryDate);
            
            if (!dateA && !dateB) return 0;
            if (!dateA) return 1;
            if (!dateB) return -1;
            
            if (dateA.getTime() !== dateB.getTime()) {
                return dateA.getTime() - dateB.getTime();
            }
            
            const startTimeA = extractStartTime(a.data[16] || a.data[43] || '');
            const startTimeB = extractStartTime(b.data[16] || b.data[43] || '');
            
            if (startTimeA !== startTimeB) {
                if (startTimeA === '99:99') return 1;
                if (startTimeB === '99:99') return -1;
                return startTimeA.localeCompare(startTimeB);
            }
            
            return a.rowNumber - b.rowNumber;
        }
        
        // Fun√ß√µes de UI
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('statusNotification');
            notification.className = 'status-notification';
            notification.classList.add(`status-${type}`);
            notification.innerHTML = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function showLoading(text = 'Processando...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // FUN√á√ÉO PARA TOCAR SOM DE TELEFONE - MAIS ALTO
        function playPhoneSound() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            function playRing() {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime); // Frequ√™ncia mais alta
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.1); // Volume mais alto
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            }
            
            // Primeiro toque
            playRing();
            // Segundo toque mais alto
            setTimeout(() => {
                if (audioContext.state !== 'running') audioContext.resume();
                playRing();
            }, 600);
            // Terceiro toque ainda mais alto
            setTimeout(() => {
                if (audioContext.state !== 'running') audioContext.resume();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(1200, audioContext.currentTime); // Frequ√™ncia mais alta ainda
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.7, audioContext.currentTime + 0.1); // Volume m√°ximo
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.7); // Dura√ß√£o mais longa
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.7);
            }, 1200);
        }
        
        // FUN√á√ÉO PARA TOCAR ALERTA SONORO POR 10 SEGUNDOS
        function playAlertSound() {
            if (isAlertPlaying) return;
            
            const now = Date.now();
            if (now - lastAlertTime < 300000) { // 5 minutos
                return;
            }
            
            isAlertPlaying = true;
            alertStartTime = now;
            lastAlertTime = now;
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            function createBeep() {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime); // Frequ√™ncia mais alta
                oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.3); // Varia√ß√£o mais longa
                
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime); // Volume mais alto
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.3);
            }
            
            alertSoundInterval = setInterval(() => {
                if (Date.now() - alertStartTime >= ALERT_DURATION) {
                    stopAlertSound();
                    return;
                }
                
                try {
                    if (audioContext.state !== 'running') audioContext.resume();
                    createBeep();
                } catch (error) {
                    console.log("Audio play failed:", error);
                }
            }, 600);
        }
        
        // FUN√á√ÉO PARA PARAR ALERTA SONORO
        function stopAlertSound() {
            isAlertPlaying = false;
            if (alertSoundInterval) {
                clearInterval(alertSoundInterval);
                alertSoundInterval = null;
            }
        }
        
        // FUN√á√ÉO PARA VERIFICAR PEDIDOS ATRASADOS
        function checkForLateOrders() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTimeInMinutes = currentHour * 60 + currentMinute;
            
            let lateCount = 0;
            let showAlert = false;
            
            allEvents.forEach(event => {
                const eventData = event.data;
                const entregador = getEntregadorStatus(eventData);
                
                if (entregador.hasEntregador) return;
                
                const eventDateStr = eventData[15] || '';
                if (!isToday(eventDateStr)) return;
                
                const timeStr = eventData[16] || eventData[43] || '';
                if (!timeStr) return;
                
                const timeMatch = timeStr.match(/(\d{1,2}):(\d{2})/);
                if (!timeMatch) return;
                
                const startHour = parseInt(timeMatch[1]);
                const startMinute = parseInt(timeMatch[2]);
                const startTimeInMinutes = startHour * 60 + startMinute;
                
                if (currentTimeInMinutes >= startTimeInMinutes) {
                    lateCount++;
                    showAlert = true;
                }
            });
            
            const lateAlert = document.getElementById('lateAlert');
            const lateCountElement = document.getElementById('lateCount');
            
            if (currentFilter === 'today' && lateCount > 0) {
                lateAlert.style.display = 'block';
                lateCountElement.textContent = lateCount;
                
                if (showAlert) {
                    playAlertSound();
                }
            } else {
                lateAlert.style.display = 'none';
                stopAlertSound();
            }
            
            return lateCount;
        }
        
        // FUN√á√ÉO PARA VERIFICAR NOVOS PEDIDOS
        function checkForNewOrders() {
            const currentCount = allEvents.length;
            
            if (currentCount > lastEventCount && lastEventCount > 0) {
                const newOrders = currentCount - lastEventCount;
                showNotification(`üì± ${newOrders} novo(s) pedido(s) recebido(s)!`, 'info');
                playPhoneSound();
            }
            
            lastEventCount = currentCount;
        }
        
        // FUN√á√ÉO DE BUSCA
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!searchTerm) {
                applyCurrentFilter();
                return;
            }
            
            currentFilter = 'search';
            const filtered = allEvents.filter(event => {
                const row = event.data;
                
                const searchFields = [
                    row[1] || '', // Nome do cliente
                    row[2] || '', // Telefone
                    row[3] || '', // Produto
                    row[6] || '', // Vendedor
                    row[8] || '', // Recebedor
                    row[10] || '', // Endere√ßo
                    row[12] || '', // Bairro
                    row[13] || '', // Cidade
                    getOrderNumber(row), // N√∫mero do pedido
                    getCupomInfo(row), // Cupom
                    row[15] || '', // Data entrega
                    row[16] || row[43] || '' // Hor√°rio
                ];
                
                return searchFields.some(field => 
                    field.toString().toLowerCase().includes(searchTerm)
                );
            });
            
            displayEvents(filtered);
            showNotification(`üîç ${filtered.length} pedidos encontrados para "${searchTerm}"`, 'info');
        }
        
        // FUN√á√ÉO DE SALVAMENTO COM VERIFICA√á√ÉO DE LINHA ATUAL
        async function saveToSpreadsheet(payload) {
            try {
                console.log('üì§ Enviando dados para salvar:', payload);
                
                // Verificar se a linha ainda existe e se √© a mesma
                if (payload.linha && !isNaN(payload.linha)) {
                    const linhaAtual = parseInt(payload.linha);
                    const event = allEvents.find(e => e.rowNumber === linhaAtual);
                    
                    if (!event) {
                        console.log('‚ö†Ô∏è Linha n√£o encontrada, buscando por ID...');
                        // Tentar encontrar o evento por ID (pedido + dados)
                        const orderNumber = payload.numero_pedido || getOrderNumberFromUpdates(payload);
                        if (orderNumber) {
                            // Buscar pelo n√∫mero do pedido
                            const newEvent = allEvents.find(e => getOrderNumber(e.data) === orderNumber);
                            if (newEvent) {
                                console.log(`‚úÖ Encontrado pedido ${orderNumber} na linha ${newEvent.rowNumber}`);
                                payload.linha = newEvent.rowNumber;
                            } else {
                                console.log('‚ùå Pedido n√£o encontrado em nenhuma linha');
                                return {
                                    success: false,
                                    message: 'Pedido n√£o encontrado. Atualize a p√°gina e tente novamente.'
                                };
                            }
                        }
                    }
                }
                
                const formData = new FormData();
                
                Object.keys(payload).forEach(key => {
                    if (payload[key] !== null && payload[key] !== undefined) {
                        if (typeof payload[key] === 'object') {
                            formData.append(key, JSON.stringify(payload[key]));
                        } else {
                            formData.append(key, payload[key]);
                        }
                    }
                });
                
                console.log('üì§ FormData preparado');
                
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                });
                
                console.log('‚úÖ Dados enviados com sucesso');
                
                return {
                    success: true,
                    message: 'Dados enviados com sucesso!'
                };
                
            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o:', error);
                return {
                    success: false,
                    message: 'Erro de conex√£o: ' + error.message
                };
            }
        }
        
        // Fun√ß√£o auxiliar para extrair n√∫mero do pedido das atualiza√ß√µes
        function getOrderNumberFromUpdates(payload) {
            if (payload.numero_pedido) return payload.numero_pedido;
            
            if (payload.atualizacoes && typeof payload.atualizacoes === 'string') {
                try {
                    const updates = JSON.parse(payload.atualizacoes);
                    if (updates[52]) return updates[52]; // Coluna BA
                } catch (e) {
                    console.log('Erro ao parsear atualiza√ß√µes:', e);
                }
            }
            
            return null;
        }
        
        // Fun√ß√£o para ordenar eventos (pedidos de outra cidade primeiro)
        function sortEventsByDeliveryTime(events) {
            return events.sort((a, b) => {
                // Primeiro: Pedidos de outra cidade SEM entregador v√£o primeiro
                const outraCidadeA = isOutraCidade(a.data) && !getEntregadorStatus(a.data).hasEntregador;
                const outraCidadeB = isOutraCidade(b.data) && !getEntregadorStatus(b.data).hasEntregador;
                
                if (outraCidadeA && !outraCidadeB) return -1;
                if (!outraCidadeA && outraCidadeB) return 1;
                
                // Se ambos s√£o ou n√£o s√£o de outra cidade, ordenar por status
                const statusA = getEventStatus(a.data);
                const statusB = getEventStatus(b.data);
                
                if (statusA !== statusB) {
                    return statusA - statusB;
                }
                
                const startTimeA = extractStartTime(a.data[16] || a.data[43] || '');
                const startTimeB = extractStartTime(b.data[16] || b.data[43] || '');
                
                if (startTimeA !== startTimeB) {
                    if (startTimeA === '99:99') return 1;
                    if (startTimeB === '99:99') return -1;
                    return startTimeA.localeCompare(startTimeB);
                }
                
                return a.rowNumber - b.rowNumber;
            });
        }
        
        function getEventStatus(eventData) {
            const entregador = getEntregadorStatus(eventData);
            const montador = getMontadorStatus(eventData);
            
            if (entregador.hasEntregador) return 2;
            if (montador.hasMontador) return 1;
            return 0;
        }
        
        function extractStartTime(timeStr) {
            if (!timeStr) return '99:99';
            
            const intervalMatch = timeStr.match(/(\d{1,2}):(\d{2})\s*√†s\s*\d{1,2}:\d{2}/);
            if (intervalMatch) {
                const hours = intervalMatch[1].padStart(2, '0');
                const minutes = intervalMatch[2].padStart(2, '0');
                return hours + ':' + minutes;
            }
            
            const singleTimeMatch = timeStr.match(/(\d{1,2}):(\d{2})/);
            if (singleTimeMatch) {
                const hours = singleTimeMatch[1].padStart(2, '0');
                const minutes = singleTimeMatch[2].padStart(2, '0');
                return hours + ':' + minutes;
            }
            
            return '99:99';
        }
        
        // Fun√ß√£o para atualizar o progresso do bot√£o de refresh
        function updateRefreshProgress() {
            refreshProgress += 100 / (autoRefreshTime / 1000);
            if (refreshProgress >= 100) {
                refreshProgress = 0;
                refreshData();
            }
            
            document.getElementById('refreshProgress').style.width = refreshProgress + '%';
        }
        
        // Fun√ß√µes principais
        async function fetchData() {
            try {
                showNotification('üì• Carregando dados...', 'info');
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?majorDimension=ROWS&key=${API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                allEvents = data.values.slice(1).map((row, index) => ({
                    data: row,
                    rowNumber: index + 2,
                    id: row[15] + row[16] + row[3],
                    deliveryTime: extractStartTime(row[16] || row[43] || ''),
                    status: getEventStatus(row),
                    deliveryDate: row[15] || '',
                    startTime: extractStartTime(row[16] || row[43] || ''),
                    isOutraCidade: isOutraCidade(row),
                    isPrinted: getPrintStatus(row) // Adicionado para controle de cor
                }));
                
                console.log(`‚úÖ ${allEvents.length} eventos carregados`);
                
                // Atualizar cache de IDs
                currentRowIdCache = {};
                allEvents.forEach(event => {
                    const orderNumber = getOrderNumber(event.data);
                    if (orderNumber) {
                        currentRowIdCache[orderNumber] = event.rowNumber;
                    }
                });
                
                allEvents = sortEventsByDeliveryTime(allEvents);
                
                itemsCache = {};
                allEvents.forEach(event => {
                    const items = getItemsFromColunaV(event.data);
                    if (items.trim() !== '') {
                        itemsCache[event.rowNumber] = items;
                    }
                });
                
                checkForNewOrders();
                
                applyCurrentFilter();
                showNotification('‚úÖ Dados carregados!', 'success');
                
                updateUnprintedCount();
                
            } catch (error) {
                console.error('Erro:', error);
                showNotification('‚ùå Erro ao carregar dados', 'error');
            }
        }
        
        // FUN√á√ÉO PARA ATUALIZAR CONTADOR DE FICHAS SEM IMPRIMIR
        function updateUnprintedCount() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const unprintedCount = allEvents.filter(event => {
                const isPrinted = getPrintStatus(event.data);
                if (isPrinted) return false;
                
                const eventDateStr = event.deliveryDate;
                if (!eventDateStr) return false;
                
                return isTodayOrFuture(eventDateStr);
            }).length;
            
            document.getElementById('unprintedCountBadge').textContent = unprintedCount;
        }
        
        function displayEvents(events) {
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = '';
            
            if (!events || events.length === 0) {
                eventList.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 30px; color: #666;">
                        <h3>Nenhum pedido encontrado</h3>
                    </div>
                `;
                document.getElementById('eventCount').textContent = '0';
                return;
            }
            
            const sortedEvents = [...events].sort((a, b) => {
                // Pedidos de outra cidade SEM entregador sempre primeiro
                const outraCidadeA = isOutraCidade(a.data) && !getEntregadorStatus(a.data).hasEntregador;
                const outraCidadeB = isOutraCidade(b.data) && !getEntregadorStatus(b.data).hasEntregador;
                
                if (outraCidadeA && !outraCidadeB) return -1;
                if (!outraCidadeA && outraCidadeB) return 1;
                
                const statusA = getEventStatus(a.data);
                const statusB = getEventStatus(b.data);
                
                if (statusA !== statusB) {
                    return statusA - statusB;
                }
                
                return compareDatesForSorting(a, b);
            });
            
            sortedEvents.forEach(event => {
                const row = event.data;
                const anonimoInfo = getAnonimoStatus(row);
                const montador = getMontadorStatus(row);
                const entregador = getEntregadorStatus(row);
                const isPrinted = getPrintStatus(row);
                const hasItems = itemsCache[event.rowNumber] ? true : false;
                const formaPagamento = getFormaPagamento(row);
                const orderNumber = getOrderNumber(row);
                const cupomInfo = getCupomInfo(row);
                const isOutraCidadeEvent = isOutraCidade(row);
                const isImpresso = getPrintStatus(row); // Novo: verificar se j√° foi impresso
                
                const valorE = parseFloat(row[4]?.replace(',', '.') || 0);
                const valorF = parseFloat(row[5]?.replace(',', '.') || 0);
                const total = valorE + valorF;
                
                // Truncar nome do produto para m√°ximo 2 linhas
                const produtoCompleto = row[3] || '';
                let produtoDisplay = produtoCompleto;
                
                // Se o produto tiver mais de 80 caracteres, truncar
                if (produtoCompleto.length > 80) {
                    produtoDisplay = produtoCompleto.substring(0, 77) + '...';
                }
                
                // Verificar se endere√ßo est√° em branco
                const endereco = row[10] || '';
                const bairro = row[12] || '';
                const cidade = row[13] || '';
                
                let enderecoDisplay = '';
                if (!endereco.trim() && !bairro.trim() && !cidade.trim()) {
                    enderecoDisplay = '<span class="address-retirada">(RETIRADA LOJA)</span>';
                } else {
                    enderecoDisplay = `${endereco}<br>${bairro} - ${cidade}`;
                }
                
                const card = document.createElement('div');
                card.className = 'event-card';
                
                if (!isPrinted) card.classList.add('unprinted');
                if (montador.hasMontador) card.classList.add('completed');
                if (entregador.hasEntregador) card.classList.add('finalized');
                if (isOutraCidadeEvent) {
                    card.classList.add('outra-cidade');
                    // Novo: se j√° foi impresso, adiciona classe 'impresso' para ficar amarelo
                    if (isImpresso) {
                        card.classList.add('impresso');
                    }
                }
                
                const printBtnClass = isPrinted ? 'btn-completed' : 'btn-default';
                const itemsBtnClass = hasItems ? 'btn-completed' : 'btn-default';
                const montadorBtnClass = montador.hasMontador ? 'btn-completed' : 'btn-default';
                const entregadorBtnClass = entregador.hasEntregador ? 'btn-completed' : 'btn-default';
                const entregadorDisabled = !montador.hasMontador;
                
                let montadorButtonText = 'üë∑ Montar';
                if (montador.hasMontador) {
                    const nomeMontador = montador.montador.split(' - ')[0] || montador.montador;
                    montadorButtonText = `üë∑ ${nomeMontador.substring(0, 10)}${nomeMontador.length > 10 ? '...' : ''}`;
                }
                
                card.innerHTML = `
                    <div class="order-number" data-row="${event.rowNumber}">${event.rowNumber}</div>
                    <div class="event-header">
                        <div style="flex: 1;">
                            <div class="delivery-info">
                                <span>${row[15] || ''}</span>
                                <span>${extractCleanTime(row[16] || row[43] || '')}</span>
                                ${isOutraCidadeEvent ? '<span class="outra-cidade-badge">OUTRA CIDADE</span>' : ''}
                            </div>
                            <div class="client-info">
                                <div class="client-info-left">
                                    <span class="client-label">Cliente:</span>
                                    <span class="client-name">${row[1] || ''}</span>
                                    ${anonimoInfo.isAnonimo ? '<span class="anonimo-badge">AN√îNIMO</span>' : ''}
                                </div>
                                <div class="client-info-right">
                                    <span class="payment-info">${formaPagamento}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="event-body">
                        <div class="product-name" title="${produtoCompleto}">${produtoDisplay}</div>
                        <div class="info-row">
                            <div class="address-info">
                                ${enderecoDisplay}
                            </div>
                            <div class="seller-info">
                                <div>${row[6] || ''}</div>
                                <div class="total-info">${formatCurrency(total)}</div>
                                ${orderNumber ? `<span class="order-number-panel">${orderNumber}</span>` : ''}
                                ${cupomInfo ? `<span class="cupom-info">${cupomInfo}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="event-footer">
                        <div class="action-buttons">
                            <button class="btn btn-small ${printBtnClass}" 
                                    onclick="openPrintModal(${event.rowNumber})"
                                    data-row="${event.rowNumber}">
                                ${getPrintCode(row) ? `üñ®Ô∏è ${getPrintCode(row).split(' - ')[0]}` : 'üñ®Ô∏è Imprimir'}
                            </button>
                            <button class="btn btn-small ${itemsBtnClass}" 
                                    onclick="openItemsModal(${event.rowNumber})"
                                    data-row="${event.rowNumber}">
                                ${hasItems ? 'üìã Itens' : '2'}
                            </button>
                            ${montador.hasMontador ? 
                                `<button class="btn btn-small ${montadorBtnClass}" 
                                        onclick="startAction(${event.rowNumber}, 'desfazer_montador')"
                                        data-row="${event.rowNumber}">
                                    ${montadorButtonText}
                                </button>` :
                                `<button class="btn btn-small ${montadorBtnClass}" 
                                        onclick="startAction(${event.rowNumber}, 'montador')"
                                        data-row="${event.rowNumber}">
                                    üë∑ Montar
                                </button>`}
                            ${entregador.hasEntregador ? 
                                `<button class="btn btn-small ${entregadorBtnClass}" 
                                        onclick="startAction(${event.rowNumber}, 'desfazer_entregador')"
                                        data-row="${event.rowNumber}">
                                    üöö ${entregador.entregador.substring(0, 10)}${entregador.entregador.length > 10 ? '...' : ''}
                                </button>` :
                                `<button class="btn btn-small ${entregadorBtnClass} ${entregadorDisabled ? 'disabled' : ''}" 
                                        onclick="${entregadorDisabled ? '' : `startAction(${event.rowNumber}, 'entregador')`}"
                                        data-row="${event.rowNumber}"
                                        ${entregadorDisabled ? 'disabled' : ''}>
                                    üöö Entregador
                                </button>`}
                        </div>
                        <div class="edit-button-container">
                            <button class="edit-btn" onclick="openEditModal(${event.rowNumber})" title="Editar pedido">
                                ‚úèÔ∏è
                            </button>
                        </div>
                    </div>
                `;
                
                eventList.appendChild(card);
            });
            
            document.getElementById('eventCount').textContent = events.length;
            
            setTimeout(() => checkForLateOrders(), 100);
        }
        
        // Fun√ß√µes de filtro
        function filterToday() {
            currentFilter = 'today';
            const today = new Date().toLocaleDateString('pt-BR');
            const filtered = allEvents.filter(event => 
                (event.data[15] && event.data[15].includes(today)) || 
                (isOutraCidade(event.data) && !getEntregadorStatus(event.data).hasEntregador)
            );
            displayEvents(filtered);
        }
        
        function filterTomorrow() {
            currentFilter = 'tomorrow';
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateStr = tomorrow.toLocaleDateString('pt-BR');
            const filtered = allEvents.filter(event => 
                (event.data[15] && event.data[15].includes(dateStr)) || 
                (isOutraCidade(event.data) && !getEntregadorStatus(event.data).hasEntregador)
            );
            displayEvents(filtered);
        }
        
        function filterNextSunday() {
            currentFilter = 'sunday';
            const today = new Date();
            const daysUntilSunday = 7 - today.getDay();
            const sunday = new Date(today);
            sunday.setDate(today.getDate() + daysUntilSunday);
            const dateStr = sunday.toLocaleDateString('pt-BR');
            const filtered = allEvents.filter(event => 
                (event.data[15] && event.data[15].includes(dateStr)) || 
                (isOutraCidade(event.data) && !getEntregadorStatus(event.data).hasEntregador)
            );
            displayEvents(filtered);
        }
        
        function filterByDate(dateStr) {
            currentFilter = 'custom';
            const parts = dateStr.split('-');
            const date = new Date(parts[0], parts[1] - 1, parts[2]);
            const formattedDate = date.toLocaleDateString('pt-BR');
            const filtered = allEvents.filter(event => 
                (event.data[15] && event.data[15].includes(formattedDate)) || 
                (isOutraCidade(event.data) && !getEntregadorStatus(event.data).hasEntregador)
            );
            displayEvents(filtered);
        }
        
        function filterUnprinted() {
            currentFilter = 'unprinted';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const filtered = allEvents.filter(event => {
                const isPrinted = getPrintStatus(event.data);
                if (isPrinted) return false;
                
                const eventDateStr = event.deliveryDate;
                if (!eventDateStr) return false;
                
                return isTodayOrFuture(eventDateStr) || 
                       (isOutraCidade(event.data) && !getEntregadorStatus(event.data).hasEntregador);
            });
            
            filtered.sort((a, b) => {
                // Pedidos de outra cidade primeiro
                const outraCidadeA = isOutraCidade(a.data) && !getEntregadorStatus(a.data).hasEntregador;
                const outraCidadeB = isOutraCidade(b.data) && !getEntregadorStatus(b.data).hasEntregador;
                
                if (outraCidadeA && !outraCidadeB) return -1;
                if (!outraCidadeA && outraCidadeB) return 1;
                
                return compareDatesForSorting(a, b);
            });
            
            console.log(`üñ®Ô∏è Filtro "Sem Imprimir" encontrou ${filtered.length} eventos`);
            displayEvents(filtered);
        }
        
        function applyCurrentFilter() {
            switch(currentFilter) {
                case 'today': filterToday(); break;
                case 'tomorrow': filterTomorrow(); break;
                case 'sunday': filterNextSunday(); break;
                case 'unprinted': filterUnprinted(); break;
                case 'search': break;
                default: filterToday();
            }
        }
        
        function refreshData() {
            fetchData();
            showNotification('üîÑ Atualizando...', 'info');
        }
        
        // FUN√á√ïES PARA O BOT√ÉO 2 - CORRIGIDO: AGORA IMPRIME APENAS UMA FOLHA
        function openItemsModal(rowNumber) {
            const event = allEvents.find(e => e.rowNumber === rowNumber);
            if (!event) {
                showNotification('‚ùå Evento n√£o encontrado', 'error');
                return;
            }
            
            currentRowNumber = rowNumber;
            currentPrintEventData = event.data;
            
            const existingItems = itemsCache[rowNumber] || '';
            document.getElementById('itemsTextarea').value = existingItems;
            document.getElementById('itemsRowNumber').textContent = rowNumber;
            document.getElementById('itemsRowNumberDisplay').textContent = rowNumber;
            
            validateItemsCount();
            
            document.getElementById('itemsModal').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('itemsTextarea').focus();
                document.getElementById('itemsTextarea').scrollTop = 0;
            }, 100);
        }
        
        function validateItemsCount() {
            const textarea = document.getElementById('itemsTextarea');
            const itemsCount = document.getElementById('itemsCount');
            const saveBtn = document.getElementById('saveItemsBtn');
            const saveBtnBottom = document.getElementById('saveItemsBtnBottom');
            
            const lines = textarea.value.split('\n');
            const totalLines = lines.length;
            
            itemsCount.textContent = `Linhas: ${totalLines}/30`;
            
            if (totalLines <= 30) {
                itemsCount.className = 'items-count';
                itemsCount.style.color = '#666';
                saveBtn.disabled = false;
                saveBtnBottom.disabled = false;
                saveBtn.classList.remove('disabled');
                saveBtnBottom.classList.remove('disabled');
            } else {
                itemsCount.className = 'items-count error';
                itemsCount.textContent += ' - LIMITE DE 30 LINHAS EXCEDIDO!';
                itemsCount.style.color = '#f44336';
                saveBtn.disabled = true;
                saveBtnBottom.disabled = true;
                saveBtn.classList.add('disabled');
                saveBtnBottom.classList.add('disabled');
            }
        }
        
        function distributeItemsToColumns(itemsArray) {
            const columns = [[], [], []];
            
            for (let i = 0; i < itemsArray.length; i++) {
                const columnIndex = Math.floor(i / 10);
                if (columnIndex < 3) {
                    columns[columnIndex].push(itemsArray[i]);
                }
            }
            
            return { 
                columns, 
                fits: itemsArray.length <= 30,
                totalLines: itemsArray.length
            };
        }
        
        // CORRE√á√ÉO: AGORA GERA APENAS UMA FOLHA A4 COM LISTA NO TOPO E NO RODAP√â
        function generateItemsPrintHTML(eventData, itemsText) {
            const itemsArray = itemsText.split('\n').filter(item => item.trim() !== '');
            const { columns, fits, totalLines } = distributeItemsToColumns(itemsArray);
            
            if (!fits) {
                showNotification(`‚ùå Limite de 30 linhas excedido (${totalLines} linhas)`, 'error');
                return '';
            }
            
            let columnsHTMLTop = '';
            let columnsHTMLBottom = '';
            
            for (let i = 0; i < 3; i++) {
                let columnContent = '';
                if (columns[i] && columns[i].length > 0) {
                    columnContent = '<ul class="items-list-print">';
                    columns[i].forEach(item => {
                        columnContent += `<li>${item}</li>`;
                    });
                    
                    const emptyLines = 10 - columns[i].length;
                    for (let j = 0; j < emptyLines; j++) {
                        columnContent += `<li>&nbsp;</li>`;
                    }
                    
                    columnContent += '</ul>';
                } else {
                    columnContent = '<ul class="items-list-print">';
                    for (let j = 0; j < 10; j++) {
                        columnContent += `<li>&nbsp;</li>`;
                    }
                    columnContent += '</ul>';
                }
                
                const columnHTML = `
                    <div class="items-column-print">
                        <div class="items-column-content-print">
                            ${columnContent}
                        </div>
                    </div>
                `;
                
                columnsHTMLTop += columnHTML;
                columnsHTMLBottom += columnHTML;
            }
            
            // UMA FOLHA A4 COM LISTA NO TOPO E OUTRA NO RODAP√â
            return `
                <div class="a4-items-page">
                    <!-- LISTA NO TOPO DA P√ÅGINA -->
                    <div class="items-top-section">
                        <div class="items-multicolumn-container">
                            ${columnsHTMLTop}
                        </div>
                    </div>
                    
                    <!-- LISTA NO RODAP√â DA P√ÅGINA -->
                    <div class="items-bottom-section">
                        <div class="items-multicolumn-container">
                            ${columnsHTMLBottom}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ============= FUN√á√ÉO CORRIGIDA: saveAndPrintItems =============
        async function saveAndPrintItems() {
            const textarea = document.getElementById('itemsTextarea');
            const saveBtn = document.getElementById('saveItemsBtn');
            
            if (saveBtn.disabled) {
                showNotification('‚ùå Limite de 30 linhas excedido! Reduza para no m√°ximo 30 linhas.', 'error');
                return;
            }
            
            const itemsText = textarea.value;
            
            const lines = itemsText.split('\n');
            if (lines.length > 30) {
                showNotification('‚ùå Limite de 30 linhas excedido!', 'error');
                return;
            }
            
            showLoading('Salvando itens...');
            
            // Verificar linha atual
            const event = allEvents.find(e => e.rowNumber === currentRowNumber);
            if (!event) {
                showNotification('‚ùå Pedido n√£o encontrado. Atualize a p√°gina.', 'error');
                hideLoading();
                return;
            }
            
            const orderNumber = getOrderNumber(event.data);
            
            const payload = {
                senha: '562938',
                linha: currentRowNumber,
                numero_pedido: orderNumber,
                tipo: 'itens',
                itens: itemsText
            };
            
            console.log('üì§ Enviando itens para salvar:', payload);
            const result = await saveToSpreadsheet(payload);
            
            if (result.success) {
                itemsCache[currentRowNumber] = itemsText;
                showNotification('‚úÖ Itens salvos com sucesso!', 'success');
                
                updateButtonStatus(currentRowNumber, true);
                
                const itemsPrintHTML = generateItemsPrintHTML(currentPrintEventData, itemsText);
                if (!itemsPrintHTML) {
                    hideLoading();
                    return;
                }
                
                // ============= CORRE√á√ÉO PRINCIPAL =============
                // Usar a nova fun√ß√£o de impress√£o isolada em iframe
                printIsolatedContent(itemsPrintHTML).then(() => {
                    closeItemsModal();
                    applyCurrentFilter();
                });
                
            } else {
                showNotification('‚ùå ' + result.message, 'error');
            }
            
            hideLoading();
        }
        
        function updateButtonStatus(rowNumber, hasItems) {
            const button = document.querySelector(`button[data-row="${rowNumber}"][onclick*="openItemsModal"]`);
            if (button) {
                if (hasItems) {
                    button.classList.remove('btn-default');
                    button.classList.add('btn-completed');
                    button.innerHTML = 'üìã Itens';
                } else {
                    button.classList.remove('btn-completed');
                    button.classList.add('btn-default');
                    button.innerHTML = '2';
                }
            }
        }
        
        function closeItemsModal() {
            document.getElementById('itemsModal').style.display = 'none';
            document.getElementById('printItemsContent').style.display = 'none';
        }
        
        // Fun√ß√µes para o bot√£o 1 (Impress√£o normal)
        async function openPrintModal(rowNumber) {
            const event = allEvents.find(e => e.rowNumber === rowNumber);
            if (!event) return;
            
            currentPrintEventData = event.data;
            currentRowNumber = rowNumber;
            
            const mensagemCentral = event.data[18] || '';
            const mensagemPersonalizada = mensagemCentral || ``;
            
            const textLength = mensagemPersonalizada.length;
            if (textLength <= 20) {
                currentFontSize = 80;
            } else if (textLength <= 40) {
                currentFontSize = 60;
            } else if (textLength <= 60) {
                currentFontSize = 48;
            } else if (textLength <= 80) {
                currentFontSize = 40;
            } else if (textLength <= 100) {
                currentFontSize = 32;
            } else if (textLength <= 150) {
                currentFontSize = 24;
            } else if (textLength <= 200) {
                currentFontSize = 20;
            } else if (textLength <= 300) {
                currentFontSize = 16;
            } else if (textLength <= 400) {
                currentFontSize = 14;
            } else if (textLength <= 500) {
                currentFontSize = 12;
            } else {
                currentFontSize = 10;
            }
            
            currentRecipientFontSize = fontSettings.nome_presenteado;
            
            const codigoSalvo = getPrintCode(event.data);
            existingConferenteName = getConferenteNameFromCode(codigoSalvo);
            
            document.getElementById('printModalTitle').textContent = `Ficha - Linha ${rowNumber}`;
            
            const codigo = extractCodeFromColunaA(event.data[0] || '');
            document.getElementById('printContent').innerHTML = generateFichaHTML(event.data, codigo);
            
            document.getElementById('printModal').style.display = 'flex';
        }
        
        // Fun√ß√µes para ajustar tamanho do texto do cart√£o
        function increaseFontSize() {
            if (currentFontSize < MAX_FONT_SIZE) {
                currentFontSize += 2;
                updatePrintPreview();
            }
        }
        
        function decreaseFontSize() {
            if (currentFontSize > 6) {
                currentFontSize -= 2;
                updatePrintPreview();
            }
        }
        
        function increaseRecipientFontSize() {
            if (currentRecipientFontSize < 32) {
                currentRecipientFontSize += 2;
                updatePrintPreview();
            }
        }
        
        function decreaseRecipientFontSize() {
            if (currentRecipientFontSize > 12) {
                currentRecipientFontSize -= 2;
                updatePrintPreview();
            }
        }
        
        function copyCartText() {
            const mensagemCentral = currentPrintEventData[18] || '';
            const mensagemPersonalizada = mensagemCentral || ``;
            
            navigator.clipboard.writeText(mensagemPersonalizada)
                .then(() => {
                    showNotification('‚úÖ Texto copiado para a √°rea de transfer√™ncia!', 'success');
                })
                .catch(err => {
                    console.error('Erro ao copiar:', err);
                    const textArea = document.createElement('textarea');
                    textArea.value = mensagemPersonalizada;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('‚úÖ Texto copiado para a √°rea de transfer√™ncia!', 'success');
                });
        }
        
        function updatePrintPreview() {
            const codigo = extractCodeFromColunaA(currentPrintEventData[0] || '');
            document.getElementById('printContent').innerHTML = generateFichaHTML(currentPrintEventData, codigo);
        }
        
        // Gerar ficha HTML para impress√£o - COM CORRE√á√ÉO DO CAMPO BAIRRO
        function generateFichaHTML(eventData, codigo) {
            const anonimoInfo = getAnonimoStatus(eventData);
            let formaPagamento = getFormaPagamento(eventData);
            
            const codigoSalvo = getPrintCode(eventData);
            let nomeConferente = '';
            let codigoApenas = codigo;
            
            if (codigoSalvo && codigoSalvo.includes(' - ')) {
                const partes = codigoSalvo.split(' - ');
                if (partes.length >= 2) {
                    codigoApenas = partes[0];
                    nomeConferente = partes.slice(1).join(' - ');
                    formaPagamento = `${formaPagamento} - ${nomeConferente}`;
                }
            }
            
            const valorE = parseFloat(eventData[4]?.replace(',', '.') || 0);
            const valorF = parseFloat(eventData[5]?.replace(',', '.') || 0);
            const produtoTotal = valorE.toFixed(2).replace('.', ',');
            const frete = valorF.toFixed(2).replace('.', ',');
            const total = (valorE + valorF).toFixed(2).replace('.', ',');
            
            const colunaJContent = getColunaJContent(eventData);
            const colunaLContent = getColunaLContent(eventData);
            const colunaRContent = getColunaRContent(eventData);
            
            const isAnonimo = anonimoInfo.isAnonimo;
            const cliente = eventData[1] || '';
            const telefone = eventData[2] || '';
            const vendedor = eventData[6] || '';
            const orderNumber = getOrderNumber(eventData);
            const vendedorComPedido = orderNumber ? `${vendedor} <span class="order-number-print">${orderNumber}</span>` : vendedor;
            const endereco = eventData[10] || '';
            const bairro = eventData[12] || '';
            const cidade = eventData[13] || '';
            const referenciaEndereco = eventData[14] || '';
            
            // Verificar se √© pedido de outra cidade
            const isOutraCidadeEvent = isOutraCidade(eventData);
            const colunaBD = eventData[55] || '';
            const infoBD = extractInfoFromBD(colunaBD);
            
            // Determinar data e hor√°rio com base no tipo de pedido
            let dataDisplay = '';
            let horarioDisplay = '';
            let diaSemanaDisplay = '';
            let cidadeComCEP = cidade;
            
            if (isOutraCidadeEvent && infoBD.prazo) {
                // Para pedidos de outra cidade, usar informa√ß√µes da coluna BD
                dataDisplay = infoBD.prazo;
                horarioDisplay = infoBD.frete || 'A COMBINAR';
                diaSemanaDisplay = '';
                
                // Adicionar CEP √† cidade se dispon√≠vel
                if (infoBD.cep) {
                    cidadeComCEP = `${cidade} - ${infoBD.cep}`;
                }
            } else {
                // Para pedidos normais, usar informa√ß√µes padr√£o
                const dataCompleta = eventData[15] || '';
                const partes = dataCompleta.split(' - ');
                const data = partes[0] || dataCompleta;
                const diaSemana = getDiaSemana(data);
                const horario = extractCleanTime(eventData[16] || eventData[43] || '');
                
                dataDisplay = data;
                horarioDisplay = horario;
                diaSemanaDisplay = diaSemana ? ' - ' + diaSemana : '';
            }
            
            const recebedor = eventData[8] || '';
            const produtoDescricao = eventData[3] || '';
            const mensagemCentral = eventData[18] || '';
            const colunaAW = eventData[48] || '';
            const colunaA = eventData[0] || '';
            
            // Verificar se endere√ßo est√° em branco
            let fichaEndereco = '';
            let fichaBairroCidade = '';
            
            if (!endereco.trim() && !bairro.trim() && !cidade.trim()) {
                fichaEndereco = '<span style="font-weight: bold; color: #D32F2F;">(RETIRADA LOJA)</span>';
                fichaBairroCidade = '<span style="font-weight: bold; color: #D32F2F;">(RETIRADA LOJA)</span>';
            } else {
                fichaEndereco = endereco;
                // CORRE√á√ÉO: Apenas o bairro no campo "Bairro" (sem a cidade)
                fichaBairroCidade = bairro;
            }
            
            const fichaSuperiorCliente = cliente;
            const fichaSuperiorTelefone = telefone;
            const fichaInferiorCliente = isAnonimo ? 'ANONIMO' : cliente;
            const fichaInferiorTelefone = isAnonimo ? 'ANONIMO' : telefone;
            
            const mensagemPersonalizada = mensagemCentral || ``;
            
            // Justificativa an√¥nimo (se existir)
            const justificativaAnonimo = anonimoInfo.explicacao ? `
                <div class="anonimo-justificativa-print">
                    ${anonimoInfo.explicacao}
                </div>
            ` : '';
            
            return `
                <div class="a4-page">
                    <!-- FICHA SUPERIOR (COM PRE√áOS) -->
                    <div class="a4-top">
                        <table style="margin-bottom: 0;">
                            <tr>
                                <td class="bg-gray">Nome Comprador</td>
                                <td colspan="2" style="font-size: ${fontSettings.comprador}px !important;">
                                    ${fichaSuperiorCliente}
                                </td>
                                <td colspan="2" style="font-size: ${fontSettings.telefone}px !important;">
                                    ${fichaSuperiorTelefone}
                                </td>
                            </tr>
                            <tr>
                                <td class="bg-gray" style="font-size: ${fontSettings.cartao}px !important;">
                                    Cart√£o: ${colunaRContent || 'N√£o'}
                                </td>
                                <td colspan="1" style="font-size: ${fontSettings.cartao}px !important;">
                                    ${colunaAW}
                                </td>
                                <td colspan="3" style="font-size: ${fontSettings.vendedor}px !important;">
                                    Vendedor: ${vendedorComPedido}
                                </td>
                            </tr>
                            <tr>
                                <td class="bg-gray">Endere√ßo entrega</td>
                                <td colspan="2" style="font-size: ${fontSettings.endereco}px !important;">
                                    ${fichaEndereco}
                                </td>
                                <td colspan="2" style="font-size: ${fontSettings.bairro}px !important; font-weight: bold;">
                                    ${fichaBairroCidade}
                                </td>
                            </tr>
                            <tr>
                                <td class="bg-gray">N√∫mero/Compl.</td>
                                <td colspan="2" style="font-size: ${fontSettings.cidade}px !important;">
                                    ${colunaLContent}
                                </td>
                                <td colspan="2" style="font-size: ${fontSettings.cidade}px !important;">
                                    ${cidadeComCEP}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-size: ${fontSettings.referencia}px !important;">${colunaA}</td>
                                <td class="bg-gray" colspan="4" style="font-size: ${fontSettings.referencia}px !important;">
                                    Refer√™ncia: ${referenciaEndereco}
                                </td>
                            </tr>
                            <tr>
                                <td class="bg-gray">${isOutraCidadeEvent ? 'Prazo Entrega' : 'Dia da Entrega'}</td>
                                <td colspan="2" class="delivery-day" style="font-size: ${fontSettings.dia_entrega}px !important;">
                                    <b>${dataDisplay}${diaSemanaDisplay}</b>
                                </td>
                                <td colspan="2" class="delivery-time" style="font-size: ${fontSettings.horario_entrega}px !important;">
                                    <b>${horarioDisplay}</b>
                                </td>
                            </tr>
                            <tr>
                                <td class="bg-gray">Quem vai Receber</td>
                                <td colspan="3" style="font-size: ${fontSettings.recebedor}px !important;">
                                    ${recebedor}
                                </td>
                                <td style="font-size: ${fontSettings.colunaJ}px !important;">
                                    ${colunaJContent || '&nbsp;'}
                                </td>
                            </tr>
                            <tr>
                                <td colspan="3" class="product-description-large" style="font-size: ${fontSettings.produto}px !important;">
                                    <b>${produtoDescricao}</b>
                                </td>
                                <td style="font-size: ${fontSettings.produto_valor}px !important; vertical-align: top;">
                                    Prod: ${produtoTotal}<br>
                                    Frete: ${frete}
                                </td>
                                <td style="font-weight: bold; text-align: center; vertical-align: top;">
                                    <b style="font-size: ${fontSettings.total}px !important;">Total<br>${total}</b><br>
                                    <small style="font-size: ${fontSettings.forma_pagamento}px !important;">${formaPagamento}</small>
                                </td>
                            </tr>
                        </table>
                        ${justificativaAnonimo}
                    </div>

                    <!-- ESPA√áO CENTRAL PARA O BILHETE -->
                    <div class="a4-middle">
                        <div class="message-text-container">
                            <div class="message-text" style="font-size: ${currentFontSize}px !important;">
                                ${mensagemPersonalizada}
                            </div>
                        </div>
                    </div>

                    <!-- FICHA INFERIOR (SEM PRE√áOS) -->
                    <div class="a4-bottom">
                        <span class="recipient-highlight" style="font-size: ${currentRecipientFontSize}px !important;">
                            ${recebedor}
                            <div class="text-size-controls">
                                <button class="copy-btn" onclick="copyCartText()" title="Copiar texto do cart√£o">üìã</button>
                                <button class="text-size-btn" onclick="increaseFontSize()" title="Aumentar texto do cart√£o (m√°x. 80px)">A+</button>
                                <button class="text-size-btn" onclick="decreaseFontSize()" title="Diminuir texto do cart√£o">A-</button>
                                <button class="text-size-btn" onclick="increaseRecipientFontSize()" title="Aumentar nome">N+</button>
                                <button class="text-size-btn" onclick="decreaseRecipientFontSize()" title="Diminuir nome">N-</button>
                            </div>
                        </span>
                        <table style="margin-bottom: 0;">
                            <tr>
                                <td class="bg-gray">Nome Comprador</td>
                                <td colspan="2" style="font-size: ${fontSettings.comprador}px !important;">
                                    ${fichaInferiorCliente}
                                </td>
                                <td colspan="2" style="font-size: ${fontSettings.telefone}px !important;">
                                    ${fichaInferiorTelefone}
                                </td>
                            </tr>
                            <tr>
                                <td class="bg-gray" style="font-size: ${fontSettings.cartao}px !important;">
                                    Cart√£o: ${colunaRContent || 'N√£o'}
                                </td>
                                <td colspan="1" style="font-size: ${fontSettings.cartao}px !important;">
                                    ${colunaAW}
                                </td>
                                <td colspan="3" style="font-size: ${fontSettings.vendedor}px !important;">
                                    Vendedor: ${vendedorComPedido}
                                </td>
                            </tr>
                            <tr>
                                <td class="bg-gray">Endere√ßo entrega</td>
                                <td colspan="2" style="font-size: ${fontSettings.endereco}px !important;">
                                    ${fichaEndereco}
                                </td>
                                <td colspan="2" style="font-size: ${fontSettings.bairro}px !important; font-weight: bold;">
                                    ${fichaBairroCidade}
                                </td>
                            </tr>
                            <tr>
                                <td class="bg-gray">N√∫mero/Compl.</td>
                                <td colspan="2" style="font-size: ${fontSettings.cidade}px !important;">
                                    ${colunaLContent}
                                </td>
                                <td colspan="2" style="font-size: ${fontSettings.cidade}px !important;">
                                    ${cidadeComCEP}
                                </td>
                            </tr>
                            <tr>
                                <td style="font-size: ${fontSettings.referencia}px !important;">${colunaA}</td>
                                <td class="bg-gray" colspan="4" style="font-size: ${fontSettings.referencia}px !important;">
                                    Refer√™ncia: ${referenciaEndereco}
                                </td>
                            </tr>
                            <tr>
                                <td class="bg-gray">${isOutraCidadeEvent ? 'Prazo Entrega' : 'Dia da Entrega'}</td>
                                <td colspan="2" class="delivery-day" style="font-size: ${fontSettings.dia_entrega}px !important;">
                                    <b>${dataDisplay}${diaSemanaDisplay}</b>
                                </td>
                                <td colspan="2" class="delivery-time" style="font-size: ${fontSettings.horario_entrega}px !important;">
                                    <b>${horarioDisplay}</b>
                                </td>
                            </tr>
                            <tr>
                                <td class="bg-gray">Quem vai Receber</td>
                                <td colspan="3" style="font-size: ${fontSettings.recebedor}px !important;">
                                    ${recebedor}
                                </td>
                                <td style="font-size: ${fontSettings.colunaJ}px !important;">
                                    ${colunaJContent || '&nbsp;'}
                                </td>
                            </tr>
                            <tr>
                                <td colspan="3" class="product-description-large" style="font-size: ${fontSettings.produto}px !important;">
                                    <b>${produtoDescricao}</b>
                                </td>
                                <td style="font-size: ${fontSettings.produto_valor}px !important; vertical-align: top;">
                                    <br>
                                    <br>
                                    <span style="font-size: 8px;">Recebido:</span>
                                </td>
                                <td style="text-align: center; font-weight: bold; vertical-align: top;">
                                    C√ìDIGO<br>
                                    <span style="font-size: ${fontSettings.codigo}px !important;">
                                        ${codigoApenas}
                                    </span><br>
                                    <small style="font-size: ${fontSettings.forma_pagamento}px !important;">${formaPagamento}</small>
                                </td>
                            </tr>
                        </table>
                        ${justificativaAnonimo}
                    </div>
                </div>
            `;
        }
        
        // Fun√ß√µes de c√≥digo de impress√£o
        function requestPrintCode() {
            const codigo = extractCodeFromColunaA(currentPrintEventData[0] || '');
            generatedPrintCode = codigo;
            
            const codigoSalvo = getPrintCode(currentPrintEventData);
            existingConferenteName = getConferenteNameFromCode(codigoSalvo);
            
            if (existingConferenteName) {
                document.getElementById('conferenteExistente').style.display = 'block';
                document.getElementById('conferenteNovo').style.display = 'none';
                document.getElementById('nomeConferenteExistente').textContent = existingConferenteName;
            } else {
                document.getElementById('conferenteExistente').style.display = 'none';
                document.getElementById('conferenteNovo').style.display = 'block';
                document.getElementById('codeDisplay').textContent = codigo;
                document.getElementById('codeInput').value = '';
                document.getElementById('conferenteName').value = '';
            }
            
            document.getElementById('codeModal').style.display = 'flex';
            if (!existingConferenteName) {
                setTimeout(() => document.getElementById('codeInput').focus(), 100);
            }
        }
        
        async function verifyPrintCode() {
            const inputCode = document.getElementById('codeInput').value.trim();
            const conferenteName = document.getElementById('conferenteName').value.trim();
            
            if (inputCode !== generatedPrintCode) {
                showNotification('‚ùå C√≥digo incorreto', 'error');
                return;
            }
            
            if (!conferenteName) {
                showNotification('‚ùå Digite o nome de quem conferiu o pagamento', 'error');
                return;
            }
            
            showLoading('Salvando c√≥digo e nome...');
            
            const codigoComNome = `${generatedPrintCode} - ${conferenteName}`;
            
            // Verificar linha atual antes de salvar
            const event = allEvents.find(e => e.rowNumber === currentRowNumber);
            if (!event) {
                showNotification('‚ùå Pedido n√£o encontrado. Atualize a p√°gina.', 'error');
                hideLoading();
                return;
            }
            
            const orderNumber = getOrderNumber(event.data);
            
            const payload = {
                senha: '562938',
                linha: currentRowNumber,
                numero_pedido: orderNumber,
                tipo: 'imprimir',
                codigo: codigoComNome
            };
            
            console.log('Enviando c√≥digo de impress√£o com nome:', payload);
            const result = await saveToSpreadsheet(payload);
            
            if (result.success) {
                showNotification('‚úÖ Impress√£o confirmada!', 'success');
                
                // ============= CORRE√á√ÉO: Usar impress√£o isolada =============
                const codigo = extractCodeFromColunaA(currentPrintEventData[0] || '');
                const printHTML = generateFichaHTML(currentPrintEventData, codigo);
                
                printIsolatedContent(printHTML).then(() => {
                    closePrintModal();
                    closeCodeModal();
                    setTimeout(() => {
                        fetchData();
                    }, 500);
                });
                
            } else {
                showNotification('‚ùå ' + result.message, 'error');
            }
            
            hideLoading();
        }
        
        async function verifyExistingPrintCode() {
            showLoading('Imprimindo ficha...');
            
            const codigo = extractCodeFromColunaA(currentPrintEventData[0] || '');
            const printHTML = generateFichaHTML(currentPrintEventData, codigo);
            
            // ============= CORRE√á√ÉO: Usar impress√£o isolada =============
            printIsolatedContent(printHTML).then(() => {
                closeCodeModal();
                closePrintModal();
                showNotification('‚úÖ Ficha reimpressa!', 'success');
                hideLoading();
            });
        }
        
        function closeCodeModal() {
            document.getElementById('codeModal').style.display = 'none';
        }
        
        function closePrintModal() {
            document.getElementById('printModal').style.display = 'none';
        }
        
        // ============= FUN√á√ÉO printA4Page ATUALIZADA =============
        function printA4Page() {
            // Esta fun√ß√£o agora √© mantida para compatibilidade
            // A impress√£o real √© feita pela fun√ß√£o printIsolatedContent
            const codigo = extractCodeFromColunaA(currentPrintEventData[0] || '');
            const printHTML = generateFichaHTML(currentPrintEventData, codigo);
            printIsolatedContent(printHTML);
        }
        
        // Fun√ß√µes de a√ß√£o (montador/entregador)
        function startAction(rowNumber, actionType) {
            currentRowNumber = rowNumber;
            currentActionType = actionType;
            
            const title = document.getElementById('confirmationTitle');
            const message = document.getElementById('confirmationMessage');
            const timeContainer = document.getElementById('timeInputContainer');
            
            switch(actionType) {
                case 'montador':
                    title.textContent = 'üë∑ Confirmar Montagem';
                    message.textContent = 'Digite seu nome e hor√°rio:';
                    timeContainer.style.display = 'block';
                    document.getElementById('timeInput').value = '';
                    document.getElementById('minuteInput').value = '';
                    break;
                case 'entregador':
                    title.textContent = 'üöö Confirmar Entrega';
                    message.textContent = 'Digite seu nome para confirmar a entrega:';
                    timeContainer.style.display = 'none';
                    break;
                case 'desfazer_montador':
                    title.textContent = '‚Ü©Ô∏è Desfazer Montagem';
                    message.textContent = 'Digite seu nome para confirmar que deseja desfazer a montagem:';
                    timeContainer.style.display = 'none';
                    break;
                case 'desfazer_entregador':
                    title.textContent = '‚Ü©Ô∏è Desfazer Entrega';
                    message.textContent = 'Digite seu nome para confirmar que deseja desfazer a entrega:';
                    timeContainer.style.display = 'none';
                    break;
            }
            
            document.getElementById('completerName').value = '';
            document.getElementById('confirmationModal').style.display = 'flex';
            setTimeout(() => document.getElementById('completerName').focus(), 100);
        }
        
        async function confirmCompletion() {
            const name = document.getElementById('completerName').value.trim();
            if (!name) {
                showNotification('‚ùå Digite seu nome', 'error');
                return;
            }
            
            let horaMontador = '';
            if (currentActionType === 'montador') {
                const hora = document.getElementById('timeInput').value.trim();
                const minuto = document.getElementById('minuteInput').value.trim();
                
                if (!hora || !minuto) {
                    showNotification('‚ùå Hor√°rio √© OBRIGAT√ìRIO para montador', 'error');
                    return;
                }
                
                const horaNum = parseInt(hora, 10);
                const minutoNum = parseInt(minuto, 10);
                
                if (isNaN(horaNum) || horaNum < 0 || horaNum > 23) {
                    showNotification('‚ùå Hora inv√°lida. Use valores entre 00 e 23', 'error');
                    return;
                }
                
                if (isNaN(minutoNum) || minutoNum < 0 || minutoNum > 59) {
                    showNotification('‚ùå Minuto inv√°lido. Use valores entre 00 e 59', 'error');
                    return;
                }
                
                horaMontador = `${hora.padStart(2, '0')}:${minuto.padStart(2, '0')}`;
            }
            
            showLoading('Salvando...');
            
            // Verificar linha atual
            const event = allEvents.find(e => e.rowNumber === currentRowNumber);
            if (!event) {
                showNotification('‚ùå Pedido n√£o encontrado. Atualize a p√°gina.', 'error');
                hideLoading();
                return;
            }
            
            const orderNumber = getOrderNumber(event.data);
            
            const payload = {
                senha: '562938',
                linha: currentRowNumber,
                numero_pedido: orderNumber
            };
            
            switch(currentActionType) {
                case 'montador':
                    payload.tipo = 'montador';
                    payload.montador = `${name} - ${horaMontador}`;
                    break;
                case 'entregador':
                    payload.tipo = 'entregador';
                    payload.entregador = name;
                    break;
                case 'desfazer_montador':
                    payload.tipo = 'montador';
                    payload.montador = '';
                    break;
                case 'desfazer_entregador':
                    payload.tipo = 'entregador';
                    payload.entregador = '';
                    break;
            }
            
            console.log('Enviando dados de a√ß√£o:', payload);
            const result = await saveToSpreadsheet(payload);
            
            if (result.success) {
                showNotification('‚úÖ A√ß√£o salva com sucesso!', 'success');
                setTimeout(() => {
                    fetchData();
                }, 1000);
            } else {
                showNotification('‚ùå ' + result.message, 'error');
            }
            
            hideLoading();
            document.getElementById('confirmationModal').style.display = 'none';
        }
        
        function cancelCompletion() {
            document.getElementById('confirmationModal').style.display = 'none';
        }
        
        // =================== FUN√á√ïES DO MODAL DE EDI√á√ÉO ===================
        function openEditModal(rowNumber) {
            const event = allEvents.find(e => e.rowNumber === rowNumber);
            if (!event) {
                showNotification('‚ùå Evento n√£o encontrado', 'error');
                return;
            }
            
            currentRowNumber = rowNumber;
            currentEventDataForEdit = event.data;
            isCancelMode = false; // Resetar modo cancelamento
            
            const orderNumber = getOrderNumber(event.data);
            document.getElementById('editOrderNumber').textContent = orderNumber || rowNumber;
            
            document.getElementById('editUserName').value = '';
            document.getElementById('editUserPassword').value = '';
            document.getElementById('cancelReasonSelect').value = '';
            
            // Esconder se√ß√£o de cancelamento
            document.getElementById('cancelSection').classList.remove('active');
            document.getElementById('cancelPedidoBtn').innerHTML = '‚ùå Cancelar Pedido';
            
            populateEditForm(event.data);
            
            document.getElementById('editModal').style.display = 'flex';
            setTimeout(() => document.getElementById('editUserName').focus(), 100);
        }
        
        // NOVA FUN√á√ÉO: Alternar se√ß√£o de cancelamento
        function toggleCancelSection() {
            const cancelSection = document.getElementById('cancelSection');
            const cancelBtn = document.getElementById('cancelPedidoBtn');
            
            if (isCancelMode) {
                // Sair do modo cancelamento
                cancelSection.classList.remove('active');
                cancelBtn.innerHTML = '‚ùå Cancelar Pedido';
                isCancelMode = false;
                
                // Restaurar valores originais
                populateEditForm(currentEventDataForEdit);
            } else {
                // Entrar no modo cancelamento
                cancelSection.classList.add('active');
                cancelBtn.innerHTML = '‚Ü©Ô∏è Voltar √† Edi√ß√£o';
                isCancelMode = true;
                
                // Aplicar valores de cancelamento
                applyCancelValues();
            }
        }
        
        // NOVA FUN√á√ÉO: Aplicar valores de cancelamento nos campos
        function applyCancelValues() {
            const cancelReason = document.getElementById('cancelReasonSelect').value;
            
            if (cancelReason) {
                // Zerar valores de produto e frete
                const valorProdutoInput = document.querySelector('input[data-index="4"]');
                const valorFreteInput = document.querySelector('input[data-index="5"]');
                
                if (valorProdutoInput) valorProdutoInput.value = '0,00';
                if (valorFreteInput) valorFreteInput.value = '0,00';
                
                // Atualizar vendedor com motivo do cancelamento
                const vendedorInput = document.querySelector('input[data-index="6"]');
                if (vendedorInput) vendedorInput.value = cancelReason;
                
                // Atualizar entregador com motivo do cancelamento
                const entregadorInput = document.querySelector('select[data-index="43"]'); // Agora √© entregador
                if (entregadorInput) entregadorInput.value = cancelReason;
            }
        }
        
        function focusPasswordField() {
            const userName = document.getElementById('editUserName').value;
            if (userName) {
                setTimeout(() => document.getElementById('editUserPassword').focus(), 100);
            }
        }
        
        function populateEditForm(eventData) {
            const formContainer = document.getElementById('editFormFields');
            const orderNumber = getOrderNumber(eventData);
            
            // Separar data e dia da semana
            const dataCompleta = eventData[15] || '';
            const partes = dataCompleta.split(' - ');
            const data = partes[0] || dataCompleta;
            const diaSemana = getDiaSemana(data);
            
            const editableFields = [
                { 
                    index: 0, 
                    label: 'C√≥digo (A) - N√ÉO EDIT√ÅVEL', 
                    value: eventData[0] || '', 
                    editable: false,
                    type: 'text'
                },
                {
                    index: 52,
                    label: 'N√∫mero do Pedido (BA) - N√ÉO EDIT√ÅVEL',
                    value: orderNumber || '',
                    editable: false,
                    type: 'text'
                },
                { 
                    index: 1, 
                    label: 'Nome do Cliente', 
                    value: eventData[1] || '', 
                    editable: true,
                    type: 'text',
                    required: true
                },
                { 
                    index: 2, 
                    label: 'Telefone Cliente', 
                    value: eventData[2] || '', 
                    editable: true,
                    type: 'text'
                },
                { 
                    index: 3, 
                    label: 'Produto/Descri√ß√£o', 
                    value: eventData[3] || '', 
                    editable: true,
                    type: 'text',
                    required: true
                },
                { 
                    index: 4, 
                    label: 'Valor Produto (R$)', 
                    value: eventData[4] || '', 
                    editable: true,
                    type: 'text'
                },
                { 
                    index: 5, 
                    label: 'Frete (R$)', 
                    value: eventData[5] || '', 
                    editable: true,
                    type: 'text'
                },
                { 
                    index: 6, 
                    label: 'Vendedor', 
                    value: eventData[6] || '', 
                    editable: true,
                    type: 'text'
                },
                { 
                    index: 8, 
                    label: 'Quem Vai Receber', 
                    value: eventData[8] || '', 
                    editable: true,
                    type: 'text',
                    required: true
                },
                { 
                    index: 9, 
                    label: 'Telefone Recebedor', 
                    value: eventData[9] || '', 
                    editable: true,
                    type: 'text'
                },
                { 
                    index: 10, 
                    label: 'Endere√ßo', 
                    value: eventData[10] || '', 
                    editable: true,
                    type: 'text',
                    required: true
                },
                { 
                    index: 11, 
                    label: 'N√∫mero/Complemento', 
                    value: eventData[11] || '', 
                    editable: true,
                    type: 'text'
                },
                { 
                    index: 12, 
                    label: 'Bairro', 
                    value: eventData[12] || '', 
                    editable: true,
                    type: 'text',
                    required: true
                },
                { 
                    index: 13, 
                    label: 'Cidade', 
                    value: eventData[13] || '', 
                    editable: true,
                    type: 'text',
                    required: true
                },
                { 
                    index: 14, 
                    label: 'Refer√™ncia Endere√ßo', 
                    value: eventData[14] || '', 
                    editable: true,
                    type: 'text'
                },
                { 
                    index: 15, 
                    label: 'Data Entrega (DD/MM/YYYY)', 
                    value: data, // Apenas a data, sem dia da semana
                    editable: true,
                    type: 'text',
                    required: true
                },
                { 
                    index: 'dia_semana', // Campo especial para dia da semana
                    label: 'Dia da Semana (Autom√°tico)', 
                    value: diaSemana || '', 
                    editable: false,
                    type: 'text'
                },
                { 
                    index: 16, 
                    label: 'Hor√°rio Entrega', 
                    value: eventData[16] || '', 
                    editable: true,
                    type: 'text',
                    required: true
                },
                { 
                    index: 17, 
                    label: 'Cart√£o (S/N)', 
                    value: eventData[17] || '', 
                    editable: true,
                    type: 'select',
                    options: ['', 'Sim', 'N√£o'],
                    required: true
                },
                { 
                    index: 18, 
                    label: 'Mensagem do Cart√£o', 
                    value: eventData[18] || '', 
                    editable: true,
                    type: 'textarea',
                    rows: 4
                },
                { 
                    index: 32, 
                    label: 'Forma Pagamento', 
                    value: eventData[32] || '', 
                    editable: true,
                    type: 'text'
                },
                { 
                    index: 43, 
                    label: 'Entregador (ex-Vendedor do Cancelamento)', 
                    value: eventData[43] || '', 
                    editable: true,
                    type: 'text'
                },
                { 
                    index: 48, 
                    label: 'An√¥nimo', 
                    value: eventData[48] || '', 
                    editable: true,
                    type: 'select',
                    options: ['', 'Sim', 'N√£o']
                },
                { 
                    index: 49, 
                    label: 'Explica√ß√£o An√¥nimo', 
                    value: eventData[49] || '', 
                    editable: true,
                    type: 'text'
                },
                { 
                    index: 50, 
                    label: 'Cupom/Ifood', 
                    value: eventData[50] || '', 
                    editable: true,
                    type: 'text'
                },
                { 
                    index: 55, 
                    label: 'Informa√ß√µes Outra Cidade (BD)', 
                    value: eventData[55] || '', 
                    editable: true,
                    type: 'textarea',
                    rows: 3
                }
            ];
            
            let formHTML = '';
            
            editableFields.forEach(field => {
                if (!field.editable) {
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">${field.label}:</label>
                            <input class="form-input" data-index="${field.index}" type="text" value="${field.value}" readonly style="background-color: #f5f5f5; color: #666;" />
                        </div>
                    `;
                } else if (field.type === 'select') {
                    let optionsHTML = '';
                    field.options.forEach(option => {
                        const selected = option === field.value ? 'selected' : '';
                        optionsHTML += `<option value="${option}" ${selected}>${option || 'Selecione...'}</option>`;
                    });
                    
                    const requiredAttr = field.required ? 'required' : '';
                    
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">${field.label}:${field.required ? ' *' : ''}</label>
                            <select class="form-select" data-index="${field.index}" ${requiredAttr}>
                                ${optionsHTML}
                            </select>
                        </div>
                    `;
                } else if (field.type === 'textarea') {
                    const rows = field.rows || 4;
                    const requiredAttr = field.required ? 'required' : '';
                    
                    formHTML += `
                        <div class="form-group${field.index === 18 || field.index === 55 ? ' form-group-full-width' : ''}">
                            <label class="form-label">${field.label}:${field.required ? ' *' : ''}</label>
                            <textarea class="form-textarea" data-index="${field.index}" rows="${rows}" ${requiredAttr}>${field.value}</textarea>
                        </div>
                    `;
                } else if (field.index === 15) {
                    const requiredAttr = field.required ? 'required' : '';
                    
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">${field.label}:${field.required ? ' *' : ''}</label>
                            <input class="form-input" data-index="${field.index}" type="text" value="${field.value}" 
                                   onchange="updateDiaSemanaEdit(this)" placeholder="DD/MM/YYYY" ${requiredAttr} />
                        </div>
                    `;
                } else {
                    const requiredAttr = field.required ? 'required' : '';
                    
                    formHTML += `
                        <div class="form-group">
                            <label class="form-label">${field.label}:${field.required ? ' *' : ''}</label>
                            <input class="form-input" data-index="${field.index}" type="${field.type}" 
                                   value="${field.value}" ${requiredAttr} />
                        </div>
                    `;
                }
            });
            
            formContainer.innerHTML = formHTML;
            
            // Adicionar campo de dia da semana separado
            const dataField = document.querySelector('input[data-index="15"]');
            if (dataField && dataField.parentElement) {
                const diaSemanaDiv = document.createElement('div');
                diaSemanaDiv.className = 'form-group';
                diaSemanaDiv.innerHTML = `
                    <label class="form-label">Dia da Semana (Autom√°tico):</label>
                    <input class="form-input" id="editDiaSemana" type="text" value="${diaSemana}" readonly style="background-color: #f5f5f5; color: #666;" />
                `;
                dataField.parentElement.parentElement.insertBefore(diaSemanaDiv, dataField.parentElement.nextSibling);
            }
            
            // Atualizar dia da semana inicial
            if (data) {
                updateDiaSemanaEdit(dataField);
            }
            
            // Adicionar listener para motivo de cancelamento
            document.getElementById('cancelReasonSelect').addEventListener('change', function() {
                if (isCancelMode) {
                    applyCancelValues();
                }
            });
        }
        
        // FUN√á√ÉO PARA ATUALIZAR DIA DA SEMANA NO MODO EDI√á√ÉO
        function updateDiaSemanaEdit(input) {
            const value = input.value;
            const diaSemana = getDiaSemana(value);
            const diaSemanaInput = document.getElementById('editDiaSemana');
            
            if (diaSemanaInput) {
                diaSemanaInput.value = diaSemana || '';
            }
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            isCancelMode = false;
        }
        
        // FUN√á√ÉO PRINCIPAL DE SALVAR EDI√á√ïES (COM SUPORTE PARA CANCELAMENTO)
        async function saveEdits() {
            const userName = document.getElementById('editUserName').value;
            const userPassword = document.getElementById('editUserPassword').value.trim();
            
            if (!userName) {
                showNotification('‚ùå Selecione seu nome', 'error');
                return;
            }
            
            if (!userPassword) {
                showNotification('‚ùå Digite sua senha', 'error');
                return;
            }
            
            if (!AUTHORIZED_USERS[userName] || AUTHORIZED_USERS[userName] !== userPassword) {
                showNotification('‚ùå Senha incorreta', 'error');
                return;
            }
            
            showLoading('Salvando altera√ß√µes...');
            
            const inputs = document.querySelectorAll('#editFormFields .form-input, #editFormFields .form-textarea, #editFormFields .form-select');
            const updates = {};
            
            // Verificar se est√° no modo cancelamento
            const cancelReason = document.getElementById('cancelReasonSelect').value;
            const isCancelling = isCancelMode && cancelReason;
            
            // Coletar valor do dia da semana
            const diaSemanaInput = document.getElementById('editDiaSemana');
            const diaSemana = diaSemanaInput ? diaSemanaInput.value : '';
            
            inputs.forEach(input => {
                const index = parseInt(input.getAttribute('data-index'));
                const originalValue = currentEventDataForEdit[index] || '';
                let newValue = '';
                
                if (input.tagName === 'SELECT') {
                    newValue = input.value;
                } else if (input.tagName === 'TEXTAREA') {
                    newValue = input.value;
                } else {
                    newValue = input.value.trim();
                }
                
                if (input.hasAttribute('readonly')) {
                    return;
                }
                
                // Se for o campo de data (15), adicionar dia da semana
                if (index === 15 && newValue && diaSemana) {
                    newValue = `${newValue} - ${diaSemana}`;
                }
                
                // Se estiver cancelando, garantir que valores sejam zerados
                if (isCancelling) {
                    if (index === 4 || index === 5) { // Valor produto e frete
                        newValue = '0,00';
                    }
                    if (index === 6 || index === 43) { // Vendedor e entregador
                        newValue = cancelReason;
                    }
                }
                
                if (originalValue !== newValue) {
                    updates[index] = newValue;
                    console.log(`Campo ${index} alterado: "${originalValue}" -> "${newValue}"`);
                }
            });
            
            if (Object.keys(updates).length === 0) {
                showNotification('‚ö†Ô∏è Nenhuma altera√ß√£o foi feita', 'info');
                hideLoading();
                closeEditModal();
                return;
            }
            
            // Criar registro de hist√≥rico de edi√ß√µes
            const editRecord = updateEditHistory(updates, userName);
            const now = new Date();
            const lastEdit = `${now.toLocaleDateString('pt-BR')} ${now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})} - ${userName}`;
            
            const orderNumber = getOrderNumber(currentEventDataForEdit);
            const payload = {
                senha: '562938',
                linha: currentRowNumber,
                tipo: 'editar',
                atualizacoes: updates,
                editor: userName,
                numero_pedido: orderNumber,
                edit_history: editRecord,
                last_edit: lastEdit
            };
            
            // Adicionar motivo do cancelamento se aplic√°vel
            if (isCancelling) {
                payload.motivo_cancelamento = cancelReason;
            }
            
            console.log('Enviando atualiza√ß√µes:', payload);
            
            try {
                const formData = new FormData();
                formData.append('senha', '562938');
                formData.append('linha', currentRowNumber);
                formData.append('tipo', 'editar');
                formData.append('editor', userName);
                formData.append('numero_pedido', orderNumber || '');
                formData.append('atualizacoes', JSON.stringify(updates));
                formData.append('edit_history', editRecord);
                formData.append('last_edit', lastEdit);
                
                if (isCancelling) {
                    formData.append('motivo_cancelamento', cancelReason);
                }
                
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                });
                
                if (isCancelling) {
                    showNotification('‚úÖ Pedido cancelado com sucesso!', 'success');
                } else {
                    showNotification('‚úÖ Altera√ß√µes salvas com sucesso!', 'success');
                }
                
                // Atualizar dados locais
                Object.keys(updates).forEach(index => {
                    if (currentEventDataForEdit) {
                        currentEventDataForEdit[index] = updates[index];
                    }
                });
                
                const eventIndex = allEvents.findIndex(e => e.rowNumber === currentRowNumber);
                if (eventIndex !== -1) {
                    Object.keys(updates).forEach(index => {
                        allEvents[eventIndex].data[index] = updates[index];
                    });
                    
                    // Atualizar hist√≥rico
                    allEvents[eventIndex].data[55] = editRecord;
                    allEvents[eventIndex].data[56] = lastEdit;
                }
                
                applyCurrentFilter();
                
                setTimeout(() => {
                    closeEditModal();
                }, 1000);
                
            } catch (error) {
                console.error('Erro ao salvar edi√ß√µes:', error);
                showNotification('‚ö†Ô∏è Erro ao salvar. Tente novamente.', 'error');
            }
            
            hideLoading();
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar dados
            fetchData();
            
            // Configurar atualiza√ß√£o autom√°tica
            refreshInterval = setInterval(fetchData, autoRefreshTime);
            
            // Configurar progresso do bot√£o de refresh
            setInterval(updateRefreshProgress, 1000);
            
            // Configurar verifica√ß√£o de pedidos atrasados a cada 30 segundos
            alertCheckInterval = setInterval(checkForLateOrders, 30000);
            
            // Configurar modais
            const modals = ['printModal', 'itemsModal', 'codeModal', 'confirmationModal', 'editModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            if (modalId !== 'editModal') {
                                modal.style.display = 'none';
                            }
                        }
                    });
                }
            });
            
            // Configurar busca com Enter
            document.getElementById('searchInput').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal-overlay, .edit-modal-overlay');
                    modals.forEach(modal => {
                        if (modal.id !== 'editModal' || !isCancelMode) {
                            modal.style.display = 'none';
                        }
                    });
                }
            });
            
            // Inicializar √∫ltimo contador de eventos
            lastEventCount = 0;
        });
        
        // Tornar fun√ß√µes globais
        window.openPrintModal = openPrintModal;
        window.openItemsModal = openItemsModal;
        window.saveAndPrintItems = saveAndPrintItems;
        window.closeItemsModal = closeItemsModal;
        window.startAction = startAction;
        window.confirmCompletion = confirmCompletion;
        window.cancelCompletion = cancelCompletion;
        window.requestPrintCode = requestPrintCode;
        window.verifyPrintCode = verifyPrintCode;
        window.verifyExistingPrintCode = verifyExistingPrintCode;
        window.closeCodeModal = closeCodeModal;
        window.closePrintModal = closePrintModal;
        window.printA4Page = printA4Page;
        window.filterToday = filterToday;
        window.filterTomorrow = filterTomorrow;
        window.filterNextSunday = filterNextSunday;
        window.filterByDate = filterByDate;
        window.filterUnprinted = filterUnprinted;
        window.refreshData = refreshData;
        window.increaseFontSize = increaseFontSize;
        window.decreaseFontSize = decreaseFontSize;
        window.increaseRecipientFontSize = increaseRecipientFontSize;
        window.decreaseRecipientFontSize = decreaseRecipientFontSize;
        window.copyCartText = copyCartText;
        window.updatePrintPreview = updatePrintPreview;
        window.validateItemsCount = validateItemsCount;
        window.openEditModal = openEditModal;
        window.closeEditModal = closeEditModal;
        window.saveEdits = saveEdits;
        window.focusPasswordField = focusPasswordField;
        window.updateDiaSemanaEdit = updateDiaSemanaEdit;
        window.performSearch = performSearch;
        window.toggleCancelSection = toggleCancelSection;
    </script>
</body>
</html>

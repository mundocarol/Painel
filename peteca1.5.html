<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petecando 2025</title>
    <meta name="theme-color" content="#2575fc">
    <meta name="description" content="Sistema de gerenciamento para torneios de peteca">
    <link rel="manifest" href="manifest.json">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
        }
        
        .app-by {
            font-size: 0.9rem;
            font-style: italic;
            margin-top: 5px;
        }
        
        .panels {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .panel {
            flex: 1;
            min-width: 300px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .panel h2 {
            color: #2575fc;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f2f5;
            font-size: 1.2rem;
        }
        
        .input-group {
            display: flex;
            margin-bottom: 12px;
        }
        
        input[type="text"], input[type="password"], select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        button {
            padding: 10px 15px;
            background: #2575fc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #1a65e0;
        }
        
        .btn-add {
            border-radius: 0 5px 5px 0;
        }
        
        .btn-start {
            background: #2ed573;
            width: 100%;
            margin-top: 8px;
        }
        
        .btn-start:hover {
            background: #25c768;
        }
        
        .btn-start:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .player-list {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 8px;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 8px;
        }
        
        .player-list li {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }
        
        .player-list li:hover {
            background-color: #f9f9f9;
        }
        
        .player-list li:last-child {
            border-bottom: none;
        }
        
        .player-list button {
            padding: 4px 8px;
            background: #ff4757;
            font-size: 0.8rem;
        }
        
        .player-list button:hover {
            background: #ff3745;
        }
        
        .teams-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (min-width: 768px) {
            .teams-container {
                flex-direction: row;
            }
        }
        
        .team {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            background: #f8f9fa;
            text-align: center;
            position: relative;
        }
        
        .team h3 {
            margin-bottom: 12px;
            color: #2575fc;
            font-size: 1.1rem;
        }
        
        .team-score {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #2575fc;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .team-members {
            min-height: 100px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            margin-bottom: 12px;
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .team-player {
            padding: 8px;
            background: #f0f2f5;
            border-radius: 4px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .team-player.winner {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .player-points-buttons {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .btn-point-small {
            padding: 5px 8px;
            font-size: 0.8rem;
            background: #2ed573;
            min-width: 60px;
        }
        
        .consecutive-wins {
            font-size: 0.8rem;
            color: #ff6b6b;
            margin-top: 5px;
            font-weight: bold;
        }
        
        .btn-victory {
            width: 100%;
            margin-top: 8px;
            background: #2ed573;
        }
        
        .btn-victory:hover {
            background: #25c768;
        }
        
        .waiting-list {
            padding: 12px;
            background: #e9ecef;
            border-radius: 8px;
            margin-top: 15px;
            min-height: 100px;
        }
        
        .waiting-list h3 {
            color: #2575fc;
            margin-bottom: 8px;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 0.9rem;
        }
        
        .stats-table th, .stats-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .stats-table th {
            background-color: #2575fc;
            color: white;
        }
        
        .stats-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .player-removed {
            color: #ff4757;
            font-style: italic;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        
        @media (min-width: 480px) {
            .action-buttons {
                flex-direction: row;
            }
        }
        
        .btn-reset {
            background: #ff4757;
        }
        
        .btn-reset:hover {
            background: #ff3745;
        }
        
        .btn-share {
            background: #25d366;
            margin-top: 12px;
            display: block;
            width: 100%;
        }
        
        .btn-share:hover {
            background: #20bd5c;
        }
        
        .instructions-toggle {
            background: #fff4e6;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #ffa502;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .instructions-toggle h3 {
            color: #ffa502;
            margin: 0;
            font-size: 1rem;
        }
        
        .instructions-content {
            display: none;
            background: #fff4e6;
            padding: 0 15px 15px 15px;
            border-radius: 0 0 8px 8px;
            margin-top: -10px;
            border-left: 4px solid #ffa502;
        }
        
        .instructions-content ol {
            margin-left: 20px;
            padding-top: 10px;
            margin-bottom: 10px;
        }
        
        .instructions-content li {
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .consecutive-info {
            background: #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            display: none;
        }
        
        .password-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 300px;
            max-width: 90%;
        }
        
        .password-dialog h3 {
            margin-bottom: 15px;
            color: #2575fc;
        }
        
        .password-dialog button {
            margin-top: 10px;
            width: 100%;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .toggle-icon {
            transition: transform 0.3s;
        }
        
        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
        
        .tournament-status {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .status-playing {
            color: #2e7d32;
        }
        
        .status-waiting {
            color: #ed6c02;
        }
        
        .match-panel {
            background: #e9ecef !important;
            border-left: 4px solid #2575fc;
        }
        
        @media (max-width: 768px) {
            .stats-table th:nth-child(5),
            .stats-table td:nth-child(5) {
                display: none;
            }
            
            .stats-table th, .stats-table td {
                padding: 8px 5px;
                font-size: 0.85rem;
            }
        }
        
        .match-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-back {
            background: #ffa502;
            font-size: 0.8rem;
            padding: 5px 10px;
        }
        
        .btn-back:hover {
            background: #e59400;
        }
        
        .btn-forward {
            background: #2ed573;
            font-size: 0.8rem;
            padding: 5px 10px;
        }
        
        .btn-forward:hover {
            background: #25c768;
        }
        
        .waiting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .swap-panel {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px dashed #2575fc;
        }
        
        .swap-panel h3 {
            color: #2575fc;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .swap-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        @media (min-width: 480px) {
            .swap-controls {
                flex-direction: row;
                align-items: center;
            }
        }
        
        .swap-select {
            flex: 1;
        }
        
        .swap-icon {
            font-size: 1.5rem;
            text-align: center;
            padding: 0 10px;
        }
        
        .btn-swap {
            background: #ffa502;
        }
        
        .btn-swap:hover {
            background: #e59400;
        }
        
        .position-cell {
            font-weight: bold;
            width: 40px;
            text-align: center;
        }
        
        .first-place {
            background-color: #FFD700 !important;
            color: #000;
            font-weight: bold;
        }
        
        .second-place {
            background-color: #C0C0C0 !important;
            color: #000;
            font-weight: bold;
        }
        
        .third-place {
            background-color: #CD7F32 !important;
            color: #000;
            font-weight: bold;
        }
        
        .ranking-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 8px;
            font-weight: bold;
        }
        
        .first-badge {
            background-color: #FFD700;
            color: #000;
        }
        
        .second-badge {
            background-color: #C0C0C0;
            color: #000;
        }
        
        .third-badge {
            background-color: #CD7F32;
            color: #000;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #2575fc;
            overflow-x: auto;
        }
        
        .tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
            white-space: nowrap;
        }
        
        .tab.active {
            background: #2575fc;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        #installButton {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #25d366;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            cursor: pointer;
        }

        #installButton:hover {
            background: #20bd5c;
        }
        
        .games-tab header {
            display: none;
        }
        
        .stats-row {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .stats-position {
            font-weight: bold;
            width: 40px;
            text-align: center;
            margin-right: 10px;
        }
        
        .stats-player {
            flex: 1;
        }
        
        .stats-numbers {
            display: flex;
            gap: 15px;
        }
        
        .stats-wins {
            color: #2e7d32;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }
        
        .stats-losses {
            color: #d32f2f;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }
        
        .stats-percent {
            color: #2575fc;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }
        
        .stats-emoji {
            margin-left: 10px;
            font-size: 1.2rem;
        }
        
        .victory-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 320px;
            max-width: 90%;
            text-align: center;
        }
        
        .victory-dialog h3 {
            color: #2575fc;
            margin-bottom: 15px;
        }
        
        .victory-dialog p {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        .victory-dialog-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        .victory-dialog-buttons button {
            flex: 1;
        }
        
        .btn-confirm {
            background: #2ed573;
        }
        
        .btn-confirm:hover {
            background: #25c768;
        }
        
        .btn-cancel {
            background: #ff4757;
        }
        
        .btn-cancel:hover {
            background: #ff3745;
        }
        
        .team-stats-panel {
            margin-top: 20px;
        }
        
        .btn-export {
            background: #9c27b0;
            margin-top: 12px;
            display: block;
            width: 100%;
        }
        
        .btn-export:hover {
            background: #7b1fa2;
        }
        
        .btn-sorteio {
            background: #9c27b0;
            margin-top: 8px;
            width: 100%;
        }
        
        .btn-sorteio:hover {
            background: #7b1fa2;
        }
        
        .consecutive-individual {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .player-coringa {
            background-color: #ffeb3b !important;
            border: 1px solid #ffc107;
        }
        
        .points-stats-panel {
            margin-top: 20px;
        }
        
        .points-stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .points-stats-table th, .points-stats-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .points-stats-table th {
            background-color: #9c27b0;
            color: white;
        }
        
        .points-stats-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .player-name {
            flex: 1;
            text-align: center;
            font-weight: bold;
        }
        
        .confrontos-container {
            margin-top: 15px;
        }
        
        .confronto-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .confronto-teams {
            flex: 1;
        }
        
        .confronto-result {
            font-weight: bold;
            color: #2575fc;
        }
        
        .coringa-substitute {
            font-size: 0.8rem;
            color: #9c27b0;
            font-style: italic;
            margin-left: 5px;
        }
        
        .simple-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 320px;
            max-width: 90%;
            text-align: center;
        }
        
        .simple-dialog h3 {
            color: #2575fc;
            margin-bottom: 15px;
        }
        
        .simple-dialog p {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        
        .simple-dialog-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        .simple-dialog-buttons button {
            flex: 1;
        }
        
        .purchases-panel {
            margin-top: 20px;
        }
        
        .purchase-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .purchase-inputs {
            display: flex;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .purchase-inputs {
                flex-direction: column;
            }
        }
        
        .purchase-item {
            flex: 2;
        }
        
        .purchase-price {
            flex: 1;
        }
        
        .purchases-list {
            margin-top: 15px;
        }
        
        .purchase-item-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #9c27b0;
        }
        
        .purchase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .purchase-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
        }
        
        .purchase-price-tag {
            background: #9c27b0;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .purchase-players {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .player-purchase-btn {
            background: #e9ecef;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 5px 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .player-purchase-btn:hover {
            background: #dee2e6;
        }
        
        .player-purchase-btn.selected {
            background: #9c27b0;
            color: white;
            border-color: #9c27b0;
        }
        
        .purchase-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-remove-purchase {
            background: #ff4757;
            font-size: 0.8rem;
            padding: 5px 10px;
        }
        
        .purchases-summary {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
        }
        
        .player-total {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .player-total:last-child {
            border-bottom: none;
        }
        
        .total-amount {
            font-weight: bold;
            color: #9c27b0;
        }
        
        .grand-total {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #9c27b0;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            justify-content: space-between;
        }
        
        .pix-info {
            margin-top: 15px;
            padding: 15px;
            background: #f0f8f0;
            border-radius: 8px;
            border-left: 4px solid #25d366;
            text-align: center;
        }
        
        .pix-email {
            font-weight: bold;
            font-size: 1.1rem;
            color: #25d366;
            margin: 10px 0;
        }
        
        .confraternizacao-text {
            font-style: italic;
            color: #666;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .purchase-items-list {
            margin-top: 10px;
        }
        
        .purchase-item-row {
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .purchase-item-row:hover {
            background-color: #f8f9fa;
        }
        
        .player-purchase-section {
            border-left: 4px solid #9c27b0;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .purchase-item-actions button {
            font-size: 0.7rem;
            padding: 3px 6px;
        }
        
        .btn-remove-purchase-small {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
        }
        
        .btn-remove-purchase-small:hover {
            background: #ff3745;
        }
    </style>
</head>
<body>
    <div class="container">
        <header id="mainHeader">
            <h1>Petecando 2025</h1>
            <div class="app-by">App by Hugo Ribeiro</div>
        </header>
        
        <div id="tournamentStatus" class="tournament-status status-waiting" style="display: none;">
            Torneio não iniciado
        </div>
        
        <!-- Sistema de Abas -->
        <div class="tabs">
            <div class="tab active" data-tab="edition">Edição</div>
            <div class="tab" data-tab="games">Jogos</div>
            <div class="tab" data-tab="results">Resultados</div>
            <div class="tab" data-tab="purchases">Compras</div>
        </div>
        
        <!-- Conteúdo da Aba 1 - Edição -->
        <div id="edition-tab" class="tab-content active">
            <div class="panels">
                <div class="panel">
                    <h2>Jogadores</h2>
                    <div class="input-group">
                        <input type="text" id="playerName" placeholder="Nome do jogador">
                        <button class="btn-add" onclick="addPlayer()">Adicionar</button>
                    </div>
                    <button class="btn-add" onclick="addCoringa()" style="margin-bottom: 10px; background: #9c27b0;">Adicionar CORINGA</button>
                    <ul id="playersList" class="player-list"></ul>
                    
                    <button id="startTournamentBtn" class="btn-start" onclick="startTournament()" disabled>Iniciar Torneio</button>
                    
                    <div class="swap-panel">
                        <h3>Trocar Jogadores</h3>
                        <div class="swap-controls">
                            <select id="swapPlayer1" class="swap-select">
                                <option value="">Selecione o primeiro jogador</option>
                            </select>
                            <div class="swap-icon">⇄</div>
                            <select id="swapPlayer2" class="swap-select">
                                <option value="">Selecione o segundo jogador</option>
                            </select>
                            <button class="btn-swap" onclick="showPasswordDialog('swap')">Trocar</button>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn-reset" onclick="showPasswordDialog('reset')">Reiniciar Torneio</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Conteúdo da Aba 2 - Jogos -->
        <div id="games-tab" class="tab-content">
            <div class="panels">
                <div class="panel match-panel">
                    <div class="match-title">
                        <h2 id="currentMatchTitle">Partida - 0</h2>
                        <div class="navigation-buttons">
                            <button id="backButton" class="btn-back" onclick="showSimpleDialog('back')" style="display: none;">Voltar</button>
                            <button id="forwardButton" class="btn-forward" onclick="showPasswordDialog('forward')" style="display: none;">Avançar</button>
                        </div>
                    </div>
                    <div id="consecutiveInfo" class="consecutive-info">
                        Dupla com 3 vitórias consecutivas! Os jogadores serão redistribuídos.
                    </div>
                    
                    <div class="teams-container">
                        <div class="team">
                            <h3>Dupla 1</h3>
                            <div class="team-score" id="team1Score">0</div>
                            <div id="team1" class="team-members">
                                <p>A definir</p>
                            </div>
                            <div id="team1Wins" class="consecutive-wins"></div>
                            <button class="btn-victory" onclick="confirmVictory(1)">Dupla 1 Venceu</button>
                            <button id="sorteioTeam1" class="btn-sorteio" onclick="realizarSorteio(1)" style="display: none;">Sorteio CORINGA</button>
                        </div>
                        
                        <div class="team">
                            <h3>Dupla 2</h3>
                            <div class="team-score" id="team2Score">0</div>
                            <div id="team2" class="team-members">
                                <p>A definir</p>
                            </div>
                            <div id="team2Wins" class="consecutive-wins"></div>
                            <button class="btn-victory" onclick="confirmVictory(2)">Dupla 2 Venceu</button>
                            <button id="sorteioTeam2" class="btn-sorteio" onclick="realizarSorteio(2)" style="display: none;">Sorteio CORINGA</button>
                        </div>
                    </div>
                    
                    <div class="waiting-list">
                        <div class="waiting-header">
                            <h3>Próximos da Fila</h3>
                        </div>
                        <div id="waitingPlayers">Nenhum jogador na espera</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Conteúdo da Aba 3 - Resultados -->
        <div id="results-tab" class="tab-content">
            <div class="panel">
                <h2>Relatório de Gastos</h2>
                <div id="purchasesSummaryResults">
                    <!-- O relatório de gastos será inserido aqui via JavaScript -->
                </div>
                <button class="btn-share" onclick="sharePurchasesResults()">Compartilhar Relatório de Gastos</button>
            </div>
            
            <div class="panel">
                <h2>Estatísticas Individuais</h2>
                <div id="modernStats">
                    <!-- As estatísticas modernas serão inseridas aqui via JavaScript -->
                </div>
                <button class="btn-share" onclick="shareResults()">Compartilhar Resultados</button>
            </div>
            
            <div class="panel points-stats-panel">
                <h2>Estatísticas de Pontos</h2>
                <div id="pointsStats">
                    <!-- As estatísticas de pontos serão inseridas aqui via JavaScript -->
                </div>
                <button class="btn-share" onclick="sharePointsResults()">Compartilhar Estatísticas de Pontos</button>
            </div>
            
            <div class="panel team-stats-panel">
                <h2>Relatório de Confrontos</h2>
                <div id="confrontosStats">
                    <!-- O relatório de confrontos será inserido aqui via JavaScript -->
                </div>
                <button class="btn-share" onclick="shareConfrontosResults()">Compartilhar Relatório de Confrontos</button>
            </div>
            
            <div class="panel">
                <h2>Exportar Dados</h2>
                <p>Exporte os dados completos do torneio para análise posterior:</p>
                <button class="btn-export" onclick="exportTournamentData()">Exportar Dados do Torneio</button>
            </div>
            
            <div class="instructions-toggle" onclick="toggleInstructions()">
                <h3>Medidas Oficiais e Como usar o sistema</h3>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="instructions-content" id="instructionsContent">
                <ol>
                    <li>Tamanho oficial quadra peteca 7,5 x 15 metros</li>
                    <li>Altura oficial rede - masc 2,43 - fem 2,24 - mirim 2,00</li>
                    <li>---------------------------------------------------</li>
                    <li>Adicione os nomes de todos os jogadores (mínimo 4)</li>
                    <li>Clique em "Iniciar Torneio" para começar a partida</li>
                    <li>Clique em "Dupla X Venceu" para registrar o resultado</li>
                    <li>Se uma dupla vencer 3 vezes seguidas, os jogadores serão redistribuídos</li>
                    <li>Você pode adicionar ou remover jogadores mesmo durante o torneio</li>
                    <li>Agora você pode trocar jogadores de posição usando o sistema de troca</li>
                    <li>Acompanhe as estatísticas na tabela e compartilhe os resultados</li>
                    <li>Adicione o CORINGA para sortear jogadores da fila de espera</li>
                    <li>Jogadores com 6 vitórias consecutivas serão substituídos automaticamente</li>
                    <li>Use o botão "Acertou X" para marcar pontos durante a partida</li>
                    <li>Na aba "Compras" registre itens vendidos aos jogadores</li>
                </ol>
            </div>
        </div>
        
        <!-- Conteúdo da Aba 4 - Compras -->
        <div id="purchases-tab" class="tab-content">
            <div class="panel">
                <h2>Registrar Compra</h2>
                <div class="purchase-form">
                    <div class="purchase-inputs">
                        <input type="text" id="purchaseItem" class="purchase-item" placeholder="Nome do item (ex: Água, Cerveja, Suco)">
                        <input type="number" id="purchasePrice" class="purchase-price" placeholder="Preço (R$)" min="0" step="0.01">
                    </div>
                    <div class="purchase-players" id="purchasePlayersButtons">
                        <!-- Botões dos jogadores serão inseridos aqui -->
                    </div>
                </div>
                
                <div class="purchases-list" id="purchasesList">
                    <!-- Itens de compra serão adicionados aqui -->
                </div>
            </div>
            
            <div class="panel purchases-summary">
                <h2>Resumo de Gastos</h2>
                <div id="purchasesSummary">
                    <!-- Resumo de gastos será adicionado aqui -->
                </div>
                
                <div class="pix-info">
                    <h3>Pagamento via PIX</h3>
                    <p>Envie o valor total para:</p>
                    <div class="pix-email">peteca.pix@gmail.com</div>
                    <p class="confraternizacao-text">Verba arrecadada para confraternizações</p>
                </div>
            </div>
        </div>
    </div>

    <button id="installButton" title="Instalar App">+</button>

    <div class="overlay" id="overlay"></div>
    <div class="password-dialog" id="passwordDialog">
        <h3 id="dialogTitle">Reiniciar Torneio</h3>
        <p id="dialogMessage">Digite a senha para reiniciar:</p>
        <input type="password" id="passwordInput" placeholder="Senha">
        <button onclick="checkPassword()">Confirmar</button>
        <button onclick="hidePasswordDialog()" style="background: #ff4757;">Cancelar</button>
    </div>

    <div class="password-dialog" id="removePlayerDialog">
        <h3>Remover Jogador</h3>
        <p>Digite a senha para remover <span id="playerToRemove"></span>:</p>
        <input type="password" id="removePasswordInput" placeholder="Senha">
        <button onclick="checkRemovePassword()">Confirmar</button>
        <button onclick="hideRemovePlayerDialog()" style="background: #ff4757;">Cancelar</button>
    </div>
    
    <div class="victory-dialog" id="victoryDialog">
        <h3 id="victoryDialogTitle">Confirmar Vitória</h3>
        <p id="victoryDialogMessage">A Dupla 1 venceu a partida?</p>
        <div class="victory-dialog-buttons">
            <button class="btn-cancel" onclick="hideVictoryDialog()">Cancelar</button>
            <button class="btn-confirm" onclick="confirmVictoryAction()">Confirmar</button>
        </div>
    </div>
    
    <div class="simple-dialog" id="simpleDialog">
        <h3 id="simpleDialogTitle">Voltar Partida</h3>
        <p id="simpleDialogMessage">Tem certeza que deseja voltar para a partida anterior?</p>
        <div class="simple-dialog-buttons">
            <button class="btn-cancel" onclick="hideSimpleDialog()">Cancelar</button>
            <button class="btn-confirm" onclick="confirmSimpleAction()">Confirmar</button>
        </div>
    </div>

    <script>
        // Dados do torneio
        let players = [];
        let currentPlayers = [];
        let waitingPlayers = [];
        let stats = {};
        let teamStats = {};
        let team1 = [];
        let team2 = [];
        let teamConsecutiveWins = { team1: 0, team2: 0 };
        let exitOrder = [];
        let currentMatch = 0;
        let tournamentStarted = false;
        let removedPlayers = [];
        let tournamentTimer = null;
        let tournamentTimeElapsed = 0;
        let matchHistory = [];
        let currentAction = '';
        let playerToRemove = '';
        let currentTab = 'edition';
        let deferredPrompt;
        let wakeLock = null;
        let pendingVictoryTeam = 0;
        
        // Novas variáveis para funcionalidades do CORINGA
        let coringaUsedInSorteio = [];
        let consecutiveWins = {};
        
        // Novas variáveis para sistema de pontos
        let playerPoints = {};
        let playerErrors = {};
        let pointsHistory = [];
        let currentMatchPoints = {};
        let currentMatchErrors = {};
        let teamScores = { team1: 0, team2: 0 };
        let undoneActions = [];
        
        // Nova variável para histórico de confrontos
        let confrontosHistory = [];
        
        // Nova variável para sistema de compras
        let purchases = [];
        let currentPurchaseId = null;
        let currentPurchasePlayer = null;

        // Elementos do DOM
        const playerNameInput = document.getElementById('playerName');
        const playersList = document.getElementById('playersList');
        const team1Element = document.getElementById('team1');
        const team2Element = document.getElementById('team2');
        const team1ScoreElement = document.getElementById('team1Score');
        const team2ScoreElement = document.getElementById('team2Score');
        const team1WinsElement = document.getElementById('team1Wins');
        const team2WinsElement = document.getElementById('team2Wins');
        const waitingPlayersElement = document.getElementById('waitingPlayers');
        const modernStatsElement = document.getElementById('modernStats');
        const teamStatsElement = document.getElementById('confrontosStats');
        const pointsStatsElement = document.getElementById('pointsStats');
        const consecutiveInfo = document.getElementById('consecutiveInfo');
        const passwordDialog = document.getElementById('passwordDialog');
        const removePlayerDialog = document.getElementById('removePlayerDialog');
        const victoryDialog = document.getElementById('victoryDialog');
        const simpleDialog = document.getElementById('simpleDialog');
        const overlay = document.getElementById('overlay');
        const passwordInput = document.getElementById('passwordInput');
        const removePasswordInput = document.getElementById('removePasswordInput');
        const startTournamentBtn = document.getElementById('startTournamentBtn');
        const instructionsContent = document.getElementById('instructionsContent');
        const toggleIcon = document.querySelector('.toggle-icon');
        const tournamentStatus = document.getElementById('tournamentStatus');
        const currentMatchTitle = document.getElementById('currentMatchTitle');
        const backButton = document.getElementById('backButton');
        const forwardButton = document.getElementById('forwardButton');
        const dialogTitle = document.getElementById('dialogTitle');
        const dialogMessage = document.getElementById('dialogMessage');
        const playerToRemoveSpan = document.getElementById('playerToRemove');
        const victoryDialogTitle = document.getElementById('victoryDialogTitle');
        const victoryDialogMessage = document.getElementById('victoryDialogMessage');
        const simpleDialogTitle = document.getElementById('simpleDialogTitle');
        const simpleDialogMessage = document.getElementById('simpleDialogMessage');
        const swapPlayer1Select = document.getElementById('swapPlayer1');
        const swapPlayer2Select = document.getElementById('swapPlayer2');
        const installButton = document.getElementById('installButton');
        const mainHeader = document.getElementById('mainHeader');
        const sorteioTeam1Button = document.getElementById('sorteioTeam1');
        const sorteioTeam2Button = document.getElementById('sorteioTeam2');
        const purchasesList = document.getElementById('purchasesList');
        const purchasesSummary = document.getElementById('purchasesSummary');
        const purchasesSummaryResults = document.getElementById('purchasesSummaryResults');
        const purchaseItemInput = document.getElementById('purchaseItem');
        const purchasePriceInput = document.getElementById('purchasePrice');
        const purchasePlayersButtons = document.getElementById('purchasePlayersButtons');
        
        // Sistema de abas
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Restaurar aba ativa do localStorage
            const savedTab = localStorage.getItem('currentTab');
            if (savedTab) {
                switchTab(savedTab);
            }
        }
        
        // Função para trocar de aba
        function switchTab(tabId) {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            currentTab = tabId;
            localStorage.setItem('currentTab', currentTab);
            
            // Remover classe ativa de todas as abas
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));
            
            // Adicionar classe ativa à aba clicada
            const activeTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
            const activeContent = document.getElementById(`${tabId}-tab`);
            
            if (activeTab) activeTab.classList.add('active');
            if (activeContent) activeContent.classList.add('active');
            
            // Mostrar ou esconder o cabeçalho principal
            if (tabId === 'games') {
                mainHeader.style.display = 'none';
                tournamentStatus.style.display = 'none';
            } else {
                mainHeader.style.display = 'block';
                if (tournamentStarted) {
                    tournamentStatus.style.display = 'block';
                }
            }
            
            // Atualizar resumo de compras se for a aba de resultados
            if (tabId === 'results') {
                updatePurchasesSummaryResults();
            }
            
            // Atualizar botões de jogadores na aba de compras
            if (tabId === 'purchases') {
                updatePurchasePlayersButtons();
            }
        }
        
        // Restaurar aba ativa
        function restoreActiveTab() {
            const savedTab = localStorage.getItem('currentTab');
            if (savedTab) {
                switchTab(savedTab);
            }
        }
        
        // Atualizar botões de jogadores na aba de compras
        function updatePurchasePlayersButtons() {
            purchasePlayersButtons.innerHTML = '';
            
            players.forEach(player => {
                if (!player.includes("CORINGA")) {
                    const playerBtn = document.createElement('button');
                    playerBtn.className = 'player-purchase-btn';
                    playerBtn.textContent = player;
                    playerBtn.onclick = () => {
                        if (purchaseItemInput.value.trim() && purchasePriceInput.value) {
                            addPurchaseForPlayer(player);
                        } else {
                            alert('Preencha o nome do item e o preço primeiro.');
                        }
                    };
                    purchasePlayersButtons.appendChild(playerBtn);
                }
            });
        }
        
        // Carregar dados do localStorage se existirem
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('petecaTournament');
            if (savedData) {
                const data = JSON.parse(savedData);
                players = data.players || [];
                currentPlayers = data.currentPlayers || [];
                waitingPlayers = data.waitingPlayers || [];
                stats = data.stats || {};
                teamStats = data.teamStats || {};
                team1 = data.team1 || [];
                team2 = data.team2 || [];
                teamConsecutiveWins = data.teamConsecutiveWins || { team1: 0, team2: 0 };
                exitOrder = data.exitOrder || [];
                currentMatch = data.currentMatch || 0;
                tournamentStarted = data.tournamentStarted || false;
                removedPlayers = data.removedPlayers || [];
                tournamentTimeElapsed = data.tournamentTimeElapsed || 0;
                matchHistory = data.matchHistory || [];
                consecutiveWins = data.consecutiveWins || {};
                coringaUsedInSorteio = data.coringaUsedInSorteio || [];
                playerPoints = data.playerPoints || {};
                playerErrors = data.playerErrors || {};
                pointsHistory = data.pointsHistory || [];
                currentMatchPoints = data.currentMatchPoints || {};
                currentMatchErrors = data.currentMatchErrors || {};
                teamScores = data.teamScores || { team1: 0, team2: 0 };
                undoneActions = data.undoneActions || [];
                confrontosHistory = data.confrontosHistory || [];
                purchases = data.purchases || [];
                
                updatePlayersList();
                updateStartButton();
                updateDisplay();
                updateModernStats();
                updateConfrontosStats();
                updatePointsStats();
                updateTournamentStatus();
                updateSwapDropdowns();
                updateNavigationButtons();
                updatePurchasesList();
                updatePurchasesSummary();
                updatePurchasesSummaryResults();
                updatePurchasePlayersButtons();
            }
        }
        
        // Salvar dados no localStorage
        function saveToLocalStorage() {
            const data = {
                players,
                currentPlayers,
                waitingPlayers,
                stats,
                teamStats,
                team1,
                team2,
                teamConsecutiveWins,
                exitOrder,
                currentMatch,
                tournamentStarted,
                removedPlayers,
                tournamentTimeElapsed,
                matchHistory,
                consecutiveWins,
                coringaUsedInSorteio,
                playerPoints,
                playerErrors,
                pointsHistory,
                currentMatchPoints,
                currentMatchErrors,
                teamScores,
                undoneActions,
                confrontosHistory,
                purchases
            };
            localStorage.setItem('petecaTournament', JSON.stringify(data));
        }
        
        // Atualizar estado do botão de iniciar torneio
        function updateStartButton() {
            const regularPlayers = players.filter(p => !p.includes("CORINGA"));
            if (regularPlayers.length >= 4 && !tournamentStarted) {
                startTournamentBtn.disabled = false;
            } else {
                startTournamentBtn.disabled = true;
            }
        }
        
        // Contar quantos CORINGAs já existem
        function countCoringas() {
            return players.filter(p => p.includes("CORINGA")).length;
        }
        
        // Adicionar jogador CORINGA
        function addCoringa() {
            if (countCoringas() >= 3) {
                alert('Já existem 3 CORINGAs no torneio. Não é possível adicionar mais.');
                return;
            }
            
            let coringaNumber = 1;
            let coringaName = "CORINGA";
            
            while (players.includes(coringaName)) {
                coringaNumber++;
                coringaName = `CORINGA ${coringaNumber}`;
            }
            
            if (!players.includes(coringaName)) {
                players.push(coringaName);
                
                if (tournamentStarted) {
                    waitingPlayers.push(coringaName);
                    updateExitOrder();
                }
                
                stats[coringaName] = { wins: 0, losses: 0, matches: 0 };
                consecutiveWins[coringaName] = 0;
                
                updatePlayersList();
                updateStartButton();
                updateDisplay();
                updateModernStats();
                updateConfrontosStats();
                updateSwapDropdowns();
                updatePurchasePlayersButtons();
                saveToLocalStorage();
                
                if (tournamentStarted) {
                    alert(`Jogador ${coringaName} adicionado à fila de espera!`);
                }
            } else {
                alert('CORINGA já foi adicionado.');
            }
        }
        
        // Adicionar jogador
        function addPlayer() {
            const name = playerNameInput.value.trim();
            if (name && !players.includes(name)) {
                players.push(name);
                
                if (tournamentStarted) {
                    waitingPlayers.push(name);
                    updateExitOrder();
                }
                
                stats[name] = { wins: 0, losses: 0, matches: 0 };
                consecutiveWins[name] = 0;
                playerPoints[name] = playerPoints[name] || 0;
                playerErrors[name] = 0;
                currentMatchPoints[name] = currentMatchPoints[name] || 0;
                currentMatchErrors[name] = 0;
                
                updatePlayersList();
                updateStartButton();
                updateDisplay();
                updateModernStats();
                updateConfrontosStats();
                updateSwapDropdowns();
                updatePurchasePlayersButtons();
                playerNameInput.value = '';
                playerNameInput.focus();
                saveToLocalStorage();
                
                if (tournamentStarted) {
                    alert(`Jogador ${name} adicionado à fila de espera!`);
                }
            } else if (players.includes(name)) {
                alert('Este jogador já foi adicionado.');
            }
        }
        
        // Iniciar torneio
        function startTournament() {
            const regularPlayers = players.filter(p => !p.includes("CORINGA"));
            if (regularPlayers.length < 4) {
                alert('É necessário pelo menos 4 jogadores regulares (não CORINGAs) para iniciar o torneio.');
                return;
            }
            
            tournamentStarted = true;
            currentMatch = 1;
            updateStartButton();
            updateTournamentStatus();
            
            requestWakeLock();
            
            const shuffledPlayers = [...players].sort(() => Math.random() - 0.5);
            
            currentPlayers = shuffledPlayers.slice(0, Math.min(4, shuffledPlayers.length));
            
            waitingPlayers = shuffledPlayers.slice(Math.min(4, shuffledPlayers.length));
            
            if (currentPlayers.length >= 2) {
                team1 = currentPlayers.slice(0, 2);
            }
            
            if (currentPlayers.length >= 4) {
                team2 = currentPlayers.slice(2, 4);
            }
            
            updateExitOrder();
            
            players.forEach(player => {
                if (!consecutiveWins[player]) {
                    consecutiveWins[player] = 0;
                }
                if (!playerPoints[player]) {
                    playerPoints[player] = 0;
                }
                if (!playerErrors[player]) {
                    playerErrors[player] = 0;
                }
                if (!currentMatchPoints[player]) {
                    currentMatchPoints[player] = 0;
                }
                if (!currentMatchErrors[player]) {
                    currentMatchErrors[player] = 0;
                }
            });
            
            teamScores = { team1: 0, team2: 0 };
            
            saveCurrentStateToHistory();
            
            updateDisplay();
            updateSwapDropdowns();
            saveToLocalStorage();
        }
        
        // Atualizar lista de jogadores
        function updatePlayersList() {
            playersList.innerHTML = '';
            players.forEach(player => {
                const li = document.createElement('li');
                
                const isCoringa = player.includes("CORINGA");
                
                li.innerHTML = `
                    ${isCoringa ? '<span style="color: #9c27b0; font-weight: bold;">' + player + '</span>' : player} 
                    <button onclick="showRemovePlayerDialog('${player}')">Remover</button>
                `;
                playersList.appendChild(li);
            });
        }
        
        // Mostrar diálogo para remover jogador
        function showRemovePlayerDialog(playerName) {
            playerToRemove = playerName;
            playerToRemoveSpan.textContent = playerName;
            removePlayerDialog.style.display = 'block';
            overlay.style.display = 'block';
            removePasswordInput.value = '';
            removePasswordInput.focus();
        }
        
        // Esconder diálogo para remover jogador
        function hideRemovePlayerDialog() {
            removePlayerDialog.style.display = 'none';
            overlay.style.display = 'none';
            playerToRemove = '';
        }
        
        // Verificar senha para remover jogador
        function checkRemovePassword() {
            if (removePasswordInput.value === 'peteca') {
                removePlayerConfirmed(playerToRemove);
                hideRemovePlayerDialog();
            } else {
                alert('Senha incorreta. Tente novamente.');
                removePasswordInput.value = '';
                removePasswordInput.focus();
            }
        }
        
        // Remover jogador (após confirmação de senha)
        function removePlayerConfirmed(playerName) {
            if (tournamentStarted) {
                const isPlaying = currentPlayers.includes(playerName);
                
                if (isPlaying && currentPlayers.length <= 4) {
                    if (!confirm(`O jogador ${playerName} está atualmente em jogo. Remover mesmo assim?`)) {
                        return;
                    }
                }
            }
            
            if (!removedPlayers.includes(playerName)) {
                removedPlayers.push(playerName);
            }
            
            players = players.filter(p => p !== playerName);
            currentPlayers = currentPlayers.filter(p => p !== playerName);
            waitingPlayers = waitingPlayers.filter(p => p !== playerName);
            exitOrder = exitOrder.filter(p => p !== playerName);
            
            if (team1.includes(playerName)) {
                team1 = team1.filter(p => p !== playerName);
                
                if (team1.length === 1 && waitingPlayers.length > 0) {
                    team1.push(waitingPlayers.shift());
                }
            }
            
            if (team2.includes(playerName)) {
                team2 = team2.filter(p => p !== playerName);
                
                if (team2.length === 1 && waitingPlayers.length > 0) {
                    team2.push(waitingPlayers.shift());
                }
            }
            
            const regularPlayers = players.filter(p => !p.includes("CORINGA"));
            if (regularPlayers.length < 4 && tournamentStarted) {
                if (confirm('Não há jogadores regulares suficientes para continuar o torneio. Deseja parar o torneio?')) {
                    tournamentStarted = false;
                    resetGameData();
                }
            }
            
            updateExitOrder();
            
            updatePlayersList();
            updateStartButton();
            updateDisplay();
            updateModernStats();
            updateConfrontosStats();
            updatePointsStats();
            updateSwapDropdowns();
            updatePurchasePlayersButtons();
            saveToLocalStorage();
            
            if (tournamentStarted) {
                alert(`Jogador ${playerName} removido do torneio!`);
            }
        }
        
        // Resetar dados do jogo (sem remover jogadores)
        function resetGameData() {
            currentPlayers = [];
            waitingPlayers = [];
            team1 = [];
            team2 = [];
            teamConsecutiveWins = { team1: 0, team2: 0 };
            exitOrder = [];
            currentMatch = 0;
            tournamentStarted = false;
            removedPlayers = [];
            matchHistory = [];
            tournamentTimeElapsed = 0;
            teamStats = {};
            consecutiveWins = {};
            coringaUsedInSorteio = [];
            playerPoints = {};
            playerErrors = {};
            pointsHistory = [];
            currentMatchPoints = {};
            currentMatchErrors = {};
            teamScores = { team1: 0, team2: 0 };
            undoneActions = [];
            confrontosHistory = [];
            
            for (const player in stats) {
                stats[player] = { wins: 0, losses: 0, matches: 0 };
            }
            
            releaseWakeLock();
            
            consecutiveInfo.style.display = 'none';
        }
        
        // Confirmar vitória (exibir diálogo de confirmação)
        function confirmVictory(winningTeamId) {
            if (!tournamentStarted) {
                alert('O torneio ainda não foi iniciado. Adicione jogadores e clique em "Iniciar Torneio".');
                return;
            }
            
            if (team1.length === 0 || team2.length === 0) {
                alert('Não há duplas formadas para registrar vitória.');
                return;
            }
            
            if ((winningTeamId === 1 && teamScores.team1 < teamScores.team2) || 
                (winningTeamId === 2 && teamScores.team2 < teamScores.team1)) {
                alert('A dupla com menos pontos não pode ser marcada como vencedora!');
                return;
            }
            
            pendingVictoryTeam = winningTeamId;
            const winningTeam = winningTeamId === 1 ? team1 : team2;
            
            victoryDialogTitle.textContent = 'Confirmar Vitória';
            victoryDialogMessage.textContent = `A Dupla ${winningTeamId} (${winningTeam.join(' e ')}) venceu a partida?`;
            
            victoryDialog.style.display = 'block';
            overlay.style.display = 'block';
        }
        
        // Esconder diálogo de confirmação de vitória
        function hideVictoryDialog() {
            victoryDialog.style.display = 'none';
            overlay.style.display = 'none';
            pendingVictoryTeam = 0;
        }
        
        // Confirmar ação de vitória (após confirmação)
        function confirmVictoryAction() {
            if (pendingVictoryTeam !== 0) {
                registerVictory(pendingVictoryTeam);
                hideVictoryDialog();
            }
        }
        
        // Registrar vitória
        function registerVictory(winningTeamId) {
            if (!tournamentStarted) {
                alert('O torneio ainda não foi iniciado. Adicione jogadores e clique em "Iniciar Torneio".');
                return;
            }
            
            if (team1.length === 0 || team2.length === 0) {
                alert('Não há duplas formadas para registrar vitória.');
                return;
            }
            
            saveCurrentStateToHistory();
            
            let winners, losers;
            const winningTeamKey = winningTeamId === 1 ? getTeamKey(team1) : getTeamKey(team2);
            const losingTeamKey = winningTeamId === 1 ? getTeamKey(team2) : getTeamKey(team1);
            
            if (winningTeamId === 1) {
                winners = team1;
                losers = team2;
                
                teamConsecutiveWins.team1++;
                teamConsecutiveWins.team2 = 0;
            } else {
                winners = team2;
                losers = team1;
                
                teamConsecutiveWins.team2++;
                teamConsecutiveWins.team1 = 0;
            }
            
            confrontosHistory.push({
                match: currentMatch,
                team1: [...team1],
                team2: [...team2],
                winner: winningTeamId,
                score: `${teamScores.team1} x ${teamScores.team2}`,
                points: JSON.parse(JSON.stringify(currentMatchPoints))
            });
            
            winners.forEach(player => {
                stats[player].wins++;
                stats[player].matches++;
                consecutiveWins[player]++;
                
                if (consecutiveWins[player] >= 6 && waitingPlayers.length > 0) {
                    const replacement = waitingPlayers.shift();
                    
                    if (team1.includes(player)) {
                        team1 = team1.map(p => p === player ? replacement : p);
                    } else if (team2.includes(player)) {
                        team2 = team2.map(p => p === player ? replacement : p);
                    }
                    
                    waitingPlayers.push(player);
                    
                    consecutiveWins[player] = 0;
                    
                    alert(`${player} atingiu 6 vitórias consecutivas e foi substituído por ${replacement}!`);
                }
            });
            
            losers.forEach(player => {
                stats[player].losses++;
                stats[player].matches++;
                consecutiveWins[player] = 0;
            });
            
            if (!teamStats[winningTeamKey]) {
                teamStats[winningTeamKey] = { wins: 0, losses: 0, matches: 0, players: winners };
            }
            teamStats[winningTeamKey].wins++;
            teamStats[winningTeamKey].matches++;
            
            if (!teamStats[losingTeamKey]) {
                teamStats[losingTeamKey] = { wins: 0, losses: 0, matches: 0, players: losers };
            }
            teamStats[losingTeamKey].losses++;
            teamStats[losingTeamKey].matches++;
            
            currentMatch++;
            updateTournamentStatus();
            
            if (teamConsecutiveWins.team1 >= 3 || teamConsecutiveWins.team2 >= 3) {
                const winningTeamId = teamConsecutiveWins.team1 >= 3 ? 1 : 2;
                const winningTeam = winningTeamId === 1 ? team1 : team2;
                const losingTeam = winningTeamId === 1 ? team2 : team1;
                
                consecutiveInfo.style.display = 'block';
                consecutiveInfo.textContent = `Dupla ${winningTeamId} com 3 vitórias consecutivas! Os jogadores serão redistribuídos.`;
                
                losingTeam.forEach(player => {
                    if (!waitingPlayers.includes(player)) {
                        waitingPlayers.push(player);
                    }
                });
                
                if (winningTeamId === 1) {
                    const [winner1, winner2] = winningTeam;
                    
                    if (waitingPlayers.length > 0) {
                        team1 = [winner1, waitingPlayers.shift()];
                    } else {
                        team1 = [winner1];
                    }
                    
                    if (waitingPlayers.length > 0) {
                        team2 = [winner2, waitingPlayers.shift()];
                    } else {
                        team2 = [winner2];
                    }
                } else {
                    const [winner1, winner2] = winningTeam;
                    
                    if (waitingPlayers.length > 0) {
                        team1 = [winner1, waitingPlayers.shift()];
                    } else {
                        team1 = [winner1];
                    }
                    
                    if (waitingPlayers.length > 0) {
                        team2 = [winner2, waitingPlayers.shift()];
                    } else {
                        team2 = [winner2];
                    }
                }
                
                teamConsecutiveWins = { team1: 0, team2: 0 };
            } else {
                consecutiveInfo.style.display = 'none';
                
                const losingTeam = winningTeamId === 1 ? team2 : team1;
                
                losingTeam.forEach(player => {
                    if (!waitingPlayers.includes(player)) {
                        waitingPlayers.push(player);
                    }
                });
                
                if (waitingPlayers.length > 0) {
                    if (winningTeamId === 1) {
                        if (waitingPlayers.length >= 2) {
                            team2 = [waitingPlayers.shift(), waitingPlayers.shift()];
                        }
                    } else {
                        if (waitingPlayers.length >= 2) {
                            team1 = [waitingPlayers.shift(), waitingPlayers.shift()];
                        }
                    }
                }
            }
            
            currentPlayers = [...team1, ...team2];
            
            updateExitOrder();
            
            players.forEach(player => {
                currentMatchPoints[player] = 0;
                currentMatchErrors[player] = 0;
            });
            pointsHistory = [];
            teamScores = { team1: 0, team2: 0 };
            
            updateModernStats();
            updateConfrontosStats();
            updatePointsStats();
            
            saveToLocalStorage();
            
            updateDisplay();
        }
        
        // Gerar chave única para uma dupla (ordena os nomes para garantir unicidade)
        function getTeamKey(team) {
            return team.slice().sort().join('+');
        }
        
        // Mostrar diálogo simples (sem senha)
        function showSimpleDialog(action) {
            currentAction = action;
            
            if (action === 'back') {
                simpleDialogTitle.textContent = 'Voltar Partida';
                simpleDialogMessage.textContent = 'Tem certeza que deseja voltar para a partida anterior?';
            }
            
            simpleDialog.style.display = 'block';
            overlay.style.display = 'block';
        }
        
        // Esconder diálogo simples
        function hideSimpleDialog() {
            simpleDialog.style.display = 'none';
            overlay.style.display = 'none';
            currentAction = '';
        }
        
        // Confirmar ação simples
        function confirmSimpleAction() {
            if (currentAction === 'back') {
                goBackToPreviousMatch();
            }
            hideSimpleDialog();
        }
        
        // Voltar para a partida anterior
        function goBackToPreviousMatch() {
            if (matchHistory.length === 0) {
                alert("Não há partidas anteriores para voltar.");
                return;
            }
            
            undoneActions.push({
                players: [...players],
                currentPlayers: [...currentPlayers],
                waitingPlayers: [...waitingPlayers],
                stats: JSON.parse(JSON.stringify(stats)),
                teamStats: JSON.parse(JSON.stringify(teamStats)),
                team1: [...team1],
                team2: [...team2],
                teamConsecutiveWins: {...teamConsecutiveWins},
                exitOrder: [...exitOrder],
                currentMatch: currentMatch,
                tournamentTimeElapsed: tournamentTimeElapsed,
                consecutiveWins: {...consecutiveWins},
                coringaUsedInSorteio: [...coringaUsedInSorteio],
                playerPoints: JSON.parse(JSON.stringify(playerPoints)),
                playerErrors: JSON.parse(JSON.stringify(playerErrors)),
                pointsHistory: [...pointsHistory],
                currentMatchPoints: JSON.parse(JSON.stringify(currentMatchPoints)),
                currentMatchErrors: JSON.parse(JSON.stringify(currentMatchErrors)),
                teamScores: {...teamScores},
                confrontosHistory: [...confrontosHistory],
                purchases: JSON.parse(JSON.stringify(purchases))
            });
            
            const previousState = matchHistory.pop();
            
            players = previousState.players;
            currentPlayers = previousState.currentPlayers;
            waitingPlayers = previousState.waitingPlayers;
            stats = previousState.stats;
            teamStats = previousState.teamStats || {};
            team1 = previousState.team1;
            team2 = previousState.team2;
            teamConsecutiveWins = previousState.teamConsecutiveWins;
            exitOrder = previousState.exitOrder;
            currentMatch = previousState.currentMatch;
            tournamentTimeElapsed = previousState.tournamentTimeElapsed;
            consecutiveWins = previousState.consecutiveWins || {};
            coringaUsedInSorteio = previousState.coringaUsedInSorteio || [];
            playerPoints = previousState.playerPoints || {};
            playerErrors = previousState.playerErrors || {};
            pointsHistory = previousState.pointsHistory || [];
            currentMatchPoints = previousState.currentMatchPoints || {};
            currentMatchErrors = previousState.currentMatchErrors || {};
            teamScores = previousState.teamScores || { team1: 0, team2: 0 };
            confrontosHistory = previousState.confrontosHistory || [];
            purchases = previousState.purchases || [];
            
            updatePlayersList();
            updateStartButton();
            updateDisplay();
            updateModernStats();
            updateConfrontosStats();
            updatePointsStats();
            updateTournamentStatus();
            updateSwapDropdowns();
            updateNavigationButtons();
            updatePurchasesList();
            updatePurchasesSummary();
            updatePurchasesSummaryResults();
            updatePurchasePlayersButtons();
            
            saveToLocalStorage();
        }
        
        // Refazer ação desfeita
        function redoAction() {
            if (undoneActions.length === 0) {
                alert("Não há ações para refazer.");
                return;
            }
            
            saveCurrentStateToHistory();
            
            const nextState = undoneActions.pop();
            
            players = nextState.players;
            currentPlayers = nextState.currentPlayers;
            waitingPlayers = nextState.waitingPlayers;
            stats = nextState.stats;
            teamStats = nextState.teamStats || {};
            team1 = nextState.team1;
            team2 = nextState.team2;
            teamConsecutiveWins = nextState.teamConsecutiveWins;
            exitOrder = nextState.exitOrder;
            currentMatch = nextState.currentMatch;
            tournamentTimeElapsed = nextState.tournamentTimeElapsed;
            consecutiveWins = nextState.consecutiveWins || {};
            coringaUsedInSorteio = nextState.coringaUsedInSorteio || [];
            playerPoints = nextState.playerPoints || {};
            playerErrors = nextState.playerErrors || {};
            pointsHistory = nextState.pointsHistory || [];
            currentMatchPoints = nextState.currentMatchPoints || {};
            currentMatchErrors = nextState.currentMatchErrors || {};
            teamScores = nextState.teamScores || { team1: 0, team2: 0 };
            confrontosHistory = nextState.confrontosHistory || [];
            purchases = nextState.purchases || [];
            
            updatePlayersList();
            updateStartButton();
            updateDisplay();
            updateModernStats();
            updateConfrontosStats();
            updatePointsStats();
            updateTournamentStatus();
            updateSwapDropdowns();
            updateNavigationButtons();
            updatePurchasesList();
            updatePurchasesSummary();
            updatePurchasesSummaryResults();
            updatePurchasePlayersButtons();
            
            saveToLocalStorage();
        }
        
        // Atualizar a ordem de saída
        function updateExitOrder() {
            exitOrder = [];
            
            waitingPlayers.forEach(player => {
                if (!exitOrder.includes(player)) {
                    exitOrder.push(player);
                }
            });
            
            currentPlayers.forEach(player => {
                if (!exitOrder.includes(player)) {
                    exitOrder.push(player);
                }
            });
        }
        
        // Atualizar a exibição
        function updateDisplay() {
            team1ScoreElement.textContent = teamScores.team1;
            team2ScoreElement.textContent = teamScores.team2;
            
            team1Element.innerHTML = '';
            if (team1.length > 0) {
                team1.forEach(player => {
                    const playerDiv = document.createElement('div');
                    const isCoringa = player.includes("CORINGA");
                    playerDiv.className = `team-player ${isCoringa ? "player-coringa" : ""}`;
                    
                    const pointsButtons = document.createElement('div');
                    pointsButtons.className = 'player-points-buttons';
                    
                    const playerName = document.createElement('div');
                    playerName.className = 'player-name';
                    playerName.textContent = player;
                    
                    const pointButton = document.createElement('button');
                    pointButton.className = 'btn-point-small';
                    pointButton.innerHTML = `Acertou ${currentMatchPoints[player] || 0}`;
                    pointButton.onclick = () => addPoint(player);
                    
                    pointsButtons.appendChild(playerName);
                    pointsButtons.appendChild(pointButton);
                    
                    playerDiv.appendChild(pointsButtons);
                    
                    if (consecutiveWins[player] > 0) {
                        const consecutiveIndicator = document.createElement('div');
                        consecutiveIndicator.className = 'consecutive-individual';
                        consecutiveIndicator.textContent = consecutiveWins[player];
                        playerDiv.appendChild(consecutiveIndicator);
                    }
                    
                    team1Element.appendChild(playerDiv);
                });
                
                if (teamConsecutiveWins.team1 > 0) {
                    team1WinsElement.textContent = `${teamConsecutiveWins.team1} vitória(s) consecutiva(s)`;
                } else {
                    team1WinsElement.textContent = '';
                }
                
                sorteioTeam1Button.style.display = team1.some(p => p.includes("CORINGA")) ? 'block' : 'none';
            } else {
                team1Element.innerHTML = '<p>A definir</p>';
                team1WinsElement.textContent = '';
                sorteioTeam1Button.style.display = 'none';
            }
            
            team2Element.innerHTML = '';
            if (team2.length > 0) {
                team2.forEach(player => {
                    const playerDiv = document.createElement('div');
                    const isCoringa = player.includes("CORINGA");
                    playerDiv.className = `team-player ${isCoringa ? "player-coringa" : ""}`;
                    
                    const pointsButtons = document.createElement('div');
                    pointsButtons.className = 'player-points-buttons';
                    
                    const playerName = document.createElement('div');
                    playerName.className = 'player-name';
                    playerName.textContent = player;
                    
                    const pointButton = document.createElement('button');
                    pointButton.className = 'btn-point-small';
                    pointButton.innerHTML = `Acertou ${currentMatchPoints[player] || 0}`;
                    pointButton.onclick = () => addPoint(player);
                    
                    pointsButtons.appendChild(playerName);
                    pointsButtons.appendChild(pointButton);
                    
                    playerDiv.appendChild(pointsButtons);
                    
                    if (consecutiveWins[player] > 0) {
                        const consecutiveIndicator = document.createElement('div');
                        consecutiveIndicator.className = 'consecutive-individual';
                        consecutiveIndicator.textContent = consecutiveWins[player];
                        playerDiv.appendChild(consecutiveIndicator);
                    }
                    
                    team2Element.appendChild(playerDiv);
                });
                
                if (teamConsecutiveWins.team2 > 0) {
                    team2WinsElement.textContent = `${teamConsecutiveWins.team2} vitória(s) consecutiva(s)`;
                } else {
                    team2WinsElement.textContent = '';
                }
                
                sorteioTeam2Button.style.display = team2.some(p => p.includes("CORINGA")) ? 'block' : 'none';
            } else {
                team2Element.innerHTML = '<p>A definir</p>';
                team2WinsElement.textContent = '';
                sorteioTeam2Button.style.display = 'none';
            }
            
            waitingPlayersElement.innerHTML = '';
            if (waitingPlayers.length > 0) {
                const ol = document.createElement('ol');
                waitingPlayers.forEach((player, index) => {
                    const li = document.createElement('li');
                    
                    const isCoringa = player.includes("CORINGA");
                    
                    if (isCoringa) {
                        li.textContent = player;
                    } else {
                        li.textContent = player;
                    }
                    
                    if (player.includes("CORINGA")) {
                        li.style.fontWeight = 'bold';
                        li.style.color = '#9c27b0';
                    }
                    ol.appendChild(li);
                });
                waitingPlayersElement.appendChild(ol);
            } else {
                waitingPlayersElement.textContent = 'Nenhum jogador na espera';
            }
        }
        
        // Realizar sorteio do CORINGA
        function realizarSorteio(teamId) {
            saveCurrentStateToHistory();
            
            const team = teamId === 1 ? team1 : team2;
            
            const coringaIndex = team.findIndex(p => p.includes("CORINGA"));
            
            if (coringaIndex === -1) {
                alert("CORINGA não está nesta equipe!");
                return;
            }
            
            const coringaName = team[coringaIndex];
            
            const eligiblePlayers = waitingPlayers.filter((player, index) => 
                index < waitingPlayers.length - 2 && 
                !player.includes("CORINGA") && 
                !coringaUsedInSorteio.includes(player)
            );
            
            if (eligiblePlayers.length === 0) {
                if (waitingPlayers.filter(p => !p.includes("CORINGA")).length <= 2) {
                    alert("Não há jogadores suficientes na fila de espera para realizar o sorteio!");
                    return;
                }
                
                coringaUsedInSorteio = [];
                
                const newEligiblePlayers = waitingPlayers.filter((player, index) => 
                    index < waitingPlayers.length - 2 && !player.includes("CORINGA")
                );
                
                if (newEligiblePlayers.length === 0) {
                    alert("Não há jogadores elegíveis para o sorteio!");
                    return;
                }
                
                const selectedPlayer = newEligiblePlayers.reduce((prev, curr) => 
                    stats[prev].matches < stats[curr].matches ? prev : curr
                );
                
                team[coringaIndex] = selectedPlayer;
                
                const playerIndex = waitingPlayers.indexOf(selectedPlayer);
                if (playerIndex !== -1) {
                    waitingPlayers.splice(playerIndex, 1);
                }
                
                waitingPlayers.push(coringaName);
                
                coringaUsedInSorteio.push(selectedPlayer);
                
                alert(`${coringaName} foi substituído por ${selectedPlayer}!`);
            } else {
                const selectedPlayer = eligiblePlayers.reduce((prev, curr) => 
                    stats[prev].matches < stats[curr].matches ? prev : curr
                );
                
                team[coringaIndex] = selectedPlayer;
                
                const playerIndex = waitingPlayers.indexOf(selectedPlayer);
                if (playerIndex !== -1) {
                    waitingPlayers.splice(playerIndex, 1);
                }
                
                waitingPlayers.push(coringaName);
                
                coringaUsedInSorteio.push(selectedPlayer);
                
                alert(`${coringaName} foi substituído por ${selectedPlayer}!`);
            }
            
            currentPlayers = [...team1, ...team2];
            
            updateExitOrder();
            
            updateDisplay();
            
            saveToLocalStorage();
        }
        
        // Adicionar ponto para um jogador
        function addPoint(player) {
            saveCurrentStateToHistory();
            
            const playerTeam = team1.includes(player) ? 1 : 2;
            
            currentMatchPoints[player] = (currentMatchPoints[player] || 0) + 1;
            
            playerPoints[player] = (playerPoints[player] || 0) + 1;
            
            teamScores[`team${playerTeam}`]++;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            pointsHistory.push({
                player,
                type: 'point',
                time: timeString,
                team: playerTeam
            });
            
            updateDisplay();
            updatePointsStats();
            
            saveToLocalStorage();
        }
        
        // Atualizar estatísticas modernas (excluindo CORINGAs)
        function updateModernStats() {
            modernStatsElement.innerHTML = '';
            
            const statsArray = Object.entries(stats)
                .filter(([player]) => !player.includes("CORINGA"))
                .map(([player, data]) => {
                    const winPercentage = data.matches > 0 ? ((data.wins / data.matches) * 100).toFixed(1) : '0.0';
                    return { player, ...data, winPercentage };
                });
            
            statsArray.sort((a, b) => {
                if (b.wins !== a.wins) {
                    return b.wins - a.wins;
                }
                return a.losses - b.losses;
            });
            
            statsArray.forEach(({ player, matches, wins, losses, winPercentage }, index) => {
                const isRemoved = removedPlayers.includes(player);
                
                const row = document.createElement('div');
                row.className = 'stats-row';
                
                let emoji = '';
                if (index === 0) emoji = '🏆';
                else if (index === 1) emoji = '🥈';
                else if (index === 2) emoji = '🥉';
                else if (index === statsArray.length - 1) {
                    const lastWins = statsArray[statsArray.length - 1].wins;
                    const lastLosses = statsArray[statsArray.length - 1].losses;
                    const isTie = statsArray.filter(s => s.wins === lastWins && s.losses === lastLosses).length > 1;
                    
                    if (isTie) {
                        emoji = '💩';
                    } else {
                        emoji = '💩';
                    }
                }
                
                row.innerHTML = `
                    <div class="stats-position">${index + 1}º</div>
                    <div class="stats-player ${isRemoved ? 'player-removed' : ''}">${player}${isRemoved ? ' (saiu)' : ''}</div>
                    <div class="stats-numbers">
                        <div class="stats-wins">${wins}V</div>
                        <div class="stats-losses">${losses}D</div>
                        <div class="stats-percent">${winPercentage}%</div>
                    </div>
                    <div class="stats-emoji">${emoji}</div>
                `;
                modernStatsElement.appendChild(row);
            });
        }
        
        // Atualizar relatório de confrontos
        function updateConfrontosStats() {
            teamStatsElement.innerHTML = '';
            
            if (confrontosHistory.length === 0) {
                teamStatsElement.innerHTML = '<p>Nenhum confronto registrado ainda.</p>';
                return;
            }
            
            const container = document.createElement('div');
            container.className = 'confrontos-container';
            
            confrontosHistory.forEach((confronto, index) => {
                const item = document.createElement('div');
                item.className = 'confronto-item';
                
                const teamsDiv = document.createElement('div');
                teamsDiv.className = 'confronto-teams';
                teamsDiv.innerHTML = `
                    <div><strong>Partida ${confronto.match}:</strong> ${confronto.team1.join(' + ')} vs ${confronto.team2.join(' + ')}</div>
                `;
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'confronto-result';
                
                let pointsInfo = '';
                if (confronto.points) {
                    const team1Points = confronto.team1.map(player => `${player}: ${confronto.points[player] || 0}`).join(', ');
                    const team2Points = confronto.team2.map(player => `${player}: ${confronto.points[player] || 0}`).join(', ');
                    pointsInfo = `<div style="font-size: 0.8rem; margin-top: 5px; color: #666;">Pontos: ${team1Points} | ${team2Points}</div>`;
                }
                
                resultDiv.innerHTML = `
                    <div>${confronto.score} - Vencedor: Dupla ${confronto.winner}</div>
                    ${pointsInfo}
                `;
                
                item.appendChild(teamsDiv);
                item.appendChild(resultDiv);
                container.appendChild(item);
            });
            
            teamStatsElement.appendChild(container);
        }
        
        // Atualizar estatísticas de pontos
        function updatePointsStats() {
            pointsStatsElement.innerHTML = '';
            
            const pointsArray = Object.entries(playerPoints)
                .filter(([player]) => !player.includes("CORINGA"))
                .map(([player, points]) => {
                    return { player, points };
                });
            
            pointsArray.sort((a, b) => b.points - a.points);
            
            if (pointsArray.length === 0) {
                pointsStatsElement.innerHTML = '<p>Nenhuma estatística de pontos disponível ainda.</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'points-stats-table';
            
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Jogador</th>
                    <th>Pontos</th>
                </tr>
            `;
            table.appendChild(thead);
            
            const tbody = document.createElement('tbody');
            pointsArray.forEach(({ player, points }) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${player}</td>
                    <td>${points}</td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            
            pointsStatsElement.appendChild(table);
        }
        
        // Compartilhar resultados individuais
        function shareResults() {
            const resultsElement = document.createElement('div');
            resultsElement.style.backgroundColor = 'white';
            resultsElement.style.padding = '20px';
            resultsElement.style.borderRadius = '10px';
            resultsElement.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
            resultsElement.style.maxWidth = '350px';
            resultsElement.style.margin = '0 auto';
            resultsElement.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            resultsElement.style.border = '2px solid #2575fc';
            resultsElement.style.overflow = 'hidden';
            
            const statsArray = Object.entries(stats)
                .filter(([player]) => !player.includes("CORINGA"))
                .map(([player, data]) => {
                    const winPercentage = data.matches > 0 ? ((data.wins / data.matches) * 100).toFixed(1) : '0.0';
                    return { player, ...data, winPercentage };
                });
            
            statsArray.sort((a, b) => {
                if (b.wins !== a.wins) {
                    return b.wins - a.wins;
                }
                return a.losses - b.losses;
            });
            
            const currentDate = new Date().toLocaleDateString('pt-BR');
            
            resultsElement.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #2575fc;">
                    <h2 style="color: #2575fc; margin-bottom: 8px; font-size: 1.5rem;">Petecando 2025</h2>
                    <div style="font-style: italic; color: #666; margin-bottom: 5px; font-size: 0.9rem;">Estatísticas Individuais</div>
                    <div style="display: flex; justify-content: center; gap: 15px; margin-top: 10px; font-size: 0.8rem;">
                        <div style="font-weight: bold;">Data: ${currentDate}</div>
                        <div style="font-weight: bold;">Partidas: ${currentMatch}</div>
                    </div>
                </div>
                <div style="text-align: center; margin-bottom: 10px; font-style: italic; color: #666; font-size: 0.8rem;">App by Hugo Ribeiro</div>
                
                <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th style="padding: 8px 5px; text-align: center; border-bottom: 2px solid #2575fc; background-color: #2575fc; color: white;">Pos</th>
                            <th style="padding: 8px 5px; text-align: left; border-bottom: 2px solid #2575fc; background-color: #2575fc; color: white;">Jogador</th>
                            <th style="padding: 8px 5px; text-align: center; border-bottom: 2px solid #2575fc; background-color: #2575fc; color: white;">Partidas</th>
                            <th style="padding: 8px 5px; text-align: center; border-bottom: 2px solid #2575fc; background-color: #2575fc; color: white;">Vitórias</th>
                            <th style="padding: 8px 5px; text-align: center; border-bottom: 2px solid #2575fc; background-color: #2575fc; color: white;">Derrotas</th>
                            <th style="padding: 8px 5px; text-align: center; border-bottom: 2px solid #2575fc; background-color: #2575fc; color: white;">%</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${statsArray.map(({ player, matches, wins, losses, winPercentage }, index) => {
                            const isRemoved = removedPlayers.includes(player);
                            const playerName = isRemoved ? `${player} (saiu)` : player;
                            const textColor = isRemoved ? 'color: #ff4757; font-style: italic;' : '';
                            
                            let positionClass = '';
                            let positionEmoji = '';
                            if (index === 0) {
                                positionClass = 'background-color: #FFD700; color: #000; font-weight: bold;';
                                positionEmoji = '🏆 ';
                            } else if (index === 1) {
                                positionClass = 'background-color: #C0C0C0; color: #000; font-weight: bold;';
                                positionEmoji = '🥈 ';
                            } else if (index === 2) {
                                positionClass = 'background-color: #CD7F32; color: #000; font-weight: bold;';
                                positionEmoji = '🥉 ';
                            } else if (index === statsArray.length - 1) {
                                const lastWins = statsArray[statsArray.length - 1].wins;
                                const lastLosses = statsArray[statsArray.length - 1].losses;
                                const isTie = statsArray.filter(s => s.wins === lastWins && s.losses === lastLosses).length > 1;
                                
                                if (isTie) {
                                    positionEmoji = '💩 ';
                                } else {
                                    positionEmoji = '💩 ';
                                }
                            }
                            
                            return `
                                <tr style="${positionClass}">
                                    <td style="padding: 8px 5px; border-bottom: 1px solid #ddd; text-align: center; ${textColor} ${positionClass}">${positionEmoji}${index + 1}º</td>
                                    <td style="padding: 8px 5px; border-bottom: 1px solid #ddd; ${textColor} ${positionClass}">${playerName}</td>
                                    <td style="padding: 8px 5px; border-bottom: 1px solid #ddd; text-align: center; ${textColor} ${positionClass}">${matches}</td>
                                    <td style="padding: 8px 5px; border-bottom: 1px solid #ddd; text-align: center; ${textColor} ${positionClass}">${wins}</td>
                                    <td style="padding: 8px 5px; border-bottom: 1px solid #ddd; text-align: center; ${textColor} ${positionClass}">${losses}</td>
                                    <td style="padding: 8px 5px; border-bottom: 1px solid #ddd; text-align: center; ${textColor} ${positionClass}">${winPercentage}%</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <p style="text-align: center; margin-top: 15px; font-style: italic; color: #666; font-size: 0.8rem;">Gerado pelo Petecando 2025</p>
            `;
            
            document.body.appendChild(resultsElement);
            
            html2canvas(resultsElement, {
                scale: 2,
                logging: false,
                useCORS: true,
                width: resultsElement.offsetWidth,
                height: resultsElement.offsetHeight,
                windowWidth: resultsElement.scrollWidth,
                windowHeight: resultsElement.scrollHeight
            }).then(canvas => {
                document.body.removeChild(resultsElement);
                
                const dataURL = canvas.toDataURL('image/jpeg', 0.9);
                
                const link = document.createElement('a');
                link.download = `petecando-2025-individual-${new Date().toISOString().slice(0, 10)}.jpg`;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                if (navigator.share) {
                    canvas.toBlob(blob => {
                        const file = new File([blob], `petecando-2025-individual-${new Date().toISOString().slice(0, 10)}.jpg`, { type: 'image/jpeg' });
                        navigator.share({
                            title: 'Petecando 2025 - Estatísticas Individuais',
                            text: `Confira as estatísticas individuais do nosso torneio de peteca! Data: ${currentDate}, Partidas: ${currentMatch}`,
                            files: [file]
                        }).catch(error => {
                            console.log('Erro ao compartilhar:', error);
                        });
                    }, 'image/jpeg', 0.9);
                }
            });
        }
        
        // Compartilhar resultados de pontos
        function sharePointsResults() {
            const resultsElement = document.createElement('div');
            resultsElement.style.backgroundColor = 'white';
            resultsElement.style.padding = '20px';
            resultsElement.style.borderRadius = '10px';
            resultsElement.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
            resultsElement.style.maxWidth = '350px';
            resultsElement.style.margin = '0 auto';
            resultsElement.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            resultsElement.style.border = '2px solid #9c27b0';
            resultsElement.style.overflow = 'hidden';
            
            const pointsArray = Object.entries(playerPoints)
                .filter(([player]) => !player.includes("CORINGA"))
                .map(([player, points]) => {
                    return { player, points };
                });
            
            pointsArray.sort((a, b) => b.points - a.points);
            
            const currentDate = new Date().toLocaleDateString('pt-BR');
            
            resultsElement.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #9c27b0;">
                    <h2 style="color: #9c27b0; margin-bottom: 8px; font-size: 1.5rem;">Petecando 2025</h2>
                    <div style="font-style: italic; color: #666; margin-bottom: 5px; font-size: 0.9rem;">Estatísticas de Pontos</div>
                    <div style="display: flex; justify-content: center; gap: 15px; margin-top: 10px; font-size: 0.8rem;">
                        <div style="font-weight: bold;">Data: ${currentDate}</div>
                        <div style="font-weight: bold;">Partidas: ${currentMatch}</div>
                    </div>
                </div>
                <div style="text-align: center; margin-bottom: 10px; font-style: italic; color: #666; font-size: 0.8rem;">App by Hugo Ribeiro</div>
                
                <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th style="padding: 8px 5px; text-align: center; border-bottom: 2px solid #9c27b0; background-color: #9c27b0; color: white;">Pos</th>
                            <th style="padding: 8px 5px; text-align: left; border-bottom: 2px solid #9c27b0; background-color: #9c27b0; color: white;">Jogador</th>
                            <th style="padding: 8px 5px; text-align: center; border-bottom: 2px solid #9c27b0; background-color: #9c27b0; color: white;">Pontos</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pointsArray.map(({ player, points }, index) => {
                            let positionClass = '';
                            let positionEmoji = '';
                            if (index === 0) {
                                positionClass = 'background-color: #FFD700; color: #000; font-weight: bold;';
                                positionEmoji = '🏆 ';
                            } else if (index === 1) {
                                positionClass = 'background-color: #C0C0C0; color: #000; font-weight: bold;';
                                positionEmoji = '🥈 ';
                            } else if (index === 2) {
                                positionClass = 'background-color: #CD7F32; color: #000; font-weight: bold;';
                                positionEmoji = '🥉 ';
                            } else if (index === pointsArray.length - 1) {
                                const lastPoints = pointsArray[pointsArray.length - 1].points;
                                const isTie = pointsArray.filter(s => s.points === lastPoints).length > 1;
                                
                                if (isTie) {
                                    positionEmoji = '💩 ';
                                } else {
                                    positionEmoji = '💩 ';
                                }
                            }
                            
                            return `
                                <tr style="${positionClass}">
                                    <td style="padding: 8px 5px; border-bottom: 1px solid #ddd; text-align: center; ${positionClass}">${positionEmoji}${index + 1}º</td>
                                    <td style="padding: 8px 5px; border-bottom: 1px solid #ddd; ${positionClass}">${player}</td>
                                    <td style="padding: 8px 5px; border-bottom: 1px solid #ddd; text-align: center; ${positionClass}">${points}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <p style="text-align: center; margin-top: 15px; font-style: italic; color: #666; font-size: 0.8rem;">Gerado pelo Petecando 2025</p>
            `;
            
            document.body.appendChild(resultsElement);
            
            html2canvas(resultsElement, {
                scale: 2,
                logging: false,
                useCORS: true,
                width: resultsElement.offsetWidth,
                height: resultsElement.offsetHeight,
                windowWidth: resultsElement.scrollWidth,
                windowHeight: resultsElement.scrollHeight
            }).then(canvas => {
                document.body.removeChild(resultsElement);
                
                const dataURL = canvas.toDataURL('image/jpeg', 0.9);
                
                const link = document.createElement('a');
                link.download = `petecando-2025-pontos-${new Date().toISOString().slice(0, 10)}.jpg`;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                if (navigator.share) {
                    canvas.toBlob(blob => {
                        const file = new File([blob], `petecando-2025-pontos-${new Date().toISOString().slice(0, 10)}.jpg`, { type: 'image/jpeg' });
                        navigator.share({
                            title: 'Petecando 2025 - Estatísticas de Pontos',
                            text: `Confira as estatísticas de pontos do nosso torneio de peteca! Data: ${currentDate}, Partidas: ${currentMatch}`,
                            files: [file]
                        }).catch(error => {
                            console.log('Erro ao compartilhar:', error);
                        });
                    }, 'image/jpeg', 0.9);
                }
            });
        }
        
        // Compartilhar relatório de confrontos
        function shareConfrontosResults() {
            const currentDate = new Date().toLocaleDateString('pt-BR');
            
            let content = `🏸 *PETECANDO 2025 - RELATÓRIO DE CONFRONTOS* 🏸\n\n`;
            content += `📅 Data: ${currentDate}\n`;
            content += `⚔️ Partidas: ${currentMatch}\n\n`;
            
            if (confrontosHistory.length === 0) {
                content += `Nenhum confronto registrado ainda.\n`;
            } else {
                confrontosHistory.forEach((confronto, index) => {
                    content += `*Partida ${confronto.match}:*\n`;
                    content += `🏆 ${confronto.team1.join(' + ')} vs ${confronto.team2.join(' + ')}\n`;
                    content += `📊 ${confronto.score} - Vencedor: Dupla ${confronto.winner}\n`;
                    
                    if (confronto.points) {
                        content += `🎯 Pontos:\n`;
                        confronto.team1.forEach(player => {
                            content += `   • ${player}: ${confronto.points[player] || 0}\n`;
                        });
                        content += `   vs\n`;
                        confronto.team2.forEach(player => {
                            content += `   • ${player}: ${confronto.points[player] || 0}\n`;
                        });
                    }
                    
                    content += `\n`;
                });
            }
            
            content += `\n📱 Gerado pelo Petecando 2025\n`;
            content += `👨‍💻 App by Hugo Ribeiro`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Petecando 2025 - Relatório de Confrontos',
                    text: content
                }).catch(error => {
                    console.log('Erro ao compartilhar:', error);
                    copyToClipboard(content);
                });
            } else {
                copyToClipboard(content);
            }
        }
        
        // Função para copiar texto para a área de transferência
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('Relatório copiado para a área de transferência! Cole no WhatsApp para compartilhar.');
        }
        
        // Exportar dados do torneio em formato de texto
        function exportTournamentData() {
            const currentDate = new Date().toLocaleDateString('pt-BR');
            
            const statsArray = Object.entries(stats)
                .filter(([player]) => !player.includes("CORINGA"))
                .map(([player, data]) => {
                    const winPercentage = data.matches > 0 ? ((data.wins / data.matches) * 100).toFixed(1) : '0.0';
                    return { player, ...data, winPercentage };
                });
            
            statsArray.sort((a, b) => {
                if (b.wins !== a.wins) {
                    return b.wins - a.wins;
                }
                return a.losses - b.losses;
            });
            
            const teamStatsArray = Object.entries(teamStats).map(([teamKey, data]) => {
                const winPercentage = data.matches > 0 ? ((data.wins / data.matches) * 100).toFixed(1) : '0.0';
                return { teamKey, players: data.players, ...data, winPercentage };
            });
            
            teamStatsArray.sort((a, b) => {
                if (b.wins !== a.wins) {
                    return b.wins - a.wins;
                }
                return a.losses - b.losses;
            });
            
            const pointsArray = Object.entries(playerPoints)
                .filter(([player]) => !player.includes("CORINGA"))
                .map(([player, points]) => {
                    return { player, points };
                });
            
            pointsArray.sort((a, b) => b.points - a.points);
            
            let content = `PETECANDO 2025 - RELATÓRIO COMPLETO DO TORNEIO\n`;
            content += `Data: ${currentDate}\n`;
            content += `Total de partidas: ${currentMatch}\n`;
            content += `Jogadores participantes: ${players.filter(p => !p.includes("CORINGA")).length}\n`;
            content += `CORINGAs: ${countCoringas()}\n`;
            content += `Jogadores ativos: ${players.filter(p => !p.includes("CORINGA")).length - removedPlayers.filter(p => !p.includes("CORINGA")).length}\n`;
            content += `Jogadores que saíram: ${removedPlayers.filter(p => !p.includes("CORINGA")).length}\n\n`;
            
            content += `==========================================\n`;
            content += `ESTATÍSTICAS INDIVIDUAIS\n`;
            content += `==========================================\n\n`;
            
            statsArray.forEach(({ player, matches, wins, losses, winPercentage }, index) => {
                const isRemoved = removedPlayers.includes(player);
                const status = isRemoved ? " (SAIU)" : "";
                const consecutive = consecutiveWins[player] > 0 ? ` | Vitórias consecutivas: ${consecutiveWins[player]}` : "";
                
                content += `${(index + 1).toString().padStart(2, '0')}º - ${player}${status}\n`;
                content += `   Partidas: ${matches} | Vitórias: ${wins} | Derrotas: ${losses} | % Vitórias: ${winPercentage}%${consecutive}\n\n`;
            });
            
            content += `==========================================\n`;
            content += `ESTATÍSTICAS DE PONTOS\n`;
            content += `==========================================\n\n`;
            
            pointsArray.forEach(({ player, points }, index) => {
                content += `${(index + 1).toString().padStart(2, '0')}º - ${player}\n`;
                content += `   Pontos: ${points}\n\n`;
            });
            
            content += `==========================================\n`;
            content += `RELATÓRIO DE CONFRONTOS\n`;
            content += `==========================================\n\n`;
            
            confrontosHistory.forEach((confronto, index) => {
                content += `Partida ${confronto.match}:\n`;
                content += `   ${confronto.team1.join(' + ')} vs ${confronto.team2.join(' + ')}\n`;
                content += `   Placar: ${confronto.score} - Vencedor: Dupla ${confronto.winner}\n`;
                
                if (confronto.points) {
                    content += `   Pontos individuais:\n`;
                    confronto.team1.forEach(player => {
                        content += `      ${player}: ${confronto.points[player] || 0}\n`;
                    });
                    confronto.team2.forEach(player => {
                        content += `      ${player}: ${confronto.points[player] || 0}\n`;
                    });
                }
                content += `\n`;
            });
            
            content += `==========================================\n`;
            content += `RELATÓRIO DE GASTOS\n`;
            content += `==========================================\n\n`;
            
            if (purchases.length > 0) {
                const playerTotals = {};
                const playerItems = {};
                
                purchases.forEach(purchase => {
                    purchase.players.forEach(player => {
                        if (!playerTotals[player]) {
                            playerTotals[player] = 0;
                            playerItems[player] = {};
                        }
                        
                        playerTotals[player] += purchase.price;
                        
                        if (!playerItems[player][purchase.item]) {
                            playerItems[player][purchase.item] = {
                                count: 0,
                                price: purchase.price
                            };
                        }
                        playerItems[player][purchase.item].count++;
                    });
                });
                
                const sortedPlayers = Object.entries(playerTotals)
                    .sort((a, b) => b[1] - a[1])
                    .map(([player, total]) => ({ player, total, items: playerItems[player] }));
                
                sortedPlayers.forEach(({ player, total, items }, index) => {
                    content += `${(index + 1).toString().padStart(2, '0')}º - ${player}: R$ ${total.toFixed(2)}\n`;
                    
                    Object.keys(items).forEach(itemName => {
                        const itemInfo = items[itemName];
                        content += `   ${itemName} (${itemInfo.count}x): R$ ${(itemInfo.price * itemInfo.count).toFixed(2)}\n`;
                    });
                    content += `\n`;
                });
                
                const grandTotal = sortedPlayers.reduce((sum, { total }) => sum + total, 0);
                content += `TOTAL GERAL: R$ ${grandTotal.toFixed(2)}\n`;
            } else {
                content += `Nenhuma compra registrada.\n`;
            }
            
            content += `\n==========================================\n`;
            content += `JOGADORES QUE SAÍRAM DO TORNEIO\n`;
            content += `==========================================\n\n`;
            
            if (removedPlayers.length > 0) {
                removedPlayers.forEach((player, index) => {
                    content += `${(index + 1).toString().padStart(2, '0')} - ${player}\n`;
                });
            } else {
                content += `Nenhum jogador saiu do torneio.\n`;
            }
            
            content += `\n==========================================\n`;
            content += `HISTÓRICO DE PARTIDAS\n`;
            content += `==========================================\n\n`;
            
            content += `Total de partidas jogadas: ${currentMatch}\n\n`;
            
            content += `\n==========================================\n`;
            content += `RELATÓRIO GERADO EM: ${new Date().toLocaleString('pt-BR')}\n`;
            content += `APP BY HUGO RIBEIRO\n`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `petecando-2025-relatorio-${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(link);
            link.click();
            
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        // Mostrar diálogo de senha
        function showPasswordDialog(action) {
            currentAction = action;
            
            if (action === 'reset') {
                dialogTitle.textContent = 'Reiniciar Torneio';
                dialogMessage.textContent = 'Digite a senha para reiniciar:';
            } else if (action === 'forward') {
                dialogTitle.textContent = 'Avançar Partida';
                dialogMessage.textContent = 'Digite a senha para avançar:';
            } else if (action === 'swap') {
                const player1 = swapPlayer1Select.value;
                const player2 = swapPlayer2Select.value;
                
                if (!player1 || !player2) {
                    alert('Selecione dois jogadores para trocar.');
                    return;
                }
                
                dialogTitle.textContent = 'Trocar Jogadores';
                dialogMessage.textContent = `Digite a senha para trocar ${player1} com ${player2}:`;
            }
            
            passwordDialog.style.display = 'block';
            overlay.style.display = 'block';
            passwordInput.value = '';
            passwordInput.focus();
        }
        
        // Esconder diálogo de senha
        function hidePasswordDialog() {
            passwordDialog.style.display = 'none';
            overlay.style.display = 'none';
            currentAction = '';
        }
        
        // Verificar senha
        function checkPassword() {
            if (passwordInput.value === 'peteca') {
                if (currentAction === 'reset') {
                    resetTournament();
                } else if (currentAction === 'forward') {
                    redoAction();
                } else if (currentAction === 'swap') {
                    const player1 = swapPlayer1Select.value;
                    const player2 = swapPlayer2Select.value;
                    swapPlayers(player1, player2);
                } else if (currentAction === 'remove') {
                    removePurchaseItem(currentPurchaseId, currentPurchasePlayer);
                } else if (currentAction === 'delete') {
                    removePurchaseItem(currentPurchaseId, currentPurchasePlayer);
                }
                hidePasswordDialog();
                currentPurchaseId = null;
                currentPurchasePlayer = null;
            } else {
                alert('Senha incorreta. Tente novamente.');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }
        
        // Reiniciar torneio
        function resetTournament() {
            players = [];
            currentPlayers = [];
            waitingPlayers = [];
            stats = {};
            teamStats = {};
            team1 = [];
            team2 = [];
            teamConsecutiveWins = { team1: 0, team2: 0 };
            exitOrder = [];
            currentMatch = 0;
            tournamentStarted = false;
            removedPlayers = [];
            tournamentTimeElapsed = 0;
            matchHistory = [];
            consecutiveWins = {};
            coringaUsedInSorteio = [];
            playerPoints = {};
            playerErrors = {};
            pointsHistory = [];
            currentMatchPoints = {};
            currentMatchErrors = {};
            teamScores = { team1: 0, team2: 0 };
            undoneActions = [];
            confrontosHistory = [];
            purchases = [];
            
            localStorage.removeItem('petecaTournament');
            localStorage.removeItem('tournamentTimeElapsed');
            
            playerNameInput.value = '';
            updatePlayersList();
            updateStartButton();
            updateDisplay();
            updateModernStats();
            updateConfrontosStats();
            updatePointsStats();
            updateSwapDropdowns();
            updateTournamentStatus();
            updateNavigationButtons();
            updatePurchasesList();
            updatePurchasesSummary();
            updatePurchasesSummaryResults();
            updatePurchasePlayersButtons();
            
            releaseWakeLock();
            
            consecutiveInfo.style.display = 'none';
        }
        
        // Solicitar wake lock para manter a tela ativa
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock ativado');
                    
                    document.addEventListener('visibilitychange', async () => {
                        if (document.visibilityState === 'visible' && tournamentStarted) {
                            wakeLock = await navigator.wakeLock.request('screen');
                        }
                    });
                }
            } catch (err) {
                console.error('Erro ao ativar Wake Lock:', err);
            }
        }
        
        // Liberar wake lock
        async function releaseWakeLock() {
            if (wakeLock !== null) {
                await wakeLock.release();
                wakeLock = null;
                console.log('Wake Lock liberado');
            }
        }
        
        // Gerenciar instalação do PWA
        function initPWA() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installButton.style.display = 'block';
            });
            
            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        console.log('Usuário aceitou a instalação');
                    }
                    deferredPrompt = null;
                    installButton.style.display = 'none';
                }
            });
            
            window.addEventListener('appinstalled', () => {
                console.log('PWA foi instalado');
                installButton.style.display = 'none';
                deferredPrompt = null;
            });
        }
        
        // SISTEMA DE COMPRAS - VERSÃO CORRIGIDA
        
        // Adicionar compra para um jogador específico
        function addPurchaseForPlayer(player) {
            const item = purchaseItemInput.value.trim();
            const price = parseFloat(purchasePriceInput.value);
            
            if (!item || isNaN(price) || price <= 0) {
                alert('Por favor, preencha o nome do item e um preço válido.');
                return;
            }
            
            saveCurrentStateToHistory();
            
            const newPurchase = {
                id: Date.now(),
                item,
                price,
                players: [player]
            };
            
            purchases.push(newPurchase);
            
            purchaseItemInput.value = '';
            purchasePriceInput.value = '';
            
            updatePurchasesList();
            updatePurchasesSummary();
            updatePurchasesSummaryResults();
            saveToLocalStorage();
        }
        
        // Atualizar lista de compras
        function updatePurchasesList() {
            purchasesList.innerHTML = '';
            
            if (purchases.length === 0) {
                purchasesList.innerHTML = '<p>Nenhum item de compra registrado.</p>';
                return;
            }
            
            // Agrupar compras por jogador para facilitar a visualização
            const purchasesByPlayer = {};
            
            purchases.forEach(purchase => {
                purchase.players.forEach(player => {
                    if (!purchasesByPlayer[player]) {
                        purchasesByPlayer[player] = [];
                    }
                    purchasesByPlayer[player].push(purchase);
                });
            });
            
            // Criar cards por jogador
            Object.keys(purchasesByPlayer).sort().forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'purchase-item-card';
                playerCard.style.marginBottom = '20px';
                
                const playerHeader = document.createElement('div');
                playerHeader.className = 'purchase-header';
                playerHeader.innerHTML = `<h3 style="margin: 0; color: #9c27b0;">${player}</h3>`;
                playerCard.appendChild(playerHeader);
                
                const itemsList = document.createElement('div');
                itemsList.className = 'purchase-items-list';
                
                purchasesByPlayer[player].forEach(purchase => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'purchase-item-row';
                    itemDiv.style.display = 'flex';
                    itemDiv.style.justifyContent = 'space-between';
                    itemDiv.style.alignItems = 'center';
                    itemDiv.style.padding = '8px';
                    itemDiv.style.borderBottom = '1px solid #eee';
                    
                    const itemInfo = document.createElement('div');
                    itemInfo.innerHTML = `
                        <strong>${purchase.item}</strong> - R$ ${purchase.price.toFixed(2)}
                    `;
                    
                    const itemActions = document.createElement('div');
                    itemActions.className = 'purchase-item-actions';
                    itemActions.style.display = 'flex';
                    itemActions.style.gap = '5px';
                    
                    // Botão para adicionar mais uma unidade do mesmo item
                    const addBtn = document.createElement('button');
                    addBtn.className = 'btn-point-small';
                    addBtn.innerHTML = '+1';
                    addBtn.title = 'Adicionar mais uma unidade';
                    addBtn.onclick = () => duplicatePurchaseItem(purchase.id, player);
                    
                    // Botão para remover uma unidade (com senha)
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn-error-small';
                    removeBtn.innerHTML = '-1';
                    removeBtn.title = 'Remover uma unidade';
                    removeBtn.onclick = () => showPasswordDialogForPurchase('remove', purchase.id, player);
                    
                    // Botão para remover completamente o item
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn-remove-purchase-small';
                    deleteBtn.innerHTML = '×';
                    deleteBtn.title = 'Remover item completamente';
                    deleteBtn.onclick = () => showPasswordDialogForPurchase('delete', purchase.id, player);
                    
                    itemActions.appendChild(addBtn);
                    itemActions.appendChild(removeBtn);
                    itemActions.appendChild(deleteBtn);
                    
                    itemDiv.appendChild(itemInfo);
                    itemDiv.appendChild(itemActions);
                    itemsList.appendChild(itemDiv);
                });
                
                playerCard.appendChild(itemsList);
                purchasesList.appendChild(playerCard);
            });
        }
        
        // Duplicar item de compra (adicionar +1 do mesmo item)
        function duplicatePurchaseItem(purchaseId, player) {
            saveCurrentStateToHistory();
            
            const originalPurchase = purchases.find(p => p.id === purchaseId);
            if (originalPurchase) {
                const newPurchase = {
                    id: Date.now(),
                    item: originalPurchase.item,
                    price: originalPurchase.price,
                    players: [player]
                };
                
                purchases.push(newPurchase);
                
                updatePurchasesList();
                updatePurchasesSummary();
                updatePurchasesSummaryResults();
                saveToLocalStorage();
            }
        }
        
        // Mostrar diálogo de senha para ações de compra
        function showPasswordDialogForPurchase(action, purchaseId, player) {
            currentAction = action;
            currentPurchaseId = purchaseId;
            currentPurchasePlayer = player;
            
            if (action === 'remove') {
                dialogTitle.textContent = 'Remover Item';
                dialogMessage.textContent = `Digite a senha para remover 1 unidade do item de ${player}:`;
            } else if (action === 'delete') {
                dialogTitle.textContent = 'Remover Item Completamente';
                dialogMessage.textContent = `Digite a senha para remover completamente o item de ${player}:`;
            }
            
            passwordDialog.style.display = 'block';
            overlay.style.display = 'block';
            passwordInput.value = '';
            passwordInput.focus();
        }
        
        // Remover item de compra (após confirmação de senha)
        function removePurchaseItem(purchaseId, player) {
            const purchaseIndex = purchases.findIndex(p => p.id === purchaseId && p.players.includes(player));
            
            if (purchaseIndex !== -1) {
                purchases.splice(purchaseIndex, 1);
                
                updatePurchasesList();
                updatePurchasesSummary();
                updatePurchasesSummaryResults();
                saveToLocalStorage();
            }
        }
        
        // Atualizar resumo de compras
        function updatePurchasesSummary() {
            purchasesSummary.innerHTML = '';
            
            if (purchases.length === 0) {
                purchasesSummary.innerHTML = '<p>Nenhuma compra registrada.</p>';
                return;
            }
            
            const playerTotals = {};
            const playerItems = {};
            
            purchases.forEach(purchase => {
                purchase.players.forEach(player => {
                    if (!playerTotals[player]) {
                        playerTotals[player] = 0;
                        playerItems[player] = {};
                    }
                    
                    playerTotals[player] += purchase.price;
                    
                    if (!playerItems[player][purchase.item]) {
                        playerItems[player][purchase.item] = {
                            count: 0,
                            price: purchase.price
                        };
                    }
                    playerItems[player][purchase.item].count++;
                });
            });
            
            const sortedPlayers = Object.entries(playerTotals)
                .sort((a, b) => b[1] - a[1])
                .map(([player, total]) => ({ player, total, items: playerItems[player] }));
            
            sortedPlayers.forEach(({ player, total, items }) => {
                const playerSection = document.createElement('div');
                playerSection.className = 'player-purchase-section';
                playerSection.style.marginBottom = '15px';
                playerSection.style.padding = '10px';
                playerSection.style.background = 'white';
                playerSection.style.borderRadius = '5px';
                
                const playerHeader = document.createElement('div');
                playerHeader.style.display = 'flex';
                playerHeader.style.justifyContent = 'space-between';
                playerHeader.style.marginBottom = '8px';
                playerHeader.style.fontWeight = 'bold';
                
                playerHeader.innerHTML = `
                    <span>${player}</span>
                    <span class="total-amount">R$ ${total.toFixed(2)}</span>
                `;
                
                playerSection.appendChild(playerHeader);
                
                const itemsList = document.createElement('div');
                itemsList.style.fontSize = '0.9rem';
                itemsList.style.color = '#666';
                
                Object.keys(items).forEach(itemName => {
                    const itemInfo = items[itemName];
                    const itemDiv = document.createElement('div');
                    itemDiv.style.display = 'flex';
                    itemDiv.style.justifyContent = 'space-between';
                    itemDiv.style.marginBottom = '2px';
                    
                    itemDiv.innerHTML = `
                        <span>${itemName} (${itemInfo.count}x)</span>
                        <span>R$ ${(itemInfo.price * itemInfo.count).toFixed(2)}</span>
                    `;
                    
                    itemsList.appendChild(itemDiv);
                });
                
                playerSection.appendChild(itemsList);
                purchasesSummary.appendChild(playerSection);
            });
            
            const grandTotal = sortedPlayers.reduce((sum, { total }) => sum + total, 0);
            
            const grandTotalElement = document.createElement('div');
            grandTotalElement.className = 'grand-total';
            grandTotalElement.innerHTML = `
                <span>TOTAL GERAL</span>
                <span>R$ ${grandTotal.toFixed(2)}</span>
            `;
            purchasesSummary.appendChild(grandTotalElement);
        }
        
        // Atualizar resumo de compras para a aba de resultados
        function updatePurchasesSummaryResults() {
            purchasesSummaryResults.innerHTML = '';
            
            if (purchases.length === 0) {
                purchasesSummaryResults.innerHTML = '<p>Nenhuma compra registrada.</p>';
                return;
            }
            
            const playerTotals = {};
            const playerItems = {};
            
            purchases.forEach(purchase => {
                purchase.players.forEach(player => {
                    if (!playerTotals[player]) {
                        playerTotals[player] = 0;
                        playerItems[player] = {};
                    }
                    
                    playerTotals[player] += purchase.price;
                    
                    if (!playerItems[player][purchase.item]) {
                        playerItems[player][purchase.item] = {
                            count: 0,
                            price: purchase.price
                        };
                    }
                    playerItems[player][purchase.item].count++;
                });
            });
            
            const sortedPlayers = Object.entries(playerTotals)
                .sort((a, b) => b[1] - a[1])
                .map(([player, total]) => ({ player, total, items: playerItems[player] }));
            
            const table = document.createElement('table');
            table.className = 'stats-table';
            
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Jogador</th>
                    <th>Itens</th>
                    <th>Total</th>
                </tr>
            `;
            table.appendChild(thead);
            
            const tbody = document.createElement('tbody');
            sortedPlayers.forEach(({ player, total, items }) => {
                const row = document.createElement('tr');
                
                const itemsList = Object.keys(items).map(itemName => {
                    const itemInfo = items[itemName];
                    return `${itemName} (${itemInfo.count}x)`;
                }).join(', ');
                
                row.innerHTML = `
                    <td>${player}</td>
                    <td style="font-size: 0.8rem;">${itemsList}</td>
                    <td>R$ ${total.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
            
            const grandTotal = sortedPlayers.reduce((sum, { total }) => sum + total, 0);
            
            const grandTotalRow = document.createElement('tr');
            grandTotalRow.style.fontWeight = 'bold';
            grandTotalRow.style.background = '#f8f9fa';
            grandTotalRow.innerHTML = `
                <td colspan="2">TOTAL GERAL</td>
                <td>R$ ${grandTotal.toFixed(2)}</td>
            `;
            tbody.appendChild(grandTotalRow);
            
            table.appendChild(tbody);
            purchasesSummaryResults.appendChild(table);
            
            const pixInfo = document.createElement('div');
            pixInfo.className = 'pix-info';
            pixInfo.innerHTML = `
                <h3>Pagamento via PIX</h3>
                <p>Envie o valor total para:</p>
                <div class="pix-email">peteca.pix@gmail.com</div>
                <p class="confraternizacao-text">Verba arrecadada para confraternizações</p>
            `;
            purchasesSummaryResults.appendChild(pixInfo);
        }
        
        // Compartilhar relatório de gastos
        function sharePurchasesResults() {
            const currentDate = new Date().toLocaleDateString('pt-BR');
            
            if (purchases.length === 0) {
                alert('Nenhuma compra registrada para compartilhar.');
                return;
            }
            
            const playerTotals = {};
            const playerItems = {};
            
            purchases.forEach(purchase => {
                purchase.players.forEach(player => {
                    if (!playerTotals[player]) {
                        playerTotals[player] = 0;
                        playerItems[player] = {};
                    }
                    
                    playerTotals[player] += purchase.price;
                    
                    if (!playerItems[player][purchase.item]) {
                        playerItems[player][purchase.item] = {
                            count: 0,
                            price: purchase.price
                        };
                    }
                    playerItems[player][purchase.item].count++;
                });
            });
            
            const sortedPlayers = Object.entries(playerTotals)
                .sort((a, b) => b[1] - a[1])
                .map(([player, total]) => ({ player, total, items: playerItems[player] }));
            
            const grandTotal = sortedPlayers.reduce((sum, { total }) => sum + total, 0);
            
            let content = `*RELATÓRIO DE GASTOS* \n\n`;
            content += `Data: ${currentDate}\n\n`;
            content += `*RESUMO POR JOGADOR:*\n\n`;
            
            sortedPlayers.forEach(({ player, total, items }, index) => {
                content += `${(index + 1).toString().padStart(2, '0')}º - *${player}*: R$ ${total.toFixed(2)}\n`;
                
                Object.keys(items).forEach(itemName => {
                    const itemInfo = items[itemName];
                    content += `    ${itemName} (${itemInfo.count}x): R$ ${(itemInfo.price * itemInfo.count).toFixed(2)}\n`;
                });
                content += `\n`;
            });
            
            content += ` *TOTAL GERAL: R$ ${grandTotal.toFixed(2)}*\n\n`;
            content += `📱 *PAGAMENTO VIA PIX:*\n`;
            content += ` Chave PIX: peteca.pix@gmail.com\n\n`;
            content += `_Verba arrecadada para confraternizações_\n\n`;
            
            content += `👨‍💻 App by Hugo Ribeiro`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Petecando 2025 - Relatório de Gastos',
                    text: content
                }).catch(error => {
                    console.log('Erro ao compartilhar:', error);
                    copyToClipboard(content);
                });
            } else {
                copyToClipboard(content);
            }
        }
        
        // Salvar estado atual no histórico
        function saveCurrentStateToHistory() {
            matchHistory.push({
                players: [...players],
                currentPlayers: [...currentPlayers],
                waitingPlayers: [...waitingPlayers],
                stats: JSON.parse(JSON.stringify(stats)),
                teamStats: JSON.parse(JSON.stringify(teamStats)),
                team1: [...team1],
                team2: [...team2],
                teamConsecutiveWins: {...teamConsecutiveWins},
                exitOrder: [...exitOrder],
                currentMatch: currentMatch,
                tournamentTimeElapsed: tournamentTimeElapsed,
                consecutiveWins: {...consecutiveWins},
                coringaUsedInSorteio: [...coringaUsedInSorteio],
                playerPoints: JSON.parse(JSON.stringify(playerPoints)),
                playerErrors: JSON.parse(JSON.stringify(playerErrors)),
                pointsHistory: [...pointsHistory],
                currentMatchPoints: JSON.parse(JSON.stringify(currentMatchPoints)),
                currentMatchErrors: JSON.parse(JSON.stringify(currentMatchErrors)),
                teamScores: {...teamScores},
                confrontosHistory: [...confrontosHistory],
                purchases: JSON.parse(JSON.stringify(purchases))
            });
            
            undoneActions = [];
            updateNavigationButtons();
        }
        
        // Atualizar dropdowns de troca de jogadores
        function updateSwapDropdowns() {
            swapPlayer1Select.innerHTML = '<option value="">Selecione o primeiro jogador</option>';
            swapPlayer2Select.innerHTML = '<option value="">Selecione o segundo jogador</option>';
            
            players.forEach(player => {
                if (!removedPlayers.includes(player)) {
                    const option1 = document.createElement('option');
                    option1.value = player;
                    option1.textContent = player;
                    
                    const option2 = document.createElement('option');
                    option2.value = player;
                    option2.textContent = player;
                    
                    swapPlayer1Select.appendChild(option1);
                    swapPlayer2Select.appendChild(option2);
                }
            });
        }
        
        // Trocar jogadores de posição
        function swapPlayers(player1, player2) {
            if (player1 === player2) {
                alert("Selecione jogadores diferentes para trocar.");
                return;
            }
            
            saveCurrentStateToHistory();
            
            const swapInArray = (arr, a, b) => {
                const indexA = arr.indexOf(a);
                const indexB = arr.indexOf(b);
                
                if (indexA !== -1 && indexB !== -1) {
                    arr[indexA] = b;
                    arr[indexB] = a;
                } else if (indexA !== -1) {
                    arr[indexA] = b;
                } else if (indexB !== -1) {
                    arr[indexB] = a;
                }
            };
            
            swapInArray(players, player1, player2);
            swapInArray(currentPlayers, player1, player2);
            swapInArray(waitingPlayers, player1, player2);
            swapInArray(exitOrder, player1, player2);
            swapInArray(team1, player1, player2);
            swapInArray(team2, player1, player2);
            
            updatePlayersList();
            updateDisplay();
            updateModernStats();
            updateConfrontosStats();
            updateSwapDropdowns();
            updatePurchasePlayersButtons();
            saveToLocalStorage();
            
            alert(`Jogadores ${player1} e ${player2} trocados com sucesso!`);
        }
        
        // Atualizar status do torneio
        function updateTournamentStatus() {
            if (tournamentStarted) {
                tournamentStatus.textContent = `Torneio em andamento - Partida ${currentMatch}`;
                tournamentStatus.className = 'tournament-status status-playing';
                tournamentStatus.style.display = 'block';
            } else {
                tournamentStatus.textContent = 'Torneio não iniciado';
                tournamentStatus.className = 'tournament-status status-waiting';
                tournamentStatus.style.display = 'none';
                clearInterval(tournamentTimer);
            }
            
            currentMatchTitle.textContent = `Partida - ${currentMatch}`;
        }
        
        // Atualizar botões de navegação
        function updateNavigationButtons() {
            backButton.style.display = matchHistory.length > 0 ? 'block' : 'none';
            forwardButton.style.display = undoneActions.length > 0 ? 'block' : 'none';
        }
        
        // Alternar instruções
        function toggleInstructions() {
            instructionsContent.style.display = instructionsContent.style.display === 'block' ? 'none' : 'block';
            toggleIcon.classList.toggle('rotated');
        }
        
        // Permitir adicionar jogadores pressionando Enter
        playerNameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addPlayer();
            }
        });
        
        // Permitir adicionar compras pressionando Enter no campo de preço
        purchasePriceInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (purchaseItemInput.value.trim() && purchasePriceInput.value) {
                    // Se houver um jogador selecionado, adicionar para ele
                    const selectedPlayerBtn = document.querySelector('.player-purchase-btn.selected');
                    if (selectedPlayerBtn) {
                        addPurchaseForPlayer(selectedPlayerBtn.textContent);
                    } else {
                        alert('Selecione um jogador clicando no botão com o nome dele.');
                    }
                }
            }
        });
        
        // Inicializar a exibição e carregar dados salvos
        window.onload = function() {
            loadFromLocalStorage();
            updateDisplay();
            updateModernStats();
            updateConfrontosStats();
            updatePointsStats();
            updateTournamentStatus();
            updateSwapDropdowns();
            updateNavigationButtons();
            updatePurchasesList();
            updatePurchasesSummary();
            updatePurchasesSummaryResults();
            updatePurchasePlayersButtons();
            initTabs();
            initPWA();
            
            if (tournamentStarted) {
                requestWakeLock();
            }
        };
    </script>

    <script>
        // Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>